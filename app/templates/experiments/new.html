{% extends "base.html" %}

{% block title %}New Experiment - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Create New Experiment</h3>
                </div>
                <div class="card-body">
                    <form id="new-experiment-form">
                        {# Basic Information #}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="experiment-name" class="form-label">Experiment Name *</label>
                                    <input type="text" class="form-control" id="experiment-name"
                                           value="{% if mode == 'single_document' and document_title %}{{ document_title }}{% endif %}"
                                           placeholder="Enter experiment name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="experiment-type" class="form-label">Experiment Type *</label>
                                    <select class="form-select" id="experiment-type" required>
                                        <option value="single_document_analysis" {% if mode == 'single_document' %}selected{% endif %}>Single Document Analysis</option>
                                        <option value="document_analysis">Multi-Document Analysis</option>
                                        <option value="temporal_evolution" {% if mode != 'single_document' %}selected{% endif %}>Temporal Evolution</option>
                                        <option value="domain_comparison">Domain Comparison</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="experiment-description" class="form-label">Description</label>
                            <textarea class="form-control" id="experiment-description" rows="3"
                                      placeholder="Describe the purpose of this experiment..."></textarea>
                        </div>

                        {# Document Selection #}
                        <div class="mb-4">
                            <label class="form-label">Select Content for Analysis *</label>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <span id="type-description">Select source documents for your experiment.</span>
                            </div>

                            <div class="row">
                                {# Source Documents #}
                                <div class="col-md-6">
                                    <h6><i class="fas fa-file-text text-primary"></i> Source Documents</h6>
                                    <small class="text-muted mb-3 d-block">Primary documents to analyze</small>

                                    {% if documents %}
                                        <div id="document-selection-area">
                                            {% if mode == 'single_document' %}
                                                {% include 'experiments/components/single_document_selection.html' %}
                                            {% else %}
                                                {% include 'experiments/components/multi_document_selection.html' %}
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            No documents available. <a href="{{ url_for('text_input.upload_form') }}">Upload documents</a> first.
                                        </div>
                                    {% endif %}
                                </div>

                                {# References #}
                                <div class="col-md-6">
                                    <h6><i class="fas fa-book text-success"></i> References</h6>
                                    <small class="text-muted mb-3 d-block">Dictionary entries, papers, standards</small>

                                    {% if references %}
                                    <div class="reference-list border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                        {% for reference in references %}
                                        <div class="form-check reference-item mb-2">
                                            <input class="form-check-input reference-checkbox" type="checkbox"
                                                   value="{{ reference.id }}" id="ref-{{ reference.id }}">
                                            <label class="form-check-label" for="ref-{{ reference.id }}">
                                                <strong>{{ reference.get_display_name() }}</strong>
                                                <span class="text-muted">({{ reference.word_count or 0 }} words)</span>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        No references available.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        {# Additional Configuration (shown based on experiment type) #}
                        <div id="configuration-options" style="display: none;">
                            {# Temporal Evolution Config #}
                            <div id="temporal-config" style="display: none;">
                                <h5>Temporal Evolution Settings</h5>
                                <div class="mb-3">
                                    <label for="focus-term" class="form-label">Focus Term</label>
                                    <select class="form-select" id="focus-term">
                                        <option value="">Select a term...</option>
                                        {% for term in terms %}
                                        <option value="{{ term.id }}">{{ term.term_text }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            {# Domain Comparison Config #}
                            <div id="domain-config" style="display: none;">
                                <h5>Domain Comparison Settings</h5>
                                <div class="mb-3">
                                    <label for="domain-focus" class="form-label">Target Domains</label>
                                    <input type="text" class="form-control" id="domain-focus"
                                           placeholder="e.g., Philosophy, Computer Science, Law">
                                </div>
                            </div>
                        </div>

                        {# Submit Buttons #}
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% if mode == 'single_document' and document_uuid %}/input/document/{{ document_uuid }}{% else %}{{ url_for('experiments.index') }}{% endif %}"
                               class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Experiment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('new-experiment-form');
    const typeSelect = document.getElementById('experiment-type');
    const configOptions = document.getElementById('configuration-options');
    const temporalConfig = document.getElementById('temporal-config');
    const domainConfig = document.getElementById('domain-config');
    const typeDescription = document.getElementById('type-description');

    // Update UI based on experiment type selection
    typeSelect.addEventListener('change', function() {
        const type = this.value;

        // Hide all config sections
        if (configOptions) configOptions.style.display = 'none';
        if (temporalConfig) temporalConfig.style.display = 'none';
        if (domainConfig) domainConfig.style.display = 'none';

        // Update description and show relevant config
        if (type === 'single_document_analysis') {
            typeDescription.textContent = 'Process one document through embeddings, segmentation, and entity extraction pipelines.';
        } else if (type === 'document_analysis') {
            typeDescription.textContent = 'Select one or more documents to process through embeddings, segmentation, and entity extraction pipelines.';
        } else if (type === 'temporal_evolution') {
            typeDescription.textContent = 'Track how a term evolves across time and disciplines.';
            if (configOptions) configOptions.style.display = 'block';
            if (temporalConfig) temporalConfig.style.display = 'block';
        } else if (type === 'domain_comparison') {
            typeDescription.textContent = 'Compare terminology and concepts across different domains.';
            if (configOptions) configOptions.style.display = 'block';
            if (domainConfig) domainConfig.style.display = 'block';
        }
    });

    // Initialize on page load
    typeSelect.dispatchEvent(new Event('change'));

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const name = document.getElementById('experiment-name').value.trim();
        const type = typeSelect.value;
        const description = document.getElementById('experiment-description').value.trim();

        // Collect selected documents
        const documentIds = [];
        document.querySelectorAll('.document-checkbox:checked').forEach(cb => {
            documentIds.push(parseInt(cb.value));
        });
        // Also check for hidden inputs from single-document mode
        document.querySelectorAll('input[name="document_ids[]"]').forEach(input => {
            const id = parseInt(input.value);
            if (!documentIds.includes(id)) {
                documentIds.push(id);
            }
        });

        // Collect selected references
        const referenceIds = [];
        document.querySelectorAll('.reference-checkbox:checked').forEach(cb => {
            referenceIds.push(parseInt(cb.value));
        });

        if (!name) {
            alert('Please enter an experiment name');
            return;
        }

        if (documentIds.length === 0 && referenceIds.length === 0) {
            alert('Please select at least one document or reference');
            return;
        }

        // Build configuration
        const configuration = {};
        if (type === 'temporal_evolution') {
            const termId = document.getElementById('focus-term')?.value;
            if (termId) configuration.focus_term_id = termId;
        } else if (type === 'domain_comparison') {
            const domains = document.getElementById('domain-focus')?.value;
            if (domains) configuration.domain_focus = domains;
        }

        try {
            const response = await fetch('/experiments/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    description: description,
                    experiment_type: type,
                    document_ids: documentIds,
                    reference_ids: referenceIds,
                    configuration: configuration
                })
            });

            const data = await response.json();
            if (data.success) {
                window.location.href = data.redirect || `/experiments/${data.experiment_id}`;
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error creating experiment: ' + error.message);
        }
    });
});
</script>
{% endblock %}
