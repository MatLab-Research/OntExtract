{% extends "base.html" %}

{% block title %}New Experiment - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Create New Experiment</h3>
                </div>
                <div class="card-body">
                    <form id="new-experiment-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="experiment-name" class="form-label">Experiment Name *</label>
                                    <input type="text" class="form-control" id="experiment-name" 
                                           placeholder="Enter experiment name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="experiment-type" class="form-label">Experiment Type *</label>
                                    <select class="form-select" id="experiment-type" required>
                                        <option value="">Select type...</option>
                                        <option value="document_analysis">Document Analysis</option>
                                        <!-- <option value="temporal_evolution">Temporal Evolution</option> -->
                                        <!-- Temporal Evolution archived - needs refactoring of document/reference distinction -->
                                        <option value="domain_comparison">Domain Comparison</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="experiment-description" class="form-label">Description</label>
                            <textarea class="form-control" id="experiment-description" rows="3" 
                                      placeholder="Describe the purpose of this experiment..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">Select Content for Analysis *</label>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 
                                Select source documents and/or references to include in this experiment.
                                <span id="type-description"></span>
                            </div>
                            
                            <div class="row">
                                <!-- Source Documents -->
                                <div class="col-md-6">
                                    <h6><i class="fas fa-file-text text-primary"></i> Source Documents</h6>
                                    <small class="text-muted mb-3 d-block">Primary documents to analyze</small>
                                    
                                    {% if documents %}
                                    <div class="document-selection">
                                        <input type="text" class="form-control mb-3" id="document-search" 
                                               placeholder="ðŸ” Filter documents by name or content...">
                                        <small class="text-muted d-block mb-2"><i class="fas fa-info-circle"></i> Type to filter the list of documents below</small>
                                        
                                        <div class="document-list border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                            {% for document in documents %}
                                            <div class="form-check document-item mb-2">
                                                <input class="form-check-input document-checkbox" type="checkbox" 
                                                       value="{{ document.id }}" id="doc-{{ document.id }}"
                                                       data-title="{{ document.get_display_name() }}"
                                                       data-words="{{ document.word_count or 0 }}">
                                                <label class="form-check-label" for="doc-{{ document.id }}">
                                                    {% set filename = document.get_display_name().lower() %}
                                                    {% if filename.endswith('.pdf') %}
                                                        <i class="fas fa-file-pdf text-danger me-2" title="PDF Document"></i>
                                                    {% elif filename.endswith('.txt') %}
                                                        <i class="fas fa-file-alt text-secondary me-2" title="Text Document"></i>
                                                    {% elif filename.endswith('.md') %}
                                                        <i class="fas fa-file-code text-info me-2" title="Markdown Document"></i>
                                                    {% elif filename.endswith('.docx') or filename.endswith('.doc') %}
                                                        <i class="fas fa-file-word text-primary me-2" title="Word Document"></i>
                                                    {% elif filename.endswith('.html') %}
                                                        <i class="fas fa-code text-warning me-2" title="HTML Document"></i>
                                                    {% else %}
                                                        <i class="fas fa-file text-secondary me-2" title="Document"></i>
                                                    {% endif %}
                                                    <strong>{{ document.get_display_name() }}</strong>
                                                    <span class="text-muted">
                                                        ({{ document.word_count or 0 }} words)
                                                    </span>
                                                    {% if document.created_at %}
                                                    <small class="text-muted d-block">
                                                        Uploaded: {{ document.created_at.strftime('%Y-%m-%d %H:%M') }}
                                                    </small>
                                                    {% endif %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        No source documents available. Please 
                                        <a href="{{ url_for('text_input.upload_form') }}">upload some documents</a> first.
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- References -->
                                <div class="col-md-6">
                                    <h6><i class="fas fa-book text-success"></i> References</h6>
                                    <small class="text-muted mb-3 d-block">Dictionary entries, papers, standards</small>
                                    
                                    {% if references %}
                                    <div class="reference-selection">
                                        <input type="text" class="form-control mb-3" id="reference-search" 
                                               placeholder="ðŸ” Filter references by title, author, or type...">
                                        <small class="text-muted d-block mb-2"><i class="fas fa-info-circle"></i> Type to filter the list of references below</small>
                                        
                                        <div class="reference-list border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                            {% for reference in references %}
                                            <div class="form-check reference-item mb-2">
                                                <input class="form-check-input reference-checkbox" type="checkbox" 
                                                       value="{{ reference.id }}" id="ref-{{ reference.id }}"
                                                       data-title="{{ reference.get_display_name() }}"
                                                       data-words="{{ reference.word_count or 0 }}">
                                                <label class="form-check-label" for="ref-{{ reference.id }}">
                                                    {% if reference.reference_type == 'oed_entry' or (reference.reference_subtype and 'oed' in reference.reference_subtype.lower()) %}
                                                        <i class="fas fa-external-link-alt text-info me-2" title="OED Entry (External)"></i>
                                                    {% elif (reference.original_filename and reference.original_filename.lower().endswith('.pdf')) or reference.file_type == 'pdf' %}
                                                        <i class="fas fa-file-pdf text-danger me-2" title="PDF Reference"></i>
                                                    {% elif reference.reference_type == 'paper' %}
                                                        <i class="fas fa-graduation-cap text-success me-2" title="Academic Paper"></i>
                                                    {% elif reference.reference_type == 'standard' %}
                                                        <i class="fas fa-certificate text-warning me-2" title="Standard Document"></i>
                                                    {% elif reference.reference_type == 'book' %}
                                                        <i class="fas fa-book text-primary me-2" title="Book"></i>
                                                    {% else %}
                                                        <i class="fas fa-bookmark text-secondary me-2" title="Reference"></i>
                                                    {% endif %}
                                                    <strong>{{ reference.get_display_name() }}</strong>
                                                    {% if reference.reference_subtype %}
                                                    <small class="badge bg-secondary badge-sm">{{ reference.get_reference_subtype_display() }}</small>
                                                    {% endif %}
                                                    <span class="text-muted">
                                                        ({{ reference.word_count or 0 }} words)
                                                    </span>
                                                    {% if reference.get_source_info() %}
                                                    <small class="text-muted d-block">
                                                        {{ reference.get_source_info() }}
                                                    </small>
                                                    {% endif %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> 
                                        No references available. You can add references from the 
                                        <a href="{{ url_for('references.index') }}">references section</a>.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="select-all-docs">
                                        Select All Documents
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-docs">
                                        Deselect All Documents
                                    </button>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-success" id="select-all-refs">
                                        Select All References
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-refs">
                                        Deselect All References
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <strong>Selected: </strong>
                                <span id="selected-count">0</span> items
                                (<span id="total-words">0</span> total words)
                                <small class="text-muted ms-3">
                                    <span id="doc-count">0</span> documents, <span id="ref-count">0</span> references
                                </small>
                            </div>
                        </div>
                        
                        <!-- Configuration options based on experiment type -->
                        <div id="configuration-options" class="mb-4" style="display: none;">
                            <h5>Configuration Options</h5>
                            <div id="temporal-config" style="display: none;">
                                <!-- Period Generation Method Selection -->
                                <div class="mb-4">
                                    <label class="form-label d-block">Time Period Generation Method</label>
                                    <div class="btn-group" role="group" aria-label="Period generation method">
                                        <input type="radio" class="btn-check" name="period-method" id="manual-periods" value="manual" checked>
                                        <label class="btn btn-outline-primary" for="manual-periods">
                                            <i class="fas fa-calendar"></i> Manual Time Periods
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="period-method" id="oed-periods" value="oed">
                                        <label class="btn btn-outline-primary" for="oed-periods">
                                            <i class="fas fa-book"></i> Generate from OED Data
                                        </label>
                                    </div>
                                    <small class="text-muted d-block mt-2" id="period-method-description">
                                        <i class="fas fa-info-circle"></i> Manually specify the time range and interval for analysis.
                                    </small>
                                </div>
                                
                                <!-- Manual Period Configuration -->
                                <div id="manual-period-config">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="start-year" class="form-label">Start Year</label>
                                                <input type="number" class="form-control" id="start-year" 
                                                       placeholder="e.g., 1990" min="1800" max="2030" value="2000">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="end-year" class="form-label">End Year</label>
                                                <input type="number" class="form-control" id="end-year" 
                                                       placeholder="e.g., 2020" min="1800" max="2030" value="2020">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="time-period" class="form-label">Period</label>
                                                <select class="form-select" id="time-period">
                                                    <option value="1">Every Year</option>
                                                    <option value="2">Every 2 Years</option>
                                                    <option value="5" selected>Every 5 Years</option>
                                                    <option value="10">Every 10 Years</option>
                                                    <option value="20">Every 20 Years</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- OED Period Configuration -->
                                <div id="oed-period-config" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="fas fa-magic"></i> <strong>Automatic Period Generation</strong>
                                        <p class="mb-1">Time periods will be automatically generated based on the historical range of your terms in the Oxford English Dictionary.</p>
                                        <small>The system will:</small>
                                        <ul class="small mb-0">
                                            <li>Query OED for each term's historical quotations</li>
                                            <li>Determine the overall date range across all terms</li>
                                            <li>Generate appropriate intervals based on the time span</li>
                                            <li>Show term-specific coverage for each period</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="temporal-terms" class="form-label">Terms to Track (comma-separated) *</label>
                                    <input type="text" class="form-control" id="temporal-terms" 
                                           placeholder="e.g., technology, artificial intelligence, computer, algorithm" required>
                                    <small class="text-muted">We'll track how these terms evolve over the specified time periods. At least one term is required.</small>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="track-entities" checked>
                                    <label class="form-check-label" for="track-entities">
                                        Track entity evolution and context changes
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="track-frequency" checked>
                                    <label class="form-check-label" for="track-frequency">
                                        Track term frequency over time
                                    </label>
                                </div>
                            </div>
                            
                            <div id="domain-config" style="display: none;">
                                <div class="mb-3">
                                    <label for="domain-focus" class="form-label">Domain Focus</label>
                                    <input type="text" class="form-control" id="domain-focus" 
                                           placeholder="e.g., Computer Science, Philosophy, Law, Medicine, Economics">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb"></i> Enter academic disciplines or professional domains to compare terminology across fields
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label for="target-terms" class="form-label">Target Terms (comma-separated)</label>
                                    <input type="text" class="form-control" id="target-terms" 
                                           placeholder="e.g., agent, ontology, algorithm">
                                    <small class="text-muted">We'll compare these terms across the domains you specified above.</small>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="extract-terminology">
                                    <label class="form-check-label" for="extract-terminology">
                                        Extract domain-specific terminology
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="compare-ontologies">
                                    <label class="form-check-label" for="compare-ontologies">
                                        Compare against existing ontologies
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="use-references" checked>
                                    <label class="form-check-label" for="use-references">
                                        Use linked references (ignore selected documents)
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('experiments.index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="create-btn">
                                <i class="fas fa-plus"></i> Create Experiment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('new-experiment-form');
    const typeSelect = document.getElementById('experiment-type');
    const configOptions = document.getElementById('configuration-options');
    const temporalConfig = document.getElementById('temporal-config');
    const domainConfig = document.getElementById('domain-config');
    const typeDescription = document.getElementById('type-description');
    const searchInput = document.getElementById('document-search');
    const selectedCount = document.getElementById('selected-count');
    const totalWords = document.getElementById('total-words');
    
    // Update configuration options based on experiment type
    typeSelect.addEventListener('change', function() {
        const type = this.value;

        // Get required fields for different experiment types
        const temporalTermsField = document.getElementById('temporal-terms');

        if (type) {
            configOptions.style.display = 'block';
            temporalConfig.style.display = 'none';
            domainConfig.style.display = 'none';

            // Remove required attributes from all conditional fields
            if (temporalTermsField) temporalTermsField.removeAttribute('required');

            if (type === 'document_analysis') {
                // Document analysis doesn't need extra config - just documents
                configOptions.style.display = 'none';
                typeDescription.textContent = 'For document analysis, select one or more documents to process through embeddings, segmentation, and entity extraction pipelines.';
            } else if (type === 'temporal_evolution') {
                temporalConfig.style.display = 'block';
                typeDescription.textContent = 'For temporal evolution, select documents from different time periods to analyze how concepts evolve over time.';
                // Add required attribute back for temporal terms
                if (temporalTermsField) temporalTermsField.setAttribute('required', '');
            } else if (type === 'domain_comparison') {
                domainConfig.style.display = 'block';
                typeDescription.textContent = 'For domain comparison, select documents from different domains to identify domain-specific terminology and concepts.';
            }
        } else {
            configOptions.style.display = 'none';
            typeDescription.textContent = '';
            // Remove required attributes when no type is selected
            if (temporalTermsField) temporalTermsField.removeAttribute('required');
        }
    });

    // Initialize form state on page load
    typeSelect.dispatchEvent(new Event('change'));

    // Document search
    const documentSearchInput = document.getElementById('document-search');
    if (documentSearchInput) {
        documentSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const documentItems = document.querySelectorAll('.document-item');
            
            documentItems.forEach(item => {
                const title = item.querySelector('.document-checkbox').dataset.title.toLowerCase();
                const label = item.querySelector('label').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || label.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Reference search
    const referenceSearchInput = document.getElementById('reference-search');
    if (referenceSearchInput) {
        referenceSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const referenceItems = document.querySelectorAll('.reference-item');
            
            referenceItems.forEach(item => {
                const title = item.querySelector('.reference-checkbox').dataset.title.toLowerCase();
                const label = item.querySelector('label').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || label.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Select/Deselect all documents
    document.getElementById('select-all-docs')?.addEventListener('click', function() {
        document.querySelectorAll('.document-checkbox').forEach(cb => {
            if (cb.closest('.document-item').style.display !== 'none') {
                cb.checked = true;
            }
        });
        updateSelectedCount();
    });
    
    document.getElementById('deselect-all-docs')?.addEventListener('click', function() {
        document.querySelectorAll('.document-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
    });
    
    // Select/Deselect all references
    document.getElementById('select-all-refs')?.addEventListener('click', function() {
        document.querySelectorAll('.reference-checkbox').forEach(cb => {
            if (cb.closest('.reference-item').style.display !== 'none') {
                cb.checked = true;
            }
        });
        updateSelectedCount();
    });
    
    document.getElementById('deselect-all-refs')?.addEventListener('click', function() {
        document.querySelectorAll('.reference-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
    });
    
    // Update selected count
    function updateSelectedCount() {
        const selectedDocs = document.querySelectorAll('.document-checkbox:checked');
        const selectedRefs = document.querySelectorAll('.reference-checkbox:checked');
        let totalWordCount = 0;
        
        selectedDocs.forEach(cb => {
            totalWordCount += parseInt(cb.dataset.words) || 0;
        });
        
        selectedRefs.forEach(cb => {
            totalWordCount += parseInt(cb.dataset.words) || 0;
        });
        
        const totalSelected = selectedDocs.length + selectedRefs.length;
        selectedCount.textContent = totalSelected;
        totalWords.textContent = totalWordCount.toLocaleString();
        
        // Update individual counts
        document.getElementById('doc-count').textContent = selectedDocs.length;
        document.getElementById('ref-count').textContent = selectedRefs.length;
    }
    
    // Listen for checkbox changes
    document.querySelectorAll('.document-checkbox, .reference-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
    
    // Handle period method toggle for temporal experiments
    const manualPeriodConfig = document.getElementById('manual-period-config');
    const oedPeriodConfig = document.getElementById('oed-period-config');
    const periodMethodDescription = document.getElementById('period-method-description');
    
    document.querySelectorAll('input[name="period-method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'manual') {
                manualPeriodConfig.style.display = 'block';
                oedPeriodConfig.style.display = 'none';
                periodMethodDescription.innerHTML = '<i class="fas fa-info-circle"></i> Manually specify the time range and interval for analysis.';
            } else if (this.value === 'oed') {
                manualPeriodConfig.style.display = 'none';
                oedPeriodConfig.style.display = 'block';
                periodMethodDescription.innerHTML = '<i class="fas fa-info-circle"></i> Time periods will be automatically generated based on OED historical data.';
            }
        });
    });
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('experiment-name').value.trim();
        const type = document.getElementById('experiment-type').value;
        const description = document.getElementById('experiment-description').value.trim();
        
        const selectedDocs = Array.from(document.querySelectorAll('.document-checkbox:checked'))
            .map(cb => parseInt(cb.value));
        const selectedRefs = Array.from(document.querySelectorAll('.reference-checkbox:checked'))
            .map(cb => parseInt(cb.value));
        
        if (!name) {
            alert('Please enter an experiment name');
            return;
        }
        
        if (!type) {
            alert('Please select an experiment type');
            return;
        }
        
        if (selectedDocs.length === 0 && selectedRefs.length === 0) {
            alert('Please select at least one document or reference');
            return;
        }
        
        // Build configuration based on type
        const configuration = {};
        if (type === 'document_analysis') {
            // Document analysis doesn't require special configuration
            // Just basic processing through the document pipeline
            configuration.processing_types = ['embeddings', 'segmentation', 'entities'];
            configuration.analysis_type = 'basic_document_processing';
        } else if (type === 'temporal_evolution') {
            // Check period generation method
            const periodMethod = document.querySelector('input[name="period-method"]:checked').value;
            configuration.period_generation_method = periodMethod;
            
            if (periodMethod === 'manual') {
                const startYear = parseInt(document.getElementById('start-year').value);
                const endYear = parseInt(document.getElementById('end-year').value);
                const period = parseInt(document.getElementById('time-period').value);
                
                // Calculate time periods
                const periods = [];
                for (let year = startYear; year <= endYear; year += period) {
                    periods.push(year);
                }
                if (periods[periods.length - 1] !== endYear) {
                    periods.push(endYear);
                }
                
                configuration.start_year = startYear;
                configuration.end_year = endYear;
                configuration.period = period;
                configuration.time_periods = periods;
            } else if (periodMethod === 'oed') {
                // For OED-based periods, we'll generate them on the backend
                configuration.use_oed_periods = true;
                // Time periods will be generated after fetching OED data for all terms
                configuration.time_periods = []; // Will be populated by backend
            }
            
            configuration.track_entities = document.getElementById('track-entities').checked;
            configuration.track_frequency = document.getElementById('track-frequency').checked;
            
            const temporalTermsVal = document.getElementById('temporal-terms').value || '';
            configuration.target_terms = temporalTermsVal.split(',').map(t => t.trim()).filter(Boolean);
            
            // Validate that at least one term is provided
            if (configuration.target_terms.length === 0) {
                alert('Please enter at least one term to track for temporal evolution');
                document.getElementById('temporal-terms').focus();
                return;
            }
        } else if (type === 'domain_comparison') {
            const domainFocusVal = document.getElementById('domain-focus').value || '';
            const domains = domainFocusVal.split(',').map(d => d.trim()).filter(Boolean);
            
            configuration.domain_focus = domainFocusVal;
            configuration.domains = domains; // Parsed array of domains
            configuration.extract_terminology = document.getElementById('extract-terminology').checked;
            configuration.compare_ontologies = document.getElementById('compare-ontologies').checked;
            const targetTermsVal = document.getElementById('target-terms').value || '';
            configuration.target_terms = targetTermsVal.split(',').map(t => t.trim()).filter(Boolean);
            configuration.use_references = document.getElementById('use-references').checked;
        }
        
        try {
            const response = await fetch('/experiments/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    experiment_type: type,
                    document_ids: selectedDocs,
                    reference_ids: selectedRefs,
                    configuration: configuration
                })
            });
            
            const data = await response.json();
            if (data.success) {
                // Check if we should redirect to term manager
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    window.location.href = `/experiments/${data.experiment_id}`;
                }
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error creating experiment: ' + error.message);
        }
    });
});
</script>
{% endblock %}
