{% extends "base.html" %}

{% block title %}New Experiment - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Create New Experiment</h3>
                </div>
                <div class="card-body">
                    <form id="new-experiment-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="experiment-name" class="form-label">Experiment Name *</label>
                                    <input type="text" class="form-control" id="experiment-name"
                                           placeholder="Enter experiment name"
                                           value="{% if mode == 'single_document' and document_title %}{{ document_title }}{% endif %}"
                                           required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="experiment-type" class="form-label">Experiment Type *</label>
                                    <select class="form-select" id="experiment-type" required>
                                        <option value="single_document_analysis" {% if mode == 'single_document' %}selected{% endif %}>Single Document Analysis</option>
                                        <option value="document_analysis">Multi-Document Analysis</option>
                                        <option value="temporal_evolution" {% if mode != 'single_document' %}selected{% endif %}>Temporal Evolution</option>
                                        <option value="domain_comparison">Domain Comparison</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="experiment-description" class="form-label">Description</label>
                            <textarea class="form-control" id="experiment-description" rows="3"
                                      placeholder="Describe the purpose of this experiment..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">Select Content for Analysis *</label>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 
                                Select source documents and/or references to include in this experiment.
                                <span id="type-description"></span>
                            </div>
                            
                            <div class="row">
                                <!-- Source Documents -->
                                <div class="col-md-6">
                                    <h6><i class="fas fa-file-text text-primary"></i> Source Documents</h6>
                                    <small class="text-muted mb-3 d-block">Primary documents to analyze</small>
                                    
                                    {% if documents %}
                                    <div class="document-selection" id="document-selection-container">
                                        {% if mode == 'single_document' %}
                                            {% include 'experiments/components/single_document_selection.html' %}
                                        {% else %}
                                            {% include 'experiments/components/multi_document_selection.html' %}
                                        {% endif %}
                                    </div>
                                    <div class="document-list-fallback" style="display: none;">
                                        <div class="document-list border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                            {% for document in documents %}
                                            <div class="form-check document-item mb-2">
                                                <input class="form-check-input document-checkbox" type="checkbox"
                                                       value="{{ document.id }}" id="doc-{{ document.id }}"
                                                       data-uuid="{{ document.uuid }}"
                                                       data-title="{{ document.get_display_name() }}"
                                                       data-words="{{ document.word_count or 0 }}">
                                                <label class="form-check-label" for="doc-{{ document.id }}">
                                                    {% set filename = document.get_display_name().lower() %}
                                                    {% if filename.endswith('.pdf') %}
                                                        <i class="fas fa-file-pdf text-danger me-2" title="PDF Document"></i>
                                                    {% elif filename.endswith('.txt') %}
                                                        <i class="fas fa-file-alt text-secondary me-2" title="Text Document"></i>
                                                    {% elif filename.endswith('.md') %}
                                                        <i class="fas fa-file-code text-info me-2" title="Markdown Document"></i>
                                                    {% elif filename.endswith('.docx') or filename.endswith('.doc') %}
                                                        <i class="fas fa-file-word text-primary me-2" title="Word Document"></i>
                                                    {% elif filename.endswith('.html') %}
                                                        <i class="fas fa-code text-warning me-2" title="HTML Document"></i>
                                                    {% else %}
                                                        <i class="fas fa-file text-secondary me-2" title="Document"></i>
                                                    {% endif %}
                                                    <strong>{{ document.get_display_name() }}</strong>
                                                    <span class="text-muted">
                                                        ({{ document.word_count or 0 }} words)
                                                    </span>
                                                    {% if document.created_at %}
                                                    <small class="text-muted d-block">
                                                        Uploaded: {{ document.created_at.strftime('%Y-%m-%d %H:%M') }}
                                                    </small>
                                                    {% endif %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        No source documents available. Please
                                        <a href="{{ url_for('text_input.upload_form') }}">upload some documents</a> first.
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- References -->
                                <div class="col-md-6">
                                    <h6><i class="fas fa-book text-success"></i> References</h6>
                                    <small class="text-muted mb-3 d-block">Dictionary entries, papers, standards</small>
                                    
                                    {% if references %}
                                    <div class="reference-selection">
                                        <input type="text" class="form-control mb-3" id="reference-search" 
                                               placeholder="ðŸ” Filter references by title, author, or type...">
                                        <small class="text-muted d-block mb-2"><i class="fas fa-info-circle"></i> Type to filter the list of references below</small>
                                        
                                        <div class="reference-list border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                            {% for reference in references %}
                                            <div class="form-check reference-item mb-2">
                                                <input class="form-check-input reference-checkbox" type="checkbox" 
                                                       value="{{ reference.id }}" id="ref-{{ reference.id }}"
                                                       data-title="{{ reference.get_display_name() }}"
                                                       data-words="{{ reference.word_count or 0 }}">
                                                <label class="form-check-label" for="ref-{{ reference.id }}">
                                                    {% if reference.reference_type == 'oed_entry' or (reference.reference_subtype and 'oed' in reference.reference_subtype.lower()) %}
                                                        <i class="fas fa-external-link-alt text-info me-2" title="OED Entry (External)"></i>
                                                    {% elif (reference.original_filename and reference.original_filename.lower().endswith('.pdf')) or reference.file_type == 'pdf' %}
                                                        <i class="fas fa-file-pdf text-danger me-2" title="PDF Reference"></i>
                                                    {% elif reference.reference_type == 'paper' %}
                                                        <i class="fas fa-graduation-cap text-success me-2" title="Academic Paper"></i>
                                                    {% elif reference.reference_type == 'standard' %}
                                                        <i class="fas fa-certificate text-warning me-2" title="Standard Document"></i>
                                                    {% elif reference.reference_type == 'book' %}
                                                        <i class="fas fa-book text-primary me-2" title="Book"></i>
                                                    {% else %}
                                                        <i class="fas fa-bookmark text-secondary me-2" title="Reference"></i>
                                                    {% endif %}
                                                    <strong>{{ reference.get_display_name() }}</strong>
                                                    {% if reference.reference_subtype %}
                                                    <small class="badge bg-secondary badge-sm">{{ reference.get_reference_subtype_display() }}</small>
                                                    {% endif %}
                                                    <span class="text-muted">
                                                        ({{ reference.word_count or 0 }} words)
                                                    </span>
                                                    {% if reference.get_source_info() %}
                                                    <small class="text-muted d-block">
                                                        {{ reference.get_source_info() }}
                                                    </small>
                                                    {% endif %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> 
                                        No references available. You can add references from the 
                                        <a href="{{ url_for('references.index') }}">references section</a>.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="select-all-docs">
                                        Select All Documents
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-docs">
                                        Deselect All Documents
                                    </button>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-success" id="select-all-refs">
                                        Select All References
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-refs">
                                        Deselect All References
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <strong>Selected: </strong>
                                <span id="selected-count">0</span> items
                                (<span id="total-words">0</span> total words)
                                <small class="text-muted ms-3">
                                    <span id="doc-count">0</span> documents, <span id="ref-count">0</span> references
                                </small>
                            </div>
                        </div>
                        
                        <!-- Configuration options based on experiment type -->
                        <div id="configuration-options" class="mb-4" style="display: none;">
                            <h5>Configuration Options</h5>
                            <div id="temporal-config" style="display: none;">
                                <div class="mb-3">
                                    <label for="focus-term" class="form-label">Focus Term *</label>
                                    <input type="text" class="form-control" id="focus-term"
                                           placeholder="e.g., agent, knowledge, responsibility" required>
                                    <small class="text-muted">The term whose semantic evolution you want to track</small>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="start-year" class="form-label">Start Year</label>
                                            <input type="number" class="form-control" id="start-year"
                                                   placeholder="e.g., 1850" min="1000" max="2024">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="end-year" class="form-label">End Year</label>
                                            <input type="number" class="form-control" id="end-year"
                                                   placeholder="e.g., 2024" min="1000" max="2024">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="focus-disciplines" class="form-label">Focus Disciplines (comma-separated)</label>
                                    <input type="text" class="form-control" id="focus-disciplines"
                                           placeholder="philosophy, law, economics, AI">
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">Semantic Features *</label>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        Define the semantic features that will be analyzed for each document.
                                        These create a "semantic fingerprint" to track meaning evolution.
                                    </div>

                                    <div id="semantic-features-list" class="mb-3">
                                        <!-- Features will be added here dynamically -->
                                    </div>

                                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-feature-btn">
                                        <i class="fas fa-plus"></i> Add Semantic Feature
                                    </button>
                                </div>
                            </div>
                            
                            <div id="domain-config" style="display: none;">
                                <div class="mb-3">
                                    <label for="domain-focus" class="form-label">Domain Focus</label>
                                    <input type="text" class="form-control" id="domain-focus" 
                                           placeholder="e.g., Computer Science, Philosophy, Law, Medicine, Economics">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb"></i> Enter academic disciplines or professional domains to compare terminology across fields
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label for="target-terms" class="form-label">Target Terms (comma-separated)</label>
                                    <input type="text" class="form-control" id="target-terms" 
                                           placeholder="e.g., agent, ontology, algorithm">
                                    <small class="text-muted">We'll compare these terms across the domains you specified above.</small>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="extract-terminology">
                                    <label class="form-check-label" for="extract-terminology">
                                        Extract domain-specific terminology
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="compare-ontologies">
                                    <label class="form-check-label" for="compare-ontologies">
                                        Compare against existing ontologies
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="use-references" checked>
                                    <label class="form-check-label" for="use-references">
                                        Use linked references (ignore selected documents)
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('experiments.index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="create-btn">
                                <i class="fas fa-plus"></i> Create Experiment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('new-experiment-form');
    const typeSelect = document.getElementById('experiment-type');
    const configOptions = document.getElementById('configuration-options');
    const temporalConfig = document.getElementById('temporal-config');
    const domainConfig = document.getElementById('domain-config');
    const typeDescription = document.getElementById('type-description');
    const searchInput = document.getElementById('document-search');
    const selectedCount = document.getElementById('selected-count');
    const totalWords = document.getElementById('total-words');

    // Read URL parameters for single-document mode
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const documentUuid = urlParams.get('document_uuid');
    const documentTitle = urlParams.get('document_title');

    // NOTE: Single-document mode is now handled by server-side Jinja components
    // No JavaScript manipulation needed - the correct HTML is rendered on page load

    // Semantic features management
    let featureCounter = 0;

    function addSemanticFeature(name = '', description = '') {
        const featureId = `feature-${featureCounter++}`;
        const featureHtml = `
            <div class="card mb-2" id="${featureId}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control feature-name" placeholder="Feature name (e.g., intentionality)" value="${name}">
                        </div>
                        <div class="col-md-7">
                            <input type="text" class="form-control feature-description" placeholder="Description (e.g., Does it involve intention?)" value="${description}">
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-sm btn-danger remove-feature-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('semantic-features-list').insertAdjacentHTML('beforeend', featureHtml);

        // Add remove handler
        document.querySelector(`#${featureId} .remove-feature-btn`).addEventListener('click', function() {
            document.getElementById(featureId).remove();
        });
    }

    // Add semantic feature button
    document.getElementById('add-feature-btn')?.addEventListener('click', function() {
        addSemanticFeature();
    });
    
    // Update configuration options based on experiment type
    typeSelect.addEventListener('change', function() {
        const type = this.value;

        // Get required fields for different experiment types
        const focusTermField = document.getElementById('focus-term');

        if (type) {
            configOptions.style.display = 'block';
            temporalConfig.style.display = 'none';
            domainConfig.style.display = 'none';

            // Remove required attributes from all conditional fields
            if (focusTermField) focusTermField.removeAttribute('required');

            if (type === 'single_document_analysis') {
                // Single document analysis - simplified workflow for one document
                configOptions.style.display = 'none';
                typeDescription.textContent = 'For single document analysis, process one document through embeddings, segmentation, and entity extraction pipelines.';
            } else if (type === 'document_analysis') {
                // Document analysis doesn't need extra config - just documents
                configOptions.style.display = 'none';
                typeDescription.textContent = 'For document analysis, select one or more documents to process through embeddings, segmentation, and entity extraction pipelines.';
            } else if (type === 'temporal_evolution') {
                temporalConfig.style.display = 'block';
                typeDescription.textContent = 'For temporal evolution, configure semantic features to track how the term evolves across time and disciplines.';
                // Add required attribute back for temporal focus term
                if (focusTermField) focusTermField.setAttribute('required', '');
            } else if (type === 'domain_comparison') {
                domainConfig.style.display = 'block';
                typeDescription.textContent = 'For domain comparison, select documents from different domains to identify domain-specific terminology and concepts.';
            }
        } else {
            configOptions.style.display = 'none';
            typeDescription.textContent = '';
            // Remove required attributes when no type is selected
            if (focusTermField) focusTermField.removeAttribute('required');
        }
    });

    // Initialize form state on page load
    typeSelect.dispatchEvent(new Event('change'));

    // Document search
    const documentSearchInput = document.getElementById('document-search');
    if (documentSearchInput) {
        documentSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const documentItems = document.querySelectorAll('.document-item');
            
            documentItems.forEach(item => {
                const title = item.querySelector('.document-checkbox').dataset.title.toLowerCase();
                const label = item.querySelector('label').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || label.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Reference search
    const referenceSearchInput = document.getElementById('reference-search');
    if (referenceSearchInput) {
        referenceSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const referenceItems = document.querySelectorAll('.reference-item');
            
            referenceItems.forEach(item => {
                const title = item.querySelector('.reference-checkbox').dataset.title.toLowerCase();
                const label = item.querySelector('label').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || label.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Select/Deselect all documents
    document.getElementById('select-all-docs')?.addEventListener('click', function() {
        document.querySelectorAll('.document-checkbox').forEach(cb => {
            if (cb.closest('.document-item').style.display !== 'none') {
                cb.checked = true;
            }
        });
        updateSelectedCount();
    });
    
    document.getElementById('deselect-all-docs')?.addEventListener('click', function() {
        document.querySelectorAll('.document-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
    });
    
    // Select/Deselect all references
    document.getElementById('select-all-refs')?.addEventListener('click', function() {
        document.querySelectorAll('.reference-checkbox').forEach(cb => {
            if (cb.closest('.reference-item').style.display !== 'none') {
                cb.checked = true;
            }
        });
        updateSelectedCount();
    });
    
    document.getElementById('deselect-all-refs')?.addEventListener('click', function() {
        document.querySelectorAll('.reference-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
    });
    
    // Update selected count
    function updateSelectedCount() {
        const selectedDocs = document.querySelectorAll('.document-checkbox:checked');
        const selectedRefs = document.querySelectorAll('.reference-checkbox:checked');
        let totalWordCount = 0;
        
        selectedDocs.forEach(cb => {
            totalWordCount += parseInt(cb.dataset.words) || 0;
        });
        
        selectedRefs.forEach(cb => {
            totalWordCount += parseInt(cb.dataset.words) || 0;
        });
        
        const totalSelected = selectedDocs.length + selectedRefs.length;
        selectedCount.textContent = totalSelected;
        totalWords.textContent = totalWordCount.toLocaleString();
        
        // Update individual counts
        document.getElementById('doc-count').textContent = selectedDocs.length;
        document.getElementById('ref-count').textContent = selectedRefs.length;
    }
    
    // Listen for checkbox changes
    document.querySelectorAll('.document-checkbox, .reference-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('experiment-name').value.trim();
        const type = document.getElementById('experiment-type').value;
        const description = document.getElementById('experiment-description').value.trim();
        
        const selectedDocs = Array.from(document.querySelectorAll('.document-checkbox:checked'))
            .map(cb => parseInt(cb.value));
        const selectedRefs = Array.from(document.querySelectorAll('.reference-checkbox:checked'))
            .map(cb => parseInt(cb.value));
        
        if (!name) {
            alert('Please enter an experiment name');
            return;
        }
        
        if (!type) {
            alert('Please select an experiment type');
            return;
        }
        
        if (selectedDocs.length === 0 && selectedRefs.length === 0) {
            alert('Please select at least one document or reference');
            return;
        }
        
        // Build configuration based on type
        const configuration = {};
        if (type === 'single_document_analysis') {
            // Single document analysis - simplified workflow
            configuration.processing_types = ['embeddings', 'segmentation', 'entities'];
            configuration.analysis_type = 'single_document_processing';
        } else if (type === 'document_analysis') {
            // Document analysis doesn't require special configuration
            // Just basic processing through the document pipeline
            configuration.processing_types = ['embeddings', 'segmentation', 'entities'];
            configuration.analysis_type = 'basic_document_processing';
        } else if (type === 'temporal_evolution') {
            // Get focus term and scope
            const focusTerm = document.getElementById('focus-term')?.value.trim();
            const startYear = parseInt(document.getElementById('start-year')?.value) || null;
            const endYear = parseInt(document.getElementById('end-year')?.value) || null;
            const disciplinesStr = document.getElementById('focus-disciplines')?.value.trim();

            if (!focusTerm) {
                alert('Please enter a focus term for temporal evolution experiment');
                document.getElementById('focus-term').focus();
                return;
            }

            // Collect semantic features
            const semanticFeatures = {};
            document.querySelectorAll('#semantic-features-list .card').forEach(card => {
                const name = card.querySelector('.feature-name').value.trim();
                const desc = card.querySelector('.feature-description').value.trim();
                if (name && desc) {
                    semanticFeatures[name] = desc;
                }
            });

            if (Object.keys(semanticFeatures).length === 0) {
                alert('Please add at least one semantic feature for temporal evolution experiment');
                return;
            }

            configuration.focus_term_id = focusTerm;
            configuration.temporal_scope = {
                start_year: startYear,
                end_year: endYear,
                focus_disciplines: disciplinesStr ? disciplinesStr.split(',').map(d => d.trim()).filter(Boolean) : []
            };
            configuration.semantic_features = semanticFeatures;
        } else if (type === 'domain_comparison') {
            const domainFocusVal = document.getElementById('domain-focus').value || '';
            const domains = domainFocusVal.split(',').map(d => d.trim()).filter(Boolean);
            
            configuration.domain_focus = domainFocusVal;
            configuration.domains = domains; // Parsed array of domains
            configuration.extract_terminology = document.getElementById('extract-terminology').checked;
            configuration.compare_ontologies = document.getElementById('compare-ontologies').checked;
            const targetTermsVal = document.getElementById('target-terms').value || '';
            configuration.target_terms = targetTermsVal.split(',').map(t => t.trim()).filter(Boolean);
            configuration.use_references = document.getElementById('use-references').checked;
        }

        try {
            const response = await fetch('/experiments/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    experiment_type: type,
                    document_ids: selectedDocs,
                    reference_ids: selectedRefs,
                    configuration: configuration
                })
            });
            
            const data = await response.json();
            if (data.success) {
                // Check if we should redirect to term manager
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    window.location.href = `/experiments/${data.experiment_id}`;
                }
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error creating experiment: ' + error.message);
        }
    });

    // NOTE: All single-document mode setup is handled server-side via Jinja components
    // The server renders the correct HTML on page load - no JavaScript manipulation needed
});
</script>
{% endblock %}
