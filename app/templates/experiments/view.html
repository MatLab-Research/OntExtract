{% extends "base.html" %}
{% from "macros/processing_badges.html" import operation_badge, operation_badges_ordered, get_op_icon, get_op_color %}

{% block title %}{{ experiment.name }} - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">{{ experiment.name }}</h2>
                    <div class="d-flex align-items-center gap-2">
                        {% if experiment.experiment_type == 'entity_extraction' %}
                            <span class="badge bg-primary">Document Analysis</span>
                        {% elif experiment.experiment_type == 'temporal_evolution' %}
                            <span class="badge bg-info">Temporal Evolution</span>
                        {% elif experiment.experiment_type == 'domain_comparison' %}
                            <span class="badge bg-success">Domain Comparison</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ experiment.experiment_type }}</span>
                        {% endif %}

                        {% if experiment.status == 'draft' %}
                            <span class="badge bg-secondary">Draft</span>
                        {% elif experiment.status == 'running' %}
                            <span class="badge bg-warning">Running</span>
                        {% elif experiment.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                        {% elif experiment.status == 'error' %}
                            <span class="badge bg-danger">Error</span>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('experiments.index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>All Experiments
                    </a>
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('experiments.edit', experiment_id=experiment.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-edit me-1"></i>Edit
                    </a>
                    <button class="btn btn-outline-danger" id="delete-experiment">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Orchestration Status Banner #}
    {% if recent_orchestration %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert {% if recent_orchestration.status == 'completed' %}alert-success{% elif recent_orchestration.status == 'executing' %}alert-info{% elif recent_orchestration.status == 'failed' %}alert-danger{% else %}alert-warning{% endif %} d-flex align-items-center py-2 mb-0" role="alert">
                <div class="flex-grow-1">
                    {% if recent_orchestration.status == 'completed' %}
                        <strong><i class="fas fa-robot me-2"></i>LLM Orchestration Complete</strong>
                        {% if recent_orchestration.confidence %}
                        <span class="ms-2">{{ (recent_orchestration.confidence * 100) | round(0) }}% confidence</span>
                        {% endif %}
                        <span class="text-muted ms-2">
                            {{ ((recent_orchestration.completed_at - recent_orchestration.started_at).total_seconds()) | round(0) }}s
                        </span>
                    {% elif recent_orchestration.status == 'executing' %}
                        <strong><i class="fas fa-spinner fa-spin me-2"></i>Orchestration Running...</strong>
                    {% elif recent_orchestration.status == 'failed' %}
                        <strong><i class="fas fa-exclamation-triangle me-2"></i>Orchestration Failed</strong>
                        <span class="ms-2">{{ recent_orchestration.error_message }}</span>
                    {% else %}
                        <strong><i class="fas fa-info-circle me-2"></i>{{ recent_orchestration.status | title }}</strong>
                    {% endif %}
                </div>
                {% if recent_orchestration.status == 'completed' %}
                <a href="{{ url_for('experiments.llm_orchestration_results', experiment_id=experiment.id, run_id=recent_orchestration.id) }}"
                   class="btn btn-success btn-sm">
                    <i class="fas fa-chart-line me-1"></i>View Results
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content Grid -->
    <div class="row">
        <!-- Left Column: Info and Navigation -->
        <div class="col-lg-4 mb-4">
            <!-- Combined Info Card: Description + Metadata -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>About</h6>
                </div>
                <div class="card-body">
                    {% if experiment.description %}
                    <div class="mb-3">
                        <div class="text-muted small">{{ experiment.description | markdown }}</div>
                    </div>
                    <hr class="my-2">
                    {% endif %}
                    <dl class="row mb-0 small">
                        <dt class="col-5 text-muted">Owner</dt>
                        <dd class="col-7">{{ experiment.user.username if experiment.user else 'Unknown' }}</dd>

                        <dt class="col-5 text-muted">Created</dt>
                        <dd class="col-7">{{ experiment.created_at.strftime('%b %d, %Y') }}</dd>

                        {% if experiment.updated_at and experiment.updated_at != experiment.created_at %}
                        <dt class="col-5 text-muted">Updated</dt>
                        <dd class="col-7">{{ experiment.updated_at.strftime('%b %d, %Y') }}</dd>
                        {% endif %}

                        {% if experiment.started_at %}
                        <dt class="col-5 text-muted">Started</dt>
                        <dd class="col-7">{{ experiment.started_at.strftime('%b %d, %Y') }}</dd>
                        {% endif %}

                        {% if experiment.completed_at %}
                        <dt class="col-5 text-muted">Completed</dt>
                        <dd class="col-7">{{ experiment.completed_at.strftime('%b %d, %Y') }}</dd>
                        {% endif %}

                        {% if experiment.term %}
                        <dt class="col-5 text-muted">Focus Term</dt>
                        <dd class="col-7">
                            <a href="{{ url_for('terms.view_term', term_id=experiment.term.id) }}" class="text-decoration-none">
                                {{ experiment.term.term_text }}
                            </a>
                        </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Statistics</h6>
                </div>
                <div class="card-body py-2">
                    <div class="row text-center g-2">
                        <div class="col-6">
                            <div class="h4 mb-0 text-primary">{{ experiment.get_document_count() }}</div>
                            <small class="text-muted">Documents</small>
                        </div>
                        <div class="col-6">
                            <div class="h4 mb-0 text-info">{{ experiment.get_total_word_count() | number_format }}</div>
                            <small class="text-muted">Words</small>
                        </div>
                        <div class="col-6">
                            <div class="h4 mb-0 text-success">{{ total_processing_ops or 0 }}</div>
                            <small class="text-muted">Operations</small>
                        </div>
                        {% if temporal_data and temporal_data.periods %}
                        <div class="col-6">
                            <div class="h4 mb-0 text-warning">{{ temporal_data.periods | length }}</div>
                            <small class="text-muted">Periods</small>
                        </div>
                        {% elif temporal_data and temporal_data.time_periods and temporal_data.time_periods | length > 0 %}
                        <div class="col-6">
                            <div class="h4 mb-0 text-warning">{{ temporal_data.time_periods | length }}</div>
                            <small class="text-muted">Time Points</small>
                        </div>
                        {% elif temporal_data and temporal_data.semantic_events %}
                        <div class="col-6">
                            <div class="h4 mb-0 text-warning">{{ temporal_data.semantic_events | length }}</div>
                            <small class="text-muted">Events</small>
                        </div>
                        {% else %}
                        <div class="col-6">
                            <div class="h4 mb-0 text-secondary">{{ experiment.get_reference_count() or '-' }}</div>
                            <small class="text-muted">References</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Processing Summary (compact) -->
            {% if processing_summary %}
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Processing</h6>
                </div>
                <div class="card-body py-2">
                    <div class="d-flex flex-wrap gap-1">
                        {% for artifact_type, count in processing_summary.items() %}
                        <span class="badge bg-light text-dark border">
                            <i class="fas {{ get_op_icon(artifact_type) }} me-1 text-{{ get_op_color(artifact_type) }}"></i>
                            {{ artifact_type | replace('_', ' ') | title }}: {{ count }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Results Navigation -->
            {% if total_processing_ops and total_processing_ops > 0 %}
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-eye me-2"></i>View Results</h6>
                </div>
                <div class="card-body py-2">
                    <div class="d-flex flex-wrap gap-1">
                        <a href="{{ url_for('experiments.experiment_definitions_results', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-info" title="Definitions">
                            <i class="fas fa-book me-1"></i>Definitions
                        </a>
                        <a href="{{ url_for('experiments.experiment_entities_results', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-success" title="Entities">
                            <i class="fas fa-tags me-1"></i>Entities
                        </a>
                        <a href="{{ url_for('experiments.experiment_embeddings_results', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-primary" title="Embeddings">
                            <i class="fas fa-project-diagram me-1"></i>Embeddings
                        </a>
                        <a href="{{ url_for('experiments.experiment_segments_results', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-warning" title="Segments">
                            <i class="fas fa-align-left me-1"></i>Segments
                        </a>
                        <a href="{{ url_for('experiments.experiment_temporal_results', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-secondary" title="Temporal">
                            <i class="fas fa-clock me-1"></i>Temporal
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Provenance Views -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Provenance</h6>
                </div>
                <div class="card-body py-2">
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('provenance.provenance_graph', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-secondary" target="_blank">
                            <i class="fas fa-project-diagram me-1"></i>Graph
                        </a>
                        <a href="{{ url_for('provenance.timeline', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-stream me-1"></i>Timeline
                        </a>
                    </div>
                </div>
            </div>

            <!-- Domain Tools -->
            {% if experiment.experiment_type == 'domain_comparison' %}
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Domain Tools</h6>
                </div>
                <div class="card-body py-2">
                    <a href="{{ url_for('experiments.manage_terms', experiment_id=experiment.id) }}"
                       class="btn btn-sm btn-outline-info w-100">
                        <i class="fas fa-tags me-1"></i>Manage Terms
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Temporal Periods and Documents -->
        <div class="col-lg-8">
            {# Temporal Periods Card (only for temporal_evolution) #}
            {% if experiment.experiment_type == 'temporal_evolution' and temporal_data %}
            <div class="card mb-3">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Temporal Periods</h6>
                    <a href="{{ url_for('experiments.manage_temporal_terms', experiment_id=experiment.id) }}"
                       class="btn btn-sm btn-outline-info">
                        <i class="fas fa-edit me-1"></i>Manage
                    </a>
                </div>
                <div class="card-body py-2">
                    {% if temporal_data.periods %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for period in temporal_data.periods %}
                        <div class="border rounded p-2 text-center" style="min-width: 100px;">
                            <div class="fw-bold small">{{ period.label or period.name }}</div>
                            <div class="text-muted small">
                                {{ period.start_year }}{% if period.end_year %}-{{ period.end_year }}{% endif %}
                            </div>
                            {% if temporal_data.period_documents and temporal_data.period_documents[period.label|default(period.name, true)] %}
                            <div class="text-primary small">
                                {{ temporal_data.period_documents[period.label|default(period.name, true)] | length }} docs
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% elif temporal_data.time_periods and temporal_data.time_periods | length > 0 %}
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted small">Range:</span>
                        {% if temporal_data.time_periods | length >= 2 %}
                        <span class="badge bg-info">{{ temporal_data.time_periods[0] }} - {{ temporal_data.time_periods[-1] }}</span>
                        <span class="text-muted small">({{ temporal_data.time_periods[-1] - temporal_data.time_periods[0] }} years)</span>
                        {% else %}
                        {% for year in temporal_data.time_periods %}
                        <span class="badge bg-info">{{ year }}</span>
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-muted text-center py-2">
                        <p class="mb-2 small">No temporal periods defined.</p>
                        <a href="{{ url_for('experiments.manage_temporal_terms', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-info">
                            <i class="fas fa-plus me-1"></i>Define Periods
                        </a>
                    </div>
                    {% endif %}

                    {% if temporal_data.semantic_events %}
                    <hr class="my-2">
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted small">Events:</span>
                        {% for event in temporal_data.semantic_events[:5] %}
                        <span class="badge bg-warning text-dark" title="{{ event.description }}">
                            {{ event.type_label or event.event_type }}
                        </span>
                        {% endfor %}
                        {% if temporal_data.semantic_events | length > 5 %}
                        <span class="badge bg-secondary">+{{ temporal_data.semantic_events | length - 5 }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Documents Card -->
            <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Documents ({{ documents_enhanced | length }})
                    </h6>
                    <a href="{{ url_for('experiments.document_pipeline', experiment_id=experiment.id) }}"
                       class="btn btn-sm btn-primary">
                        <i class="fas fa-cogs me-1"></i>Document Pipeline
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if documents_enhanced %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40%">Document</th>
                                    <th style="width: 10%">Date</th>
                                    <th style="width: 35%">Processing</th>
                                    <th style="width: 15%" class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in documents_enhanced %}
                                {% set doc = item.document %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-start">
                                            <div class="me-2 text-muted">
                                                {% if doc.file_type == 'pdf' %}
                                                <i class="fas fa-file-pdf text-danger"></i>
                                                {% elif doc.file_type in ['doc', 'docx'] %}
                                                <i class="fas fa-file-word text-primary"></i>
                                                {% elif doc.content_type == 'text' %}
                                                <i class="fas fa-file-alt text-secondary"></i>
                                                {% elif doc.document_type == 'reference' %}
                                                <i class="fas fa-book text-success"></i>
                                                {% else %}
                                                <i class="fas fa-file"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-medium small">
                                                    {{ doc.title or doc.get_display_name() | truncate(45) }}
                                                </div>
                                                <div class="text-muted" style="font-size: 0.75rem;">
                                                    {% if doc.authors %}{{ doc.authors | truncate(35) }}{% endif %}
                                                    {% if doc.version_number and doc.version_number > 1 %}
                                                    <span class="badge bg-secondary">v{{ doc.version_number }}</span>
                                                    {% endif %}
                                                    {# Show content source indicator for experimental versions #}
                                                    {% if doc.processing_metadata and doc.processing_metadata.derived_from %}
                                                        {% set derived = doc.processing_metadata.derived_from %}
                                                        {% if derived.source_version_type == 'cleaned' %}
                                                        <span class="badge bg-success" title="Content from cleaned version">
                                                            <i class="fas fa-broom"></i> v{{ derived.source_version_number }}
                                                        </span>
                                                        {% endif %}
                                                    {% endif %}
                                                    {% if item.other_experiments_count > 0 %}
                                                    <span class="badge bg-info" title="Used in {{ item.other_experiments_count }} other experiment(s)">
                                                        +{{ item.other_experiments_count }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="small text-muted">
                                            {% if doc.publication_date %}
                                            {{ doc.publication_date.strftime('%Y') }}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if item.processing_by_type %}
                                        {{ operation_badges_ordered(item.processing_by_type) }}
                                        {% else %}
                                        <span class="text-muted small">Not processed</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('experiments.process_document', experiment_id=experiment.id, document_uuid=doc.uuid) }}"
                                           class="btn btn-sm btn-outline-warning" title="Process Document">
                                            <i class="fas fa-cog"></i>
                                        </a>
                                        <a href="{{ url_for('text_input.document_detail', document_uuid=doc.uuid) }}"
                                           class="btn btn-sm btn-outline-primary" title="View Document">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-alt fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-2">No documents in this experiment.</p>
                        <a href="{{ url_for('experiments.edit', experiment_id=experiment.id) }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i>Add Documents
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# References Section (if any) #}
            {% set references = experiment.references | list %}
            {% if references %}
            <div class="card mt-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-book me-2"></i>References ({{ references | length }})</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Reference</th>
                                    <th>Source</th>
                                    <th>Words</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ref in references %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-book text-success me-2"></i>
                                            <span class="small">{{ ref.get_display_name() | truncate(40) }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if ref.source_metadata and ref.source_metadata.get('source') %}
                                            <span class="badge bg-info">{{ ref.source_metadata.get('source') }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Reference</span>
                                        {% endif %}
                                    </td>
                                    <td class="small">{{ ref.word_count or 0 }}</td>
                                    <td class="text-center">
                                        <a href="{{ url_for('experiments.process_document', experiment_id=experiment.id, document_uuid=ref.uuid) }}"
                                           class="btn btn-sm btn-outline-success">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            {# Results Summary (if completed) #}
            {% if experiment.results_summary %}
            <div class="card mt-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Results Summary</h6>
                </div>
                <div class="card-body py-2">
                    <p class="mb-0 small">{{ experiment.results_summary }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Delete experiment
    const deleteBtn = document.getElementById('delete-experiment');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async function() {
            const confirmMessage = `Are you sure you want to delete this experiment?\n\nThis will delete:\n- All processing results (embeddings, segments, entities)\n- All experiment-specific data\n\nOriginal documents will be preserved.\n\nThis action cannot be undone.`;

            if (confirm(confirmMessage)) {
                deleteBtn.disabled = true;
                const originalHTML = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    const response = await fetch(`/experiments/{{ experiment.id }}/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        deleteBtn.innerHTML = '<i class="fas fa-check"></i>';
                        deleteBtn.classList.remove('btn-outline-danger');
                        deleteBtn.classList.add('btn-success');
                        setTimeout(() => { window.location.href = '/experiments'; }, 500);
                    } else {
                        alert('Error: ' + data.error);
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = originalHTML;
                    }
                } catch (error) {
                    alert('Error deleting experiment: ' + error.message);
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalHTML;
                }
            }
        });
    }
});
</script>
{% endblock %}
