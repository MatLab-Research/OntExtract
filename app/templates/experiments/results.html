{% extends "base.html" %}
{% from "macros/processing_badges.html" import operation_badge, get_op_icon, get_op_color %}

{% block title %}Results: {{ experiment.name }} - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        <i class="fas fa-chart-bar me-2 text-info"></i>
                        Experiment Results
                    </h2>
                    <p class="text-muted mb-0">{{ experiment.name }}</p>
                </div>
                <div>
                    <a href="{{ url_for('experiments.document_pipeline', experiment_id=experiment.id) }}"
                       class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Back to Pipeline
                    </a>
                    <a href="{{ url_for('experiments.view', experiment_id=experiment.id) }}"
                       class="btn btn-outline-primary">
                        <i class="fas fa-flask"></i> View Experiment
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Banner -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success d-flex align-items-center py-2">
                <i class="fas fa-check-circle fa-lg me-3"></i>
                <div>
                    <strong>Manual Processing Complete</strong>
                    <span class="ms-3 text-success-emphasis">
                        {{ total_operations }} operations |
                        {{ experiment.get_document_count() }} documents |
                        {{ experiment.get_total_word_count() | number_format }} words
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links to Results -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0">
                        <i class="fas fa-eye me-2"></i>View All Results
                    </h6>
                </div>
                <div class="card-body py-3">
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('experiments.experiment_definitions_results', experiment_id=experiment.id) }}"
                           class="btn btn-info btn-sm">
                            <i class="fas fa-book me-1"></i>All Definitions
                            {% if processing_summary.get('definitions') %}
                            <span class="badge bg-light text-dark ms-1">{{ processing_summary.get('definitions', 0) }}</span>
                            {% endif %}
                        </a>
                        <a href="{{ url_for('experiments.experiment_entities_results', experiment_id=experiment.id) }}"
                           class="btn btn-success btn-sm">
                            <i class="fas fa-tags me-1"></i>All Entities
                            {% if processing_summary.get('entities') %}
                            <span class="badge bg-light text-dark ms-1">{{ processing_summary.get('entities', 0) }}</span>
                            {% endif %}
                        </a>
                        <a href="{{ url_for('experiments.experiment_embeddings_results', experiment_id=experiment.id) }}"
                           class="btn btn-primary btn-sm">
                            <i class="fas fa-project-diagram me-1"></i>All Embeddings
                            {% if processing_summary.get('embeddings') %}
                            <span class="badge bg-light text-dark ms-1">{{ processing_summary.get('embeddings', 0) }}</span>
                            {% endif %}
                        </a>
                        <a href="{{ url_for('experiments.experiment_segments_results', experiment_id=experiment.id) }}"
                           class="btn btn-warning btn-sm">
                            <i class="fas fa-align-left me-1"></i>All Segments
                            {% if processing_summary.get('segmentation') %}
                            <span class="badge bg-light text-dark ms-1">{{ processing_summary.get('segmentation', 0) }}</span>
                            {% endif %}
                        </a>
                        <a href="{{ url_for('experiments.experiment_temporal_results', experiment_id=experiment.id) }}"
                           class="btn btn-secondary btn-sm">
                            <i class="fas fa-clock me-1"></i>All Temporal
                            {% if processing_summary.get('temporal') %}
                            <span class="badge bg-light text-dark ms-1">{{ processing_summary.get('temporal', 0) }}</span>
                            {% endif %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Statistics -->
        <div class="col-lg-4 mb-4">
            <!-- Processing Summary -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Processing Summary</h6>
                </div>
                <div class="card-body">
                    {% if processing_summary %}
                    <table class="table table-sm mb-0">
                        <tbody>
                            {% for proc_type, count in processing_summary.items() %}
                            <tr>
                                <td>
                                    <i class="fas {{ get_op_icon(proc_type) }} text-{{ get_op_color(proc_type) }} me-2"></i>
                                    {{ proc_type | replace('_', ' ') | title }}
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-{{ get_op_color(proc_type) }}">{{ count }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="border-top">
                                <th>Total Operations</th>
                                <th class="text-end">{{ total_operations }}</th>
                            </tr>
                        </tfoot>
                    </table>
                    {% else %}
                    <p class="text-muted mb-0">No processing operations recorded.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Experiment Info -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Experiment Info</h6>
                </div>
                <div class="card-body">
                    <dl class="row mb-0 small">
                        <dt class="col-5 text-muted">Type</dt>
                        <dd class="col-7">
                            {% if experiment.experiment_type == 'entity_extraction' %}
                            <span class="badge bg-primary">Document Analysis</span>
                            {% elif experiment.experiment_type == 'temporal_evolution' %}
                            <span class="badge bg-info">Temporal Evolution</span>
                            {% elif experiment.experiment_type == 'domain_comparison' %}
                            <span class="badge bg-success">Domain Comparison</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ experiment.experiment_type }}</span>
                            {% endif %}
                        </dd>

                        <dt class="col-5 text-muted">Status</dt>
                        <dd class="col-7"><span class="badge bg-success">Completed</span></dd>

                        <dt class="col-5 text-muted">Documents</dt>
                        <dd class="col-7">{{ experiment.get_document_count() }}</dd>

                        <dt class="col-5 text-muted">Total Words</dt>
                        <dd class="col-7">{{ experiment.get_total_word_count() | number_format }}</dd>

                        {% if experiment.completed_at %}
                        <dt class="col-5 text-muted">Completed</dt>
                        <dd class="col-7">{{ experiment.completed_at.strftime('%b %d, %Y %H:%M') }}</dd>
                        {% endif %}

                        {% if experiment.term %}
                        <dt class="col-5 text-muted">Focus Term</dt>
                        <dd class="col-7">
                            <a href="{{ url_for('terms.view_term', term_id=experiment.term.id) }}">
                                {{ experiment.term.term_text }}
                            </a>
                        </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Provenance -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Provenance</h6>
                </div>
                <div class="card-body py-2">
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('provenance.provenance_graph', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-secondary" target="_blank">
                            <i class="fas fa-project-diagram me-1"></i>Graph
                        </a>
                        <a href="{{ url_for('provenance.timeline', experiment_id=experiment.id) }}"
                           class="btn btn-sm btn-outline-secondary" target="_blank">
                            <i class="fas fa-stream me-1"></i>Timeline
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Documents -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Documents ({{ documents_with_processing | length }})</h6>
                </div>
                <div class="card-body p-0">
                    {% if documents_with_processing %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Document</th>
                                    <th>Year</th>
                                    <th>Processing</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in documents_with_processing %}
                                {% set doc = item.document %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-file-alt text-primary me-2"></i>
                                            <div>
                                                <a href="{{ url_for('text_input.document_detail', document_uuid=doc.uuid) }}"
                                                   class="text-decoration-none">
                                                    {{ doc.title | truncate(50) if doc.title else doc.original_filename | truncate(50) }}
                                                </a>
                                                {% if doc.authors %}
                                                <div class="small text-muted">{{ doc.authors | truncate(40) }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="small text-muted">
                                            {{ doc.publication_date.strftime('%Y') if doc.publication_date else '-' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if item.processing %}
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for proc_type, count in item.processing.items() %}
                                            <span class="badge bg-{{ get_op_color(proc_type) }}" title="{{ proc_type }}">
                                                <i class="fas {{ get_op_icon(proc_type) }} me-1"></i>{{ count }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        <span class="text-muted small">Not processed</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('experiments.process_document', experiment_id=experiment.id, document_uuid=doc.uuid) }}"
                                           class="btn btn-sm btn-outline-primary" title="View Processing">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-alt fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No documents in this experiment.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Results Summary (if any) -->
            {% if experiment.results_summary %}
            <div class="card mt-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Results Summary</h6>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ experiment.results_summary }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Export Options -->
            <div class="card mt-3">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-download me-2"></i>Export</h6>
                </div>
                <div class="card-body py-2">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="exportResults('json')">
                            <i class="fas fa-file-code me-1"></i>JSON
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportResults('csv')">
                            <i class="fas fa-file-csv me-1"></i>CSV
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportResults(format) {
    const experimentId = {{ experiment.id }};

    if (format === 'json') {
        fetch(`/experiments/api/${experimentId}`)
            .then(response => response.json())
            .then(data => {
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `experiment_${experimentId}_results.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => alert('Error exporting: ' + error.message));
    } else if (format === 'csv') {
        // Simple CSV export
        let csv = 'Document,Year,Words,Processing Operations\n';
        {% for item in documents_with_processing %}
        csv += `"{{ item.document.title | replace('"', '""') if item.document.title else item.document.original_filename | replace('"', '""') }}","{{ item.document.publication_date.strftime('%Y') if item.document.publication_date else '' }}","{{ item.document.word_count or 0 }}","{{ item.total_ops }}"\n`;
        {% endfor %}

        const blob = new Blob([csv], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `experiment_${experimentId}_documents.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    }
}
</script>

{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .btn-group, .navbar, .sidebar, .card-header .btn {
            display: none !important;
        }
        .card {
            border: 1px solid #dee2e6 !important;
        }
    }
</style>
{% endblock %}
