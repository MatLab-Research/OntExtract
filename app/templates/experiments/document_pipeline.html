{% extends "base.html" %}

{% block title %}Document Processing Pipeline - {{ experiment.name }} - OntExtract{% endblock %}

{% block content %}
<style>
    .document-card {
        margin-bottom: 20px;
    }

    .document-card.completed {
        border-left: 4px solid #28a745;
    }

    .document-card.pending {
        border-left: 4px solid #ffc107;
    }
</style>

<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>{{ experiment.name }}</h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-file-alt"></i> Document Processing Pipeline
                        <span class="ms-3">
                            <i class="fas fa-documents"></i> 
                            {{ total_count }} documents
                        </span>
                        <span class="ms-3">
                            <i class="fas fa-check-circle"></i> 
                            {{ completed_count }} processed
                        </span>
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('experiments.view', experiment_id=experiment.id) }}" 
                       class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Back to Experiment
                    </a>
                    {% if completed_count == total_count and total_count > 0 %}
                    <a href="{{ url_for('experiments.semantic_analysis', experiment_id=experiment.id) }}" 
                       class="btn btn-success">
                        <i class="fas fa-arrow-right"></i> Continue to Semantic Analysis
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Processing Mode</h5>
                </div>
                <div class="card-body">
                    <!-- Processing Mode Toggle -->
                    {% if total_count > 0 %}
                    <div class="bg-dark p-4 rounded">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>Processing Mode
                            </h5>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="processing-mode" id="mode-manual" checked autocomplete="off">
                                <label class="btn btn-outline-light" for="mode-manual">
                                    <i class="fas fa-hand-pointer me-1"></i>Manual
                                </label>

                                <input type="radio" class="btn-check" name="processing-mode" id="mode-llm" autocomplete="off">
                                <label class="btn btn-outline-light" for="mode-llm">
                                    <i class="fas fa-robot me-1"></i>LLM
                                </label>
                            </div>
                        </div>

                        <!-- Manual Mode Description -->
                        <div id="manual-mode-desc" class="mode-description">
                            <p class="text-muted mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Process each document individually by selecting processing tools manually.
                            </p>
                        </div>

                        <!-- LLM Mode Description & Options -->
                        <div id="llm-mode-desc" class="mode-description" style="display: none;">
                            <p class="text-muted mb-3">
                                <i class="fas fa-magic me-2"></i>
                                Let Claude analyze all {{ total_count }} documents together and recommend an optimal processing strategy. You'll be able to review and modify the strategy before processing begins.
                            </p>
                            <button id="analyze-experiment-btn" class="btn btn-primary btn-lg">
                                <i class="fas fa-chart-line me-2"></i>LLM Analyze
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Corpus-Wide Analysis Section -->
    {% if total_count > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Corpus-Wide Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        These operations analyze patterns across all {{ total_count }} documents in the corpus.
                        Run document-level processing first for best results.
                    </p>

                    <!-- Experiment-Type Specific Options -->
                    {% if experiment.experiment_type == 'temporal_evolution' %}
                    <!-- Temporal Evolution Corpus Analysis -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-search text-primary me-2"></i>
                                        Term Extraction + OED Enrichment
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Extract key terms from all documents and enrich with historical definitions from the Oxford English Dictionary.
                                    </p>
                                    <button class="btn btn-outline-primary btn-sm" id="run-term-extraction-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Term Extraction
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-flask me-1"></i>Coming soon
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-chart-line text-success me-2"></i>
                                        Semantic Evolution Analysis
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Track how term meanings change across temporal periods using embeddings and OED data.
                                    </p>
                                    <button class="btn btn-outline-success btn-sm" id="run-semantic-evolution-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Evolution Analysis
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-flask me-1"></i>Coming soon
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-project-diagram text-warning me-2"></i>
                                        Build Domain Ontology
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Construct a knowledge graph of domain concepts and their historical relationships.
                                    </p>
                                    <button class="btn btn-outline-warning btn-sm" id="build-ontology-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Build Ontology
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-lightbulb me-1"></i>Placeholder - not yet implemented
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-calendar-alt text-info me-2"></i>
                                        Period-Based Clustering
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Group documents by temporal markers and analyze vocabulary shifts across periods.
                                    </p>
                                    <button class="btn btn-outline-info btn-sm" id="run-period-clustering-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Clustering
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-flask me-1"></i>Coming soon
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% elif experiment.experiment_type == 'domain_comparison' %}
                    <!-- Domain Comparison Corpus Analysis -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-search text-primary me-2"></i>
                                        Term Extraction + Domain Mapping
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Extract domain-specific terminology and map relationships between different domains.
                                    </p>
                                    <button class="btn btn-outline-primary btn-sm" id="run-domain-extraction-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Domain Extraction
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-flask me-1"></i>Coming soon
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-exchange-alt text-success me-2"></i>
                                        Cross-Domain Comparison
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Compare how the same terms are used across different research domains.
                                    </p>
                                    <button class="btn btn-outline-success btn-sm" id="run-domain-comparison-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Comparison
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-flask me-1"></i>Coming soon
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-project-diagram text-warning me-2"></i>
                                        Build Domain Ontology
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Construct a knowledge graph showing conceptual differences across domains.
                                    </p>
                                    <button class="btn btn-outline-warning btn-sm" id="build-ontology-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Build Ontology
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-lightbulb me-1"></i>Placeholder - not yet implemented
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% elif experiment.experiment_type == 'entity_extraction' %}
                    <!-- Entity Extraction Corpus Analysis -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-network-wired text-primary me-2"></i>
                                        Entity Co-occurrence Analysis
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Analyze which entities frequently appear together across the corpus.
                                    </p>
                                    <button class="btn btn-outline-primary btn-sm" id="run-cooccurrence-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Analysis
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-flask me-1"></i>Coming soon
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-project-diagram text-warning me-2"></i>
                                        Build Domain Ontology
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Construct a knowledge graph of extracted entities and their relationships.
                                    </p>
                                    <button class="btn btn-outline-warning btn-sm" id="build-ontology-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Build Ontology
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-lightbulb me-1"></i>Placeholder - not yet implemented
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% else %}
                    <!-- Generic Corpus Analysis -->
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Corpus-wide analysis options will be available based on your experiment type.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Document List -->
    <div class="row">
        <div class="col-12">
            <h4 class="mb-3">Documents ({{ total_count }})</h4>
            
            {% if documents %}
                {% for doc in documents %}
                <div class="card document-card {{ doc.status }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <h5 class="card-title mb-0 me-3">{{ doc.name }}</h5>
                                    {% if doc.status == 'completed' %}
                                        <span class="badge bg-success">Processed</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <small class="text-muted">File Type:</small><br>
                                        <span class="badge bg-secondary">{{ doc.file_type }}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Word Count:</small><br>
                                        <strong>{{ "{:,}".format(doc.word_count) if doc.word_count else 'N/A' }}</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Processing Operations:</small><br>
                                        {% if doc.operation_types %}
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for op_name, op_data in doc.operation_types.items() %}
                                                    {% if op_data.source == 'llm' %}
                                                        <span class="badge bg-info" title="LLM Orchestration">
                                                            <i class="fas fa-robot me-1"></i>{{ op_name }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-primary" title="User Processing">
                                                            <i class="fas fa-user me-1"></i>{{ op_name }}
                                                        </span>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Created:</small><br>
                                        <strong>{{ doc.created_at.strftime('%Y-%m-%d') if doc.created_at else 'N/A' }}</strong>
                                    </div>
                                </div>
                            </div>

                            <div class="ms-3">
                                <a href="{{ url_for('experiments.process_document', experiment_id=experiment.id, document_uuid=doc.uuid) }}"
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i> View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No documents found for this experiment. 
                    <a href="{{ url_for('experiments.edit', experiment_id=experiment.id) }}">
                        Add documents to continue.
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Progress Modal for Experiment Orchestration -->
<div class="modal fade" id="experimentProgressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Processing Experiment</h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong id="exp-progress-stage">Initializing...</strong>
                </div>
                <div class="progress" style="height: 25px;">
                    <div id="exp-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted" id="exp-progress-details">Starting orchestration...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const experimentId = {{ experiment.id }};

document.addEventListener('DOMContentLoaded', function() {
    // Handle processing mode toggle
    const modeManual = document.getElementById('mode-manual');
    const modeLLM = document.getElementById('mode-llm');
    const manualModeDesc = document.getElementById('manual-mode-desc');
    const llmModeDesc = document.getElementById('llm-mode-desc');
    const manualProcessBtns = document.querySelectorAll('.manual-process-btn');

    function updateMode() {
        if (modeLLM && modeLLM.checked) {
            // LLM mode - show LLM description, disable manual buttons
            if (manualModeDesc) manualModeDesc.style.display = 'none';
            if (llmModeDesc) llmModeDesc.style.display = 'block';

            manualProcessBtns.forEach(btn => {
                btn.classList.add('disabled');
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
            });
        } else {
            // Manual mode - show manual description, enable manual buttons
            if (manualModeDesc) manualModeDesc.style.display = 'block';
            if (llmModeDesc) llmModeDesc.style.display = 'none';

            manualProcessBtns.forEach(btn => {
                btn.classList.remove('disabled');
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            });
        }
    }

    if (modeManual) modeManual.addEventListener('change', updateMode);
    if (modeLLM) modeLLM.addEventListener('change', updateMode);

    // Initialize mode
    updateMode();

    // Handle experiment-level orchestration
    const analyzeExperimentBtn = document.getElementById('analyze-experiment-btn');
    if (analyzeExperimentBtn) {
        analyzeExperimentBtn.addEventListener('click', async function() {
            const btn = this;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting Analysis...';

            try {
                // Start experiment orchestration (always with review)
                const response = await fetch(`/orchestration/analyze-experiment/${experimentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        review_choices: true
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const runId = data.run_id;

                    // Show progress modal and track strategy recommendation
                    const progressModal = new bootstrap.Modal(document.getElementById('experimentProgressModal'));
                    progressModal.show();

                    // Connect to SSE for progress updates (will redirect to review page when ready)
                    startExperimentProgressTracking(runId)
                } else {
                    alert(`Error: ${data.error || 'Failed to start analysis'}`);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-chart-line me-2"></i>LLM Analyze';
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-chart-line me-2"></i>LLM Analyze';
            }
        });
    }
});

// SSE Progress Tracking for Experiment Orchestration (Strategy Recommendation Phase)
function startExperimentProgressTracking(runId) {
    const eventSource = new EventSource(`/orchestration/experiment/${runId}/status`);

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.heartbeat) {
            // Just a keepalive, ignore
            return;
        }

        // Update progress UI
        if (data.stage) {
            document.getElementById('exp-progress-stage').textContent = getStageLabel(data.stage);
        }

        if (data.progress !== undefined) {
            const progressBar = document.getElementById('exp-progress-bar');
            progressBar.style.width = `${data.progress}%`;
            progressBar.textContent = `${data.progress}%`;
            progressBar.setAttribute('aria-valuenow', data.progress);
        }

        if (data.message) {
            document.getElementById('exp-progress-details').textContent = data.message;
        }

        // Handle strategy ready - always redirect to review page
        if (data.status === 'strategy_ready') {
            eventSource.close();
            setTimeout(() => {
                window.location.href = `/orchestration/experiment/${runId}/review`;
            }, 500);
        }

        // Handle error
        if (data.status === 'failed') {
            eventSource.close();
            alert(`Processing failed: ${data.error || 'Unknown error'}`);
            window.location.reload();
        }
    };

    eventSource.onerror = function(error) {
        console.error('SSE error:', error);
        eventSource.close();
        alert('Connection lost. Please check the experiment page for status.');
        window.location.reload();
    };
}

function getStageLabel(stage) {
    const labels = {
        'analyzing': 'Analyzing Experiment',
        'recommending': 'Recommending Strategy',
        'reviewing': 'Awaiting Review',
        'executing': 'Processing Documents',
        'synthesizing': 'Synthesizing Results',
        'completed': 'Complete'
    };
    return labels[stage] || stage;
}
</script>

{% endblock %}