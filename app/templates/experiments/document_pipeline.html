{% extends "base.html" %}

{% block title %}Document Processing Pipeline - {{ experiment.name }} - OntExtract{% endblock %}

{% block content %}
<style>
    .progress-indicator {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .progress-step {
        flex: 1;
        text-align: center;
        position: relative;
    }
    
    .progress-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 20px;
        right: -50%;
        width: 100%;
        height: 2px;
        background: #dee2e6;
    }
    
    .progress-step.completed::after {
        background: #28a745;
    }
    
    .progress-step.active::after {
        background: #007bff;
    }
    
    .progress-step.active .step-circle {
        background: #007bff;
        color: white;
    }
    
    .progress-step.completed .step-circle {
        background: #28a745;
        color: white;
    }
    
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dee2e6;
        color: #6c757d;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .step-label {
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .document-card {
        margin-bottom: 20px;
    }
    
    .document-card.completed {
        border-left: 4px solid #28a745;
    }
    
    .document-card.pending {
        border-left: 4px solid #ffc107;
    }
</style>

<div class="container-fluid px-4">
    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div class="progress-steps">
            <div class="progress-step completed">
                <div class="step-circle">1</div>
                <div class="step-label">Create Experiment</div>
            </div>
            <div class="progress-step active">
                <div class="step-circle">2</div>
                <div class="step-label">Process Documents</div>
            </div>
            <div class="progress-step">
                <div class="step-circle">3</div>
                <div class="step-label">Semantic Analysis</div>
            </div>
            <div class="progress-step">
                <div class="step-circle">4</div>
                <div class="step-label">View Results</div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>{{ experiment.name }}</h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-file-alt"></i> Document Processing Pipeline
                        <span class="ms-3">
                            <i class="fas fa-documents"></i> 
                            {{ total_count }} documents
                        </span>
                        <span class="ms-3">
                            <i class="fas fa-check-circle"></i> 
                            {{ completed_count }} processed
                        </span>
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('experiments.view', experiment_id=experiment.id) }}" 
                       class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Back to Experiment
                    </a>
                    {% if completed_count == total_count and total_count > 0 %}
                    <a href="{{ url_for('experiments.semantic_analysis', experiment_id=experiment.id) }}" 
                       class="btn btn-success">
                        <i class="fas fa-arrow-right"></i> Continue to Semantic Analysis
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Processing Progress</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Document Processing</span>
                        <span>{{ completed_count }} of {{ total_count }} completed</span>
                    </div>
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: {{ progress_percentage }}%"
                             aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>

                    {% if progress_percentage < 100 %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Next Steps:</strong> Process each document below by applying embeddings and NLP tools.
                        Click on any pending document to configure and apply processing.
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>All documents processed!</strong> You can now proceed to semantic analysis.
                    </div>
                    {% endif %}

                    <!-- Experiment-Level Orchestration -->
                    {% if total_count > 0 %}
                    <hr class="my-4">
                    <div class="bg-dark p-4 rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="mb-2">
                                    <i class="fas fa-robot me-2"></i>Intelligent Experiment Analysis
                                </h5>
                                <p class="text-muted mb-3">
                                    Let Anthropic Claude analyze all {{ total_count }} documents together and recommend
                                    an optimal processing strategy tailored to your experiment goals.
                                </p>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="review-choices-checkbox">
                                    <label class="form-check-label" for="review-choices-checkbox">
                                        Review and modify strategy before processing
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button id="analyze-experiment-btn" class="btn btn-primary btn-lg">
                            <i class="fas fa-brain me-2"></i>Analyze Experiment with Claude
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Document List -->
    <div class="row">
        <div class="col-12">
            <h4 class="mb-3">Documents ({{ total_count }})</h4>
            
            {% if documents %}
                {% for doc in documents %}
                <div class="card document-card {{ doc.status }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <h5 class="card-title mb-0 me-3">{{ doc.name }}</h5>
                                    {% if doc.status == 'completed' %}
                                        <span class="badge bg-success">Processed</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <small class="text-muted">File Type:</small><br>
                                        <span class="badge bg-secondary">{{ doc.file_type }}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Word Count:</small><br>
                                        <strong>{{ "{:,}".format(doc.word_count) if doc.word_count else 'N/A' }}</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Embeddings:</small><br>
                                        {% if doc.has_embeddings %}
                                            <i class="fas fa-check-circle text-success"></i> Applied
                                        {% else %}
                                            <i class="fas fa-times-circle text-warning"></i> Not Applied
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Created:</small><br>
                                        <strong>{{ doc.created_at.strftime('%Y-%m-%d') if doc.created_at else 'N/A' }}</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex flex-column gap-2">
                                <!-- Analyze with Anthropic LLM -->
                                <button class="btn btn-sm btn-primary analyze-btn"
                                        data-document-id="{{ doc.id }}"
                                        data-document-name="{{ doc.name }}">
                                    <i class="fas fa-robot"></i> Analyze with Anthropic LLM
                                </button>

                                {% if doc.status == 'pending' %}
                                <a href="{{ url_for('experiments.process_document', experiment_id=experiment.id, document_id=doc.id) }}"
                                   class="btn btn-sm btn-warning">
                                    <i class="fas fa-cog"></i> Process Document
                                </a>
                                {% else %}
                                <a href="{{ url_for('experiments.process_document', experiment_id=experiment.id, document_id=doc.id) }}"
                                   class="btn btn-sm btn-success">
                                    <i class="fas fa-check"></i> View Processing
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No documents found for this experiment. 
                    <a href="{{ url_for('experiments.edit', experiment_id=experiment.id) }}">
                        Add documents to continue.
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    {% if total_count > 0 %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="mb-3">Quick Actions</h5>
                    <div class="d-flex justify-content-center gap-3">
                        {% if completed_count < total_count %}
                        {% set next_pending = documents | selectattr('status', 'equalto', 'pending') | first %}
                        {% if next_pending %}
                        <a href="{{ url_for('experiments.process_document', experiment_id=experiment.id, document_id=next_pending.id) }}" 
                           class="btn btn-warning">
                            <i class="fas fa-play me-2"></i>Process Next Document
                        </a>
                        {% endif %}
                        {% endif %}
                        
                        <a href="{{ url_for('experiments.edit', experiment_id=experiment.id) }}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-edit me-2"></i>Edit Experiment
                        </a>
                        
                        {% if completed_count == total_count and total_count > 0 %}
                        <a href="{{ url_for('experiments.semantic_analysis', experiment_id=experiment.id) }}" 
                           class="btn btn-success">
                            <i class="fas fa-brain me-2"></i>Start Semantic Analysis
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Progress Modal for Experiment Orchestration -->
<div class="modal fade" id="experimentProgressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Processing Experiment</h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong id="exp-progress-stage">Initializing...</strong>
                </div>
                <div class="progress" style="height: 25px;">
                    <div id="exp-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted" id="exp-progress-details">Starting orchestration...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const experimentId = {{ experiment.id }};

document.addEventListener('DOMContentLoaded', function() {
    // Handle "Analyze with Anthropic LLM" button clicks (per-document)
    document.querySelectorAll('.analyze-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const documentId = this.dataset.documentId;
            const documentName = this.dataset.documentName;

            // Disable button and show loading
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';

            try {
                // Call orchestration endpoint
                const response = await fetch(`/orchestration/analyze/${documentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Show success and results
                    alert(`Analysis Complete for "${documentName}"\n\n` +
                          `Confidence: ${(data.orchestration.confidence * 100).toFixed(0)}%\n` +
                          `Tools Used: ${data.orchestration.recommended_tools.join(', ')}\n\n` +
                          `Click OK to view full results.`);

                    // Redirect to results page (could also show in modal)
                    window.location.href = `/orchestration/document/${documentId}`;
                } else {
                    alert(`Analysis Failed\n\n${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Error\n\n${error.message}`);
            } finally {
                // Re-enable button
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-robot"></i> Analyze with Anthropic LLM';
            }
        });
    });

    // Handle experiment-level orchestration
    const analyzeExperimentBtn = document.getElementById('analyze-experiment-btn');
    if (analyzeExperimentBtn) {
        analyzeExperimentBtn.addEventListener('click', async function() {
            const reviewChoices = document.getElementById('review-choices-checkbox').checked;
            const btn = this;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting Analysis...';

            try {
                // Start experiment orchestration
                const response = await fetch(`/orchestration/analyze-experiment/${experimentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        review_choices: reviewChoices
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const runId = data.run_id;

                    // Show progress modal and track strategy recommendation
                    const progressModal = new bootstrap.Modal(document.getElementById('experimentProgressModal'));
                    progressModal.show();

                    // Connect to SSE for progress updates (will redirect to review page when ready)
                    startExperimentProgressTracking(runId)
                } else {
                    alert(`Error: ${data.error || 'Failed to start analysis'}`);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-brain me-2"></i>Analyze Experiment with Claude';
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-brain me-2"></i>Analyze Experiment with Claude';
            }
        });
    }
});

// SSE Progress Tracking for Experiment Orchestration (Strategy Recommendation Phase)
function startExperimentProgressTracking(runId) {
    const eventSource = new EventSource(`/orchestration/experiment/${runId}/status`);

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.heartbeat) {
            // Just a keepalive, ignore
            return;
        }

        // Update progress UI
        if (data.stage) {
            document.getElementById('exp-progress-stage').textContent = getStageLabel(data.stage);
        }

        if (data.progress !== undefined) {
            const progressBar = document.getElementById('exp-progress-bar');
            progressBar.style.width = `${data.progress}%`;
            progressBar.textContent = `${data.progress}%`;
            progressBar.setAttribute('aria-valuenow', data.progress);
        }

        if (data.message) {
            document.getElementById('exp-progress-details').textContent = data.message;
        }

        // Handle strategy ready - always redirect to review page
        if (data.status === 'strategy_ready') {
            eventSource.close();
            setTimeout(() => {
                window.location.href = `/orchestration/experiment/${runId}/review`;
            }, 500);
        }

        // Handle error
        if (data.status === 'failed') {
            eventSource.close();
            alert(`Processing failed: ${data.error || 'Unknown error'}`);
            window.location.reload();
        }
    };

    eventSource.onerror = function(error) {
        console.error('SSE error:', error);
        eventSource.close();
        alert('Connection lost. Please check the experiment page for status.');
        window.location.reload();
    };
}

function getStageLabel(stage) {
    const labels = {
        'analyzing': 'Analyzing Experiment',
        'recommending': 'Recommending Strategy',
        'reviewing': 'Awaiting Review',
        'executing': 'Processing Documents',
        'synthesizing': 'Synthesizing Results',
        'completed': 'Complete'
    };
    return labels[stage] || stage;
}
</script>

{% endblock %}