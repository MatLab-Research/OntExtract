{% extends "base.html" %}

{% block title %}Document Processing Pipeline - {{ experiment.name }} - OntExtract{% endblock %}

{% block content %}
<style>
    .document-card {
        margin-bottom: 20px;
    }

    .document-card.completed {
        border-left: 4px solid #28a745;
    }
</style>

<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>{{ experiment.name }}</h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-file-alt"></i> Document Processing Pipeline
                        <span class="ms-3">
                            <i class="fas fa-documents"></i> 
                            {{ total_count }} documents
                        </span>
                        <span class="ms-3">
                            <i class="fas fa-check-circle"></i> 
                            {{ completed_count }} processed
                        </span>
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('experiments.view', experiment_id=experiment.id) }}"
                       class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Back to Experiment
                    </a>
                    {% if completed_count == total_count and total_count > 0 and experiment.experiment_type == 'temporal_evolution' %}
                    <a href="{{ url_for('experiments.semantic_evolution_visual', experiment_id=experiment.id) }}"
                       class="btn btn-success">
                        <i class="fas fa-arrow-right"></i> Continue to Semantic Analysis
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Processing Mode</h5>
                </div>
                <div class="card-body">
                    <!-- Processing Mode Toggle -->
                    {% if total_count > 0 %}
                    <div class="bg-dark p-4 rounded">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>Processing Mode
                            </h5>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="processing-mode" id="mode-manual" checked autocomplete="off">
                                <label class="btn btn-outline-light" for="mode-manual">
                                    <i class="fas fa-hand-pointer me-1"></i>Manual
                                </label>

                                <input type="radio" class="btn-check" name="processing-mode" id="mode-llm" autocomplete="off">
                                <label class="btn btn-outline-light" for="mode-llm">
                                    <i class="fas fa-robot me-1"></i>LLM
                                </label>
                            </div>
                        </div>

                        <!-- Manual Mode Description -->
                        <div id="manual-mode-desc" class="mode-description">
                            <p class="text-muted mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Process each document individually by selecting processing tools manually.
                            </p>
                        </div>

                        <!-- LLM Mode Description & Options -->
                        <div id="llm-mode-desc" class="mode-description" style="display: none;">
                            <p class="text-muted mb-3">
                                <i class="fas fa-magic me-2"></i>
                                Let Claude analyze all {{ total_count }} documents together and recommend an optimal processing strategy. You'll be able to review and modify the strategy before processing begins.
                            </p>
                            <button id="analyze-experiment-btn" class="btn btn-primary btn-lg" data-experiment-id="{{ experiment.id }}">
                                <i class="fas fa-chart-line me-2"></i>LLM Analyze
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Corpus-Wide Analysis Section -->
    <!-- Hidden for Dec 15 demo - LLM Analyze provides corpus-wide analysis automatically -->
    {% if total_count > 0 %}
    <div class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Corpus-Wide Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        These operations analyze patterns across all {{ total_count }} documents in the corpus.
                        Run document-level processing first for best results.
                    </p>

                    <!-- Experiment-Type Specific Options -->
                    {% if experiment.experiment_type == 'temporal_evolution' %}
                    <!-- Temporal Evolution Corpus Analysis -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-search text-primary me-2"></i>
                                        Term Extraction + OED Enrichment
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Extract key terms from all documents and enrich with historical definitions from the Oxford English Dictionary.
                                    </p>
                                    <button class="btn btn-outline-primary btn-sm" id="run-term-extraction-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Term Extraction
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-chart-line text-success me-2"></i>
                                        Semantic Evolution Analysis
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Track how term meanings change across temporal periods using embeddings and OED data.
                                    </p>
                                    <button class="btn btn-outline-success btn-sm" id="run-semantic-evolution-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Evolution Analysis
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-project-diagram text-warning me-2"></i>
                                        Build Domain Ontology
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Construct a knowledge graph of domain concepts and their historical relationships.
                                    </p>
                                    <button class="btn btn-outline-warning btn-sm" id="build-ontology-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Build Ontology
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-calendar-alt text-info me-2"></i>
                                        Period-Based Clustering
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Group documents by temporal markers and analyze vocabulary shifts across periods.
                                    </p>
                                    <button class="btn btn-outline-info btn-sm" id="run-period-clustering-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Clustering
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% elif experiment.experiment_type == 'domain_comparison' %}
                    <!-- Domain Comparison Corpus Analysis -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-search text-primary me-2"></i>
                                        Term Extraction + Domain Mapping
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Extract domain-specific terminology and map relationships between different domains.
                                    </p>
                                    <button class="btn btn-outline-primary btn-sm" id="run-domain-extraction-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Domain Extraction
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-exchange-alt text-success me-2"></i>
                                        Cross-Domain Comparison
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Compare how the same terms are used across different research domains.
                                    </p>
                                    <button class="btn btn-outline-success btn-sm" id="run-domain-comparison-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Comparison
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-project-diagram text-warning me-2"></i>
                                        Build Domain Ontology
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Construct a knowledge graph showing conceptual differences across domains.
                                    </p>
                                    <button class="btn btn-outline-warning btn-sm" id="build-ontology-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Build Ontology
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% elif experiment.experiment_type == 'entity_extraction' %}
                    <!-- Entity Extraction Corpus Analysis -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-network-wired text-primary me-2"></i>
                                        Entity Co-occurrence Analysis
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Analyze which entities frequently appear together across the corpus.
                                    </p>
                                    <button class="btn btn-outline-primary btn-sm" id="run-cooccurrence-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Run Analysis
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-project-diagram text-warning me-2"></i>
                                        Build Domain Ontology
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Construct a knowledge graph of extracted entities and their relationships.
                                    </p>
                                    <button class="btn btn-outline-warning btn-sm" id="build-ontology-btn" disabled>
                                        <i class="fas fa-play me-1"></i>Build Ontology
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% else %}
                    <!-- Generic Corpus Analysis -->
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Corpus-wide analysis options will be available based on your experiment type.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Document List -->
    <div class="row">
        <div class="col-12">
            <h4 class="mb-3">Documents ({{ total_count }})</h4>
            
            {% if documents %}
                {% for doc in documents %}
                <div class="card document-card {{ doc.status }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <h5 class="card-title mb-1">{{ doc.name }}</h5>
                                    <div>
                                        {% if doc.status == 'completed' %}
                                            <span class="badge bg-success">Processed</span>
                                        {% endif %}
                                        {% if doc.version_number and doc.version_number > 1 %}
                                            <span class="badge bg-info ms-2" title="Document version">
                                                v{{ doc.version_number }}{% if doc.version_type %} ({{ doc.version_type }}){% endif %}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <small class="text-muted">File Type:</small><br>
                                        <span class="badge bg-secondary">{{ doc.file_type }}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Word Count:</small><br>
                                        <strong>{{ "{:,}".format(doc.word_count) if doc.word_count else 'N/A' }}</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Processing Operations:</small><br>
                                        {% if doc.operation_types %}
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for op_name, op_data in doc.operation_types.items() %}
                                                    {% if op_data.source == 'llm' %}
                                                        <span class="badge bg-info" title="LLM Orchestration">
                                                            <i class="fas fa-robot me-1"></i>{{ op_name }}
                                                        </span>
                                                    {% elif op_data.source == 'experiment' %}
                                                        <span class="badge bg-success" title="Experiment Processing">
                                                            <i class="fas fa-flask me-1"></i>{{ op_name }}
                                                        </span>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Created:</small><br>
                                        <strong>{{ doc.created_at.strftime('%Y-%m-%d') if doc.created_at else 'N/A' }}</strong>
                                    </div>
                                </div>
                            </div>

                            <div class="ms-3 d-flex gap-2">
                                <button class="btn btn-outline-success" onclick="openTextCleanupModal('{{ doc.uuid }}')" title="Clean text with LLM">
                                    <i class="fas fa-broom{% if not doc.has_cleanup %} me-1{% endif %}"></i>{% if not doc.has_cleanup %} LLM Cleanup{% endif %}
                                </button>
                                <a href="{{ url_for('experiments.process_document', experiment_id=experiment.id, document_uuid=doc.uuid) }}"
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i> View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No documents found for this experiment. 
                    <a href="{{ url_for('experiments.edit', experiment_id=experiment.id) }}">
                        Add documents to continue.
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- LLM Orchestration Progress Modal -->
<div class="modal fade" id="llm-progress-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-robot me-2"></i>LLM Orchestration in Progress
                </h5>
            </div>
            <div class="modal-body">
                <!-- Stage Indicators -->
                <div class="d-flex justify-content-between mb-4 flex-wrap">
                    <div id="stage-analyzing" class="stage-indicator text-center flex-fill px-2">
                        <div class="stage-icon mb-2">
                            <i class="fas fa-search fa-2x"></i>
                        </div>
                        <small class="stage-label">Analyze</small>
                    </div>
                    <div class="stage-arrow flex-shrink-0 px-2">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div id="stage-recommending" class="stage-indicator text-center flex-fill px-2">
                        <div class="stage-icon mb-2">
                            <i class="fas fa-lightbulb fa-2x"></i>
                        </div>
                        <small class="stage-label">Recommend</small>
                    </div>
                    <div class="stage-arrow flex-shrink-0 px-2">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div id="stage-reviewing" class="stage-indicator text-center flex-fill px-2">
                        <div class="stage-icon mb-2">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                        <small class="stage-label">Review</small>
                    </div>
                    <div class="stage-arrow flex-shrink-0 px-2">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div id="stage-executing" class="stage-indicator text-center flex-fill px-2">
                        <div class="stage-icon mb-2">
                            <i class="fas fa-cogs fa-2x"></i>
                        </div>
                        <small class="stage-label">Execute</small>
                    </div>
                    <div class="stage-arrow flex-shrink-0 px-2">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div id="stage-synthesizing" class="stage-indicator text-center flex-fill px-2">
                        <div class="stage-icon mb-2">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                        <small class="stage-label">Synthesize</small>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-3">
                    <div class="progress" style="height: 25px;">
                        <div id="llm-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                             role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                </div>

                <!-- Status Message -->
                <div class="text-center">
                    <p id="llm-status-message" class="mb-0">Starting analysis...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Strategy Review Modal -->
<div class="modal fade" id="strategy-review-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-check me-2"></i>Review Recommended Strategy
                </h5>
            </div>
            <div class="modal-body">
                <!-- Experiment Goal -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Experiment Goal</h6>
                    <p id="review-experiment-goal" class="border-start border-4 border-primary ps-3 mb-0"></p>
                </div>

                <!-- Confidence Score -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Confidence Score</h6>
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1 me-3">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 0%">
                                </div>
                            </div>
                        </div>
                        <strong id="review-confidence" class="text-success fs-5">0%</strong>
                    </div>
                </div>

                <!-- Reasoning -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Strategy Reasoning</h6>
                    <p id="review-reasoning" class="bg-light p-3 rounded mb-0"></p>
                </div>

                <!-- Recommended Tools per Document -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Recommended Tools by Document</h6>
                    <div id="review-strategy-list"></div>
                </div>

                <!-- Review Notes -->
                <div class="mb-3">
                    <label for="review-notes" class="form-label">Your Notes (Optional)</label>
                    <textarea id="review-notes" class="form-control" rows="3"
                              placeholder="Add any notes about modifications or observations..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" id="approve-strategy-btn" class="btn btn-success">
                    <i class="fas fa-check me-1"></i>Approve & Continue
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.stage-indicator {
    opacity: 0.3;
    transition: all 0.3s ease;
}

.stage-indicator.stage-completed {
    opacity: 1;
    color: #28a745;
}

.stage-indicator.stage-current {
    opacity: 1;
    color: #007bff;
    transform: scale(1.1);
}

.stage-indicator.stage-current .stage-icon i {
    animation: pulse 1.5s ease-in-out infinite;
}

.stage-arrow {
    opacity: 0.3;
    color: #6c757d;
    display: flex;
    align-items: center;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

@media (max-width: 768px) {
    .stage-arrow {
        display: none;
    }
}
</style>

<!-- Include LLM Orchestration JavaScript -->
<script src="{{ url_for('static', filename='js/llm_orchestration.js') }}"></script>

<script>
const experimentId = {{ experiment.id }};

document.addEventListener('DOMContentLoaded', function() {
    // Handle processing mode toggle
    const modeManual = document.getElementById('mode-manual');
    const modeLLM = document.getElementById('mode-llm');
    const manualModeDesc = document.getElementById('manual-mode-desc');
    const llmModeDesc = document.getElementById('llm-mode-desc');
    const manualProcessBtns = document.querySelectorAll('.manual-process-btn');

    function updateMode() {
        if (modeLLM && modeLLM.checked) {
            // LLM mode - show LLM description, disable manual buttons
            if (manualModeDesc) manualModeDesc.style.display = 'none';
            if (llmModeDesc) llmModeDesc.style.display = 'block';

            manualProcessBtns.forEach(btn => {
                btn.classList.add('disabled');
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
            });
        } else {
            // Manual mode - show manual description, enable manual buttons
            if (manualModeDesc) manualModeDesc.style.display = 'block';
            if (llmModeDesc) llmModeDesc.style.display = 'none';

            manualProcessBtns.forEach(btn => {
                btn.classList.remove('disabled');
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            });
        }
    }

    if (modeManual) modeManual.addEventListener('change', updateMode);
    if (modeLLM) modeLLM.addEventListener('change', updateMode);

    // Initialize mode
    updateMode();
});
</script>

<!-- Include Text Cleanup Modal -->
{% include 'processing/text_cleanup_modal.html' %}

{% endblock %}