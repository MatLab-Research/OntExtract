{% extends "base.html" %}

{% block title %}Edit Experiment - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Edit {{ experiment.name }}</h3>
                </div>
                <div class="card-body">
                    <form id="edit-experiment-form">
                        {# Temporal Evolution - Focus Term Selection (appears at top when selected) #}
                        <div id="focus-term-section" class="mb-3" style="display: none;">
                            <label for="focus-term" class="form-label">Focus Term *</label>
                            <select class="form-select" id="focus-term">
                                <option value="">Select a term...</option>
                                {% for term in terms %}
                                <option value="{{ term.id }}" {% if term.id|string in selected_term_ids or term.id in selected_term_ids %}selected{% endif %}>{{ term.term_text }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                Required for temporal evolution experiments
                            </small>
                        </div>

                        {# Basic Information #}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="experiment-name" class="form-label">Experiment Name *</label>
                                    <input type="text" class="form-control" id="experiment-name"
                                           value="{{ experiment.name }}"
                                           placeholder="Enter experiment name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="experiment-type" class="form-label">Experiment Type *</label>
                                    <select class="form-select" id="experiment-type" required>
                                        <option value="">Select type...</option>
                                        <option value="entity_extraction" {% if experiment.experiment_type == 'entity_extraction' %}selected{% endif %}>Document Analysis</option>
                                        <option value="temporal_evolution" {% if experiment.experiment_type == 'temporal_evolution' %}selected{% endif %}>Temporal Evolution</option>
                                        {# Temporarily disabled for JCDL - will re-enable post-conference #}
                                        {# <option value="domain_comparison" {% if experiment.experiment_type == 'domain_comparison' %}selected{% endif %}>Domain Comparison</option> #}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="experiment-description" class="form-label">Description</label>
                            <textarea class="form-control" id="experiment-description" rows="3"
                                      placeholder="Describe the purpose of this experiment...">{{ experiment.description or '' }}</textarea>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                This description will inform LLM suggestions for processing methods and analysis tools.
                            </small>
                        </div>

                        {# Document Selection #}
                        <div class="mb-4">
                            <label class="form-label">Select Content for Analysis *</label>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <span id="type-description">Select source documents for your experiment.</span>
                            </div>

                            <div class="row">
                                {# Source Documents #}
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <h6 class="mb-0"><i class="fas fa-file-text text-primary"></i> Source Documents</h6>
                                            <small class="text-muted">Primary documents to analyze</small>
                                        </div>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="select-all-docs">
                                                Select All
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-docs">
                                                Deselect All
                                            </button>
                                        </div>
                                    </div>

                                    {% if documents %}
                                        <input type="text" class="form-control mb-3" id="document-search"
                                               placeholder="Filter documents by name or content...">
                                        <small class="text-muted d-block mb-2">
                                            <i class="fas fa-info-circle"></i> Type to filter the list of documents below
                                        </small>

                                        <div class="document-list border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                            {% for document in documents %}
                                            <div class="form-check document-item mb-2">
                                                <input class="form-check-input document-checkbox" type="checkbox"
                                                       value="{{ document.id }}" id="doc-{{ document.id }}"
                                                       data-uuid="{{ document.uuid }}"
                                                       data-title="{{ document.get_display_name() }}"
                                                       data-words="{{ document.word_count or 0 }}"
                                                       {% if document.id in selected_doc_ids %}checked{% endif %}>
                                                <label class="form-check-label" for="doc-{{ document.id }}">
                                                    {% set filename = document.get_display_name().lower() %}
                                                    {% if filename.endswith('.pdf') %}
                                                        <i class="fas fa-file-pdf text-danger me-2" title="PDF Document"></i>
                                                    {% elif filename.endswith('.txt') %}
                                                        <i class="fas fa-file-alt text-secondary me-2" title="Text Document"></i>
                                                    {% elif filename.endswith('.md') %}
                                                        <i class="fas fa-file-code text-info me-2" title="Markdown Document"></i>
                                                    {% elif filename.endswith('.docx') or filename.endswith('.doc') %}
                                                        <i class="fas fa-file-word text-primary me-2" title="Word Document"></i>
                                                    {% elif filename.endswith('.html') %}
                                                        <i class="fas fa-code text-warning me-2" title="HTML Document"></i>
                                                    {% else %}
                                                        <i class="fas fa-file text-secondary me-2" title="Document"></i>
                                                    {% endif %}
                                                    <strong>{{ document.get_display_name() }}</strong>
                                                    <span class="text-muted">
                                                        ({{ document.word_count or 0 }} words)
                                                    </span>
                                                    {% if document.created_at %}
                                                    <small class="text-muted d-block">
                                                        Uploaded: {{ document.created_at.strftime('%Y-%m-%d %H:%M') }}
                                                    </small>
                                                    {% endif %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            No documents available. <a href="{{ url_for('upload.unified') }}">Upload documents</a> first.
                                        </div>
                                    {% endif %}
                                </div>

                                {# References #}
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="mb-0"><i class="fas fa-book text-success"></i> References</h6>
                                            <small class="text-muted">Dictionary entries, papers, standards</small>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="collapse" data-bs-target="#quick-add-reference">
                                            <i class="fas fa-plus"></i> Quick Add
                                        </button>
                                    </div>

                                    {# Quick Add Reference Interface #}
                                    <div class="collapse mb-3" id="quick-add-reference">
                                        <div class="card card-body">
                                            <small class="text-muted mb-2">Fetch dictionary definitions and create references</small>
                                            <div class="input-group input-group-sm mb-2">
                                                <input type="text" class="form-control" id="quick-ref-term" placeholder="Enter term...">
                                                <button class="btn btn-outline-primary" type="button" id="quick-mw-btn">
                                                    <i class="fas fa-book"></i> MW
                                                </button>
                                                <button class="btn btn-outline-primary" type="button" id="quick-oed-btn">
                                                    <i class="fas fa-university"></i> OED
                                                </button>
                                            </div>
                                            <div id="quick-ref-results" style="max-height: 200px; overflow-y: auto;"></div>
                                        </div>
                                    </div>

                                    {# Existing References List #}
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-sm btn-outline-success" id="select-all-refs">
                                                Select All
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-refs">
                                                Deselect All
                                            </button>
                                        </div>
                                    </div>

                                    {% if references %}
                                    <div class="reference-list border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                        {% for reference in references %}
                                        <div class="form-check reference-item mb-2">
                                            <input class="form-check-input reference-checkbox" type="checkbox"
                                                   value="{{ reference.id }}" id="ref-{{ reference.id }}"
                                                   {% if reference.id in selected_ref_ids %}checked{% endif %}>
                                            <label class="form-check-label" for="ref-{{ reference.id }}">
                                                <strong>{{ reference.get_display_name() }}</strong>
                                                <span class="text-muted">({{ reference.word_count or 0 }} words)</span>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        No references available. Use Quick Add above.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>


                        {# Submit Buttons #}
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('experiments.view', experiment_id=experiment.id) }}"
                               class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('edit-experiment-form');
    const typeSelect = document.getElementById('experiment-type');
    const focusTermSection = document.getElementById('focus-term-section');
    const typeDescription = document.getElementById('type-description');

    // Update UI based on experiment type selection
    typeSelect.addEventListener('change', function() {
        const type = this.value;
        const descriptionField = document.getElementById('experiment-description');

        // Hide focus term section by default
        if (focusTermSection) focusTermSection.style.display = 'none';

        // Update description and show relevant config
        if (type === 'entity_extraction') {
            typeDescription.textContent = 'Analyze document content using embeddings, segmentation, entity extraction, and NLP pipelines.';
        } else if (type === 'temporal_evolution') {
            typeDescription.textContent = 'Track how a term evolves across time and disciplines.';
            // Show focus term selection
            if (focusTermSection) focusTermSection.style.display = 'block';
        } else if (type === 'domain_comparison') {
            typeDescription.textContent = 'Compare terminology and concepts across different domains.';
        }
    });

    // Initialize on page load - show focus term section if temporal evolution
    if (typeSelect.value === 'temporal_evolution' && focusTermSection) {
        focusTermSection.style.display = 'block';
    }
    typeSelect.dispatchEvent(new Event('change'));

    // Auto-fill experiment name when focus term is selected (only for empty names)
    const focusTermSelect = document.getElementById('focus-term');
    if (focusTermSelect) {
        focusTermSelect.addEventListener('change', function() {
            const experimentNameField = document.getElementById('experiment-name');
            const type = typeSelect.value;

            // Only auto-fill if temporal evolution is selected and name field is empty
            if (type === 'temporal_evolution' && !experimentNameField.value.trim() && this.value) {
                const termText = this.options[this.selectedIndex].text;
                experimentNameField.value = `${termText} Temporal Evolution`;
            }
        });
    }

    // Document search functionality
    const documentSearch = document.getElementById('document-search');
    if (documentSearch) {
        documentSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const documentItems = document.querySelectorAll('.document-item');

            documentItems.forEach(item => {
                const title = item.querySelector('[data-title]')?.getAttribute('data-title')?.toLowerCase() || '';
                const label = item.querySelector('label')?.textContent?.toLowerCase() || '';

                if (title.includes(searchTerm) || label.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    // Select All / Deselect All for documents
    document.getElementById('select-all-docs')?.addEventListener('click', function() {
        document.querySelectorAll('.document-checkbox:not([style*="display: none"])').forEach(cb => {
            if (cb.closest('.document-item').style.display !== 'none') {
                cb.checked = true;
            }
        });
    });

    document.getElementById('deselect-all-docs')?.addEventListener('click', function() {
        document.querySelectorAll('.document-checkbox').forEach(cb => {
            cb.checked = false;
        });
    });

    // Select All / Deselect All for references
    document.getElementById('select-all-refs')?.addEventListener('click', function() {
        document.querySelectorAll('.reference-checkbox').forEach(cb => {
            cb.checked = true;
        });
    });

    document.getElementById('deselect-all-refs')?.addEventListener('click', function() {
        document.querySelectorAll('.reference-checkbox').forEach(cb => {
            cb.checked = false;
        });
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const name = document.getElementById('experiment-name').value.trim();
        const type = typeSelect.value;
        const description = document.getElementById('experiment-description').value.trim();

        // Collect selected documents
        const documentIds = [];
        document.querySelectorAll('.document-checkbox:checked').forEach(cb => {
            documentIds.push(parseInt(cb.value));
        });

        // Collect selected references
        const referenceIds = [];
        document.querySelectorAll('.reference-checkbox:checked').forEach(cb => {
            referenceIds.push(parseInt(cb.value));
        });

        if (!name) {
            alert('Please enter an experiment name');
            return;
        }

        if (documentIds.length === 0 && referenceIds.length === 0) {
            alert('Please select at least one document or reference');
            return;
        }

        // Build configuration
        const configuration = {};
        if (type === 'temporal_evolution') {
            const termId = document.getElementById('focus-term')?.value;
            if (!termId) {
                alert('Please select a focus term for temporal evolution experiments');
                return;
            }
            configuration.focus_term_id = termId;
        } else if (type === 'domain_comparison') {
            const domains = document.getElementById('domain-focus')?.value;
            if (domains) configuration.domain_focus = domains;
        }

        try {
            const response = await fetch('/experiments/{{ experiment.id }}/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    description: description,
                    experiment_type: type,
                    document_ids: documentIds,
                    reference_ids: referenceIds,
                    configuration: configuration
                })
            });

            const data = await response.json();
            if (data.success) {
                window.location.href = data.redirect || `/experiments/${data.experiment_id}`;
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error updating experiment: ' + error.message);
        }
    });

    // Quick Add Reference functionality
    const quickRefTerm = document.getElementById('quick-ref-term');
    const quickMwBtn = document.getElementById('quick-mw-btn');
    const quickOedBtn = document.getElementById('quick-oed-btn');
    const quickRefResults = document.getElementById('quick-ref-results');

    async function fetchDictionaryDefinitions(term, source) {
        quickRefResults.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</div>';

        try {
            let url, response, data;

            if (source === 'mw') {
                url = `/api/merriam-webster/dictionary/${encodeURIComponent(term)}`;
                response = await fetch(url);
                data = await response.json();

                if (!data.success) {
                    quickRefResults.innerHTML = `<div class="alert alert-danger alert-sm mb-0">${data.error || 'Failed to fetch definitions'}</div>`;
                    return;
                }

                const results = data.results || [];
                if (results.length === 0) {
                    quickRefResults.innerHTML = '<div class="alert alert-info alert-sm mb-0">No definitions found</div>';
                    return;
                }

                let html = '<div class="list-group list-group-flush">';
                results.forEach((result, resultIndex) => {
                    const definitions = result.definitions || [];
                    definitions.forEach((definition, defIndex) => {
                        const senseNumber = resultIndex * 10 + defIndex + 1;
                        html += `
                            <div class="list-group-item p-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <strong class="text-primary">${senseNumber}.</strong>
                                        <span class="small">${definition}</span>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-success create-ref-btn ms-2"
                                            data-term="${term}"
                                            data-source="MW"
                                            data-definition="${definition.replace(/"/g, '&quot;')}"
                                            data-sense-number="${senseNumber}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                });
                html += '</div>';
                quickRefResults.innerHTML = html;

            } else if (source === 'oed') {
                // Use same endpoint as terms/add and experiments/new pages
                url = `/references/api/oed/suggest?q=${encodeURIComponent(term)}`;
                response = await fetch(url);
                data = await response.json();

                if (!data.success) {
                    quickRefResults.innerHTML = `<div class="alert alert-danger alert-sm mb-0">${data.error || 'Failed to fetch definitions'}</div>`;
                    return;
                }

                const suggestions = data.suggestions || [];
                if (suggestions.length === 0) {
                    quickRefResults.innerHTML = '<div class="alert alert-info alert-sm mb-0">No OED entries found</div>';
                    return;
                }

                let html = '<div class="list-group list-group-flush">';
                suggestions.forEach((entry, index) => {
                    const entryId = entry.entry_id || '';
                    const headword = entry.headword || term;
                    const definition = entry.definition || '';
                    if (!definition) return; // Skip entries without definitions

                    html += `
                        <div class="list-group-item p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong class="text-primary">${headword}</strong>
                                    <small class="text-muted ms-1">(${entryId})</small>
                                    <div class="small">${definition}</div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-success create-ref-btn ms-2"
                                        data-term="${headword}"
                                        data-source="OED"
                                        data-definition="${definition.replace(/"/g, '&quot;')}"
                                        data-sense-number="${index + 1}">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                quickRefResults.innerHTML = html;
            }

            // Add click handlers for create buttons
            document.querySelectorAll('.create-ref-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    await createReference(this.dataset, this);
                });
            });

        } catch (error) {
            quickRefResults.innerHTML = `<div class="alert alert-danger alert-sm mb-0">Error: ${error.message}</div>`;
        }
    }

    async function createReference(data, btn) {
        try {
            const title = `${data.term} (${data.source.toUpperCase()}) - Sense ${data.senseNumber}`;
            const source = data.source.toUpperCase();
            // Build entry URL based on source
            const entryUrl = source === 'MW'
                ? `https://www.merriam-webster.com/dictionary/${encodeURIComponent(data.term)}`
                : source === 'OED'
                    ? `https://www.oed.com/search/dictionary/?q=${encodeURIComponent(data.term)}`
                    : null;

            const response = await fetch('/upload/create_reference', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: title,
                    content: data.definition,
                    source: source,
                    source_type: 'dictionary',
                    term: data.term,
                    entry_url: entryUrl,
                    experiment_id: {{ experiment.id }},
                    include_in_analysis: true
                })
            });

            const result = await response.json();
            if (result.success) {
                // Add new reference to the list and auto-select it
                let refList = document.querySelector('.reference-list');
                const wordCount = data.definition.split(/\s+/).length;
                const newRefHtml = `
                    <div class="form-check reference-item mb-2">
                        <input class="form-check-input reference-checkbox" type="checkbox"
                               value="${result.document_id}" id="ref-${result.document_id}" checked>
                        <label class="form-check-label" for="ref-${result.document_id}">
                            <strong>${title}</strong>
                            <span class="text-muted">(${wordCount} words)</span>
                            <span class="badge bg-success ms-1">New</span>
                        </label>
                    </div>
                `;

                if (!refList) {
                    // No reference list yet - create one and replace the warning
                    const refColumn = document.querySelector('.reference-checkbox')?.closest('.col-md-6')
                                   || document.querySelector('#quick-add-reference')?.closest('.mb-3');
                    if (refColumn) {
                        const warning = refColumn.querySelector('.alert-warning');
                        if (warning) {
                            // Create the reference list container
                            const newList = document.createElement('div');
                            newList.className = 'reference-list border rounded p-3';
                            newList.style.maxHeight = '300px';
                            newList.style.overflowY = 'auto';
                            warning.replaceWith(newList);
                            refList = newList;
                        }
                    }
                }

                if (refList) {
                    refList.insertAdjacentHTML('afterbegin', newRefHtml);

                    // Show success feedback on the clicked button
                    if (btn) {
                        btn.classList.remove('btn-outline-success');
                        btn.classList.add('btn-success');
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        btn.disabled = true;
                    }
                } else {
                    // Fallback: reload page
                    window.location.reload();
                }
            } else {
                alert('Error creating reference: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error creating reference: ' + error.message);
        }
    }

    quickMwBtn.addEventListener('click', () => {
        const term = quickRefTerm.value.trim();
        if (!term) {
            alert('Please enter a term');
            return;
        }
        fetchDictionaryDefinitions(term, 'mw');
    });

    quickOedBtn.addEventListener('click', () => {
        const term = quickRefTerm.value.trim();
        if (!term) {
            alert('Please enter a term');
            return;
        }
        fetchDictionaryDefinitions(term, 'oed');
    });

    // Allow Enter key to trigger MW lookup
    quickRefTerm.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            quickMwBtn.click();
        }
    });
});
</script>
{% endblock %}
