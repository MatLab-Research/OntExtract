{% extends "base.html" %}

{% block title %}New Experiment Wizard - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <div class="row mt-4">
    <div class="col-12 col-lg-10 col-xl-9">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="mb-0">New Experiment Wizard</h3>
          <a class="btn btn-secondary" href="{{ url_for('experiments.index') }}">Back</a>
        </div>
        <div class="card-body">
          <form id="wizard-form">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" id="name" placeholder="e.g., Agent Domain Comparison" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Type</label>
              <select class="form-select" id="experiment_type">
                <option value="domain_comparison" selected>Domain Comparison</option>
                <option value="temporal_evolution">Temporal Evolution</option>
              </select>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <i class="fas fa-file-text text-primary"></i> Source Documents
                </label>
                <small class="text-muted d-block mb-2">Primary documents to analyze</small>
                <div class="border rounded p-2" style="max-height:220px; overflow:auto;">
                  {% if documents %}
                    {% for d in documents %}
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="{{ d.id }}" id="doc_{{ d.id }}"/>
                        <label class="form-check-label" for="doc_{{ d.id }}">
                          <span class="badge bg-primary badge-sm me-2">DOC</span>
                          <strong>{{ d.title or d.get_display_name() }}</strong>
                          {% if d.word_count %}
                          <span class="text-muted">({{ d.word_count }} words)</span>
                          {% endif %}
                          {% if d.created_at %}
                          <small class="text-muted d-block">
                            Uploaded: {{ d.created_at.strftime('%Y-%m-%d') }}
                          </small>
                          {% endif %}
                        </label>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="text-muted">
                      <i class="fas fa-info-circle"></i> No source documents available.
                      <a href="{{ url_for('text_input.upload_form') }}">Upload documents</a> first.
                    </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <i class="fas fa-book text-success"></i> References
                </label>
                <small class="text-muted d-block mb-2">Dictionary entries, papers, standards</small>
                <div class="border rounded p-2" style="max-height:220px; overflow:auto;">
                  {% if references %}
                    {% for r in references %}
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="{{ r.id }}" id="ref_{{ r.id }}"/>
                        <label class="form-check-label" for="ref_{{ r.id }}">
                          <span class="badge bg-success badge-sm me-2">REF</span>
                          <strong>{{ r.title or r.get_display_name() }}</strong>
                          {% if r.reference_subtype %}
                          <small class="badge bg-secondary badge-sm">{{ r.get_reference_subtype_display() }}</small>
                          {% endif %}
                          {% if r.word_count %}
                          <span class="text-muted">({{ r.word_count }} words)</span>
                          {% endif %}
                          {% if r.get_source_info() %}
                          <small class="text-muted d-block">{{ r.get_source_info() }}</small>
                          {% endif %}
                        </label>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="text-muted">
                      <i class="fas fa-info-circle"></i> No references available.
                      You can add references from the <a href="{{ url_for('references.index') }}">references section</a>.
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <hr/>
            <h5>Design (optional)</h5>
            <p class="text-muted">Simple facets from the Choi design paperâ€”fill what you need.</p>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Design Type</label>
                <select id="design_type" class="form-select">
                  <option value="">(none)</option>
                  <option value="experimental">Experimental</option>
                  <option value="quasi-experimental">Quasi-experimental</option>
                  <option value="survey">Survey</option>
                  <option value="observational">Observational</option>
                </select>
              </div>
              <div class="col-md-8 mb-3">
                <label class="form-label">Independent Variable (name | levels comma-separated)</label>
                <input type="text" class="form-control" id="iv_name" placeholder="definition_source" />
                <small class="text-muted">e.g., OED, AI textbook</small>
                <input type="text" class="form-control mt-2" id="iv_levels" placeholder="OED, AI textbook" />
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Groups (comma-separated)</label>
                <input type="text" class="form-control" id="groups" placeholder="OED, AI" />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Target Terms (comma-separated)</label>
                <input type="text" class="form-control" id="target_terms" placeholder="agent, agency" />
              </div>
            </div>

            <hr/>
            <!-- Temporal Evolution Configuration -->
            <div id="temporal-config-section" style="display: none;">
              <h5>Temporal Evolution Configuration</h5>
              <p class="text-muted">Configure semantic features for tracking term evolution across time and disciplines.</p>

              <div class="mb-3">
                <label for="focus-term" class="form-label">Focus Term *</label>
                <input type="text" class="form-control" id="focus-term"
                       placeholder="e.g., agent, knowledge, responsibility">
                <small class="text-muted">The term whose semantic evolution you want to track</small>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="start-year" class="form-label">Start Year</label>
                  <input type="number" class="form-control" id="start-year"
                         placeholder="e.g., 1850" min="1000" max="2024">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="end-year" class="form-label">End Year</label>
                  <input type="number" class="form-control" id="end-year"
                         placeholder="e.g., 2024" min="1000" max="2024">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="focus-disciplines" class="form-label">Focus Disciplines</label>
                  <input type="text" class="form-control" id="focus-disciplines"
                         placeholder="philosophy, law, AI">
                  <small class="text-muted">Comma-separated</small>
                </div>
              </div>

              <div class="mb-4">
                <label class="form-label">Semantic Features *</label>
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  Define the semantic features that will be analyzed for each document.
                  These create a "semantic fingerprint" to track meaning evolution.
                </div>

                <div id="semantic-features-list" class="mb-3">
                  <!-- Features will be added here dynamically -->
                </div>

                <button type="button" class="btn btn-sm btn-outline-primary" id="add-feature-btn">
                  <i class="fas fa-plus"></i> Add Semantic Feature
                </button>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Description (optional)</label>
              <textarea class="form-control" id="description" rows="2"></textarea>
            </div>

            <div class="d-flex gap-2">
              <button type="button" id="create-btn" class="btn btn-primary">Create Experiment</button>
              <a href="{{ url_for('experiments.create_sample') }}" class="btn btn-secondary">Create Sample</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Semantic features management
let featureCounter = 0;

function addSemanticFeature(name = '', description = '') {
  const featureId = `feature-${featureCounter++}`;
  const featureHtml = `
    <div class="card mb-2" id="${featureId}">
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <input type="text" class="form-control feature-name" placeholder="Feature name (e.g., intentionality)" value="${name}">
          </div>
          <div class="col-md-7">
            <input type="text" class="form-control feature-description" placeholder="Description (e.g., Does it involve intention?)" value="${description}">
          </div>
          <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-danger remove-feature-btn" data-feature-id="${featureId}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  document.getElementById('semantic-features-list').insertAdjacentHTML('beforeend', featureHtml);

  // Add remove handler
  document.querySelector(`#${featureId} .remove-feature-btn`).addEventListener('click', function() {
    document.getElementById(featureId).remove();
  });
}

// Show/hide temporal config based on experiment type
document.getElementById('experiment_type').addEventListener('change', function() {
  const temporalSection = document.getElementById('temporal-config-section');
  if (this.value === 'temporal_evolution') {
    temporalSection.style.display = 'block';
  } else {
    temporalSection.style.display = 'none';
  }
});

// Add semantic feature button
document.getElementById('add-feature-btn')?.addEventListener('click', function() {
  addSemanticFeature();
});

function buildConfig() {
  const cfg = {};
  const type = document.getElementById('experiment_type').value;

  if (type === 'domain_comparison') {
    cfg.use_references = true; // allow references-only runs
  } else if (type === 'temporal_evolution') {
    // Temporal evolution configuration
    const focusTerm = document.getElementById('focus-term')?.value.trim();
    const startYear = parseInt(document.getElementById('start-year')?.value) || null;
    const endYear = parseInt(document.getElementById('end-year')?.value) || null;
    const disciplinesStr = document.getElementById('focus-disciplines')?.value.trim();

    if (focusTerm) {
      cfg.focus_term_id = focusTerm;
    }

    cfg.temporal_scope = {
      start_year: startYear,
      end_year: endYear,
      focus_disciplines: disciplinesStr ? disciplinesStr.split(',').map(d => d.trim()).filter(Boolean) : []
    };

    // Collect semantic features
    const semanticFeatures = {};
    document.querySelectorAll('#semantic-features-list .card').forEach(card => {
      const name = card.querySelector('.feature-name').value.trim();
      const desc = card.querySelector('.feature-description').value.trim();
      if (name && desc) {
        semanticFeatures[name] = desc;
      }
    });

    if (Object.keys(semanticFeatures).length > 0) {
      cfg.semantic_features = semanticFeatures;
    }
  }

  const tterms = (document.getElementById('target_terms').value || '').split(',').map(s => s.trim()).filter(Boolean);
  if (tterms.length) cfg.target_terms = tterms;

  const designType = document.getElementById('design_type').value;
  const ivName = (document.getElementById('iv_name').value || '').trim();
  const ivLevels = (document.getElementById('iv_levels').value || '').split(',').map(s => s.trim()).filter(Boolean);
  const groups = (document.getElementById('groups').value || '').split(',').map(s => s.trim()).filter(Boolean);

  const design = {};
  if (designType) design.type = designType;
  if (ivName && ivLevels.length) {
    design.variables = { independent: [{ name: ivName, levels: ivLevels }] };
  }
  if (groups.length) {
    design.groups = groups.map(g => ({ name: g }));
  }
  if (Object.keys(design).length) cfg.design = design;
  return cfg;
}

document.getElementById('create-btn').addEventListener('click', async () => {
  const name = document.getElementById('name').value.trim();
  const experiment_type = document.getElementById('experiment_type').value;
  const description = document.getElementById('description').value;

  const document_ids = Array.from(document.querySelectorAll("input[id^='doc_']:checked")).map(x => parseInt(x.value));
  const reference_ids = Array.from(document.querySelectorAll("input[id^='ref_']:checked")).map(x => parseInt(x.value));
  const configuration = buildConfig();

  if (!name) { alert('Name is required'); return; }

  // Validate temporal evolution configuration
  if (experiment_type === 'temporal_evolution') {
    if (!configuration.focus_term_id) {
      alert('Please enter a focus term for temporal evolution experiment');
      return;
    }
    if (!configuration.semantic_features || Object.keys(configuration.semantic_features).length === 0) {
      alert('Please add at least one semantic feature for temporal evolution experiment');
      return;
    }
  }

  if ((!document_ids || document_ids.length === 0) && !(experiment_type === 'domain_comparison' && configuration.use_references && reference_ids.length > 0)) {
    alert('Select at least one document, or select references for a domain comparison.');
    return;
  }

  try {
  const res = await fetch("{{ url_for('experiments.create') }}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, experiment_type, description, document_ids, reference_ids, configuration })
    });
    const data = await res.json();
    if (res.ok && data.success) {
      window.location.href = `/experiments/${data.experiment_id}`;
    } else {
      alert('Error: ' + (data.error || res.statusText));
    }
  } catch (e) {
    alert('Failed to create experiment: ' + e.message);
  }
});
</script>
{% endblock %}
