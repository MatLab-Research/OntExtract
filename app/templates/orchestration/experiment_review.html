{% extends "base.html" %}

{% block title %}Review Strategy - {{ experiment.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Review Processing Strategy</h2>
                    <p class="text-muted mb-0">Experiment: {{ experiment.name }}</p>
                    {% if run.term_context %}
                    <p class="text-muted mb-0">Focus Term: <span class="badge bg-info">{{ run.term_context }}</span></p>
                    {% endif %}
                </div>
                <div>
                    <a href="{{ url_for('experiments.view', experiment_id=experiment.id) }}"
                       class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Experiment
                    </a>
                </div>
            </div>

            <!-- Experiment Goal -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bullseye me-2"></i>Experiment Goal
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0" style="white-space: pre-wrap;">{{ run.experiment_goal }}</p>
                </div>
            </div>

            <!-- LLM Analysis -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-brain me-2"></i>LLM Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h6>Confidence Score</h6>
                            {% set confidence_pct = (run.confidence * 100)|int %}
                            {% set confidence_color = 'success' if confidence_pct > 80 else ('warning' if confidence_pct > 60 else 'danger') %}
                            <div class="progress mb-3" style="height: 30px;">
                                <div class="progress-bar bg-{{ confidence_color }}" role="progressbar"
                                     style="width: {{ confidence_pct }}%;"
                                     aria-valuenow="{{ confidence_pct }}"
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ confidence_pct }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6>Strategic Reasoning</h6>
                    <div class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ run.strategy_reasoning }}</div>
                </div>
            </div>

            <!-- Recommended Strategy -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Recommended Processing Strategy
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Review the recommended tools for each document. You can modify the strategy before processing.
                    </p>

                    <div class="table-responsive">
                        <table class="table table-hover" id="strategy-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Document</th>
                                    <th style="width: 50%;">Recommended Tools</th>
                                    <th style="width: 20%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documents %}
                                <tr data-document-id="{{ doc.id }}">
                                    <td>
                                        <strong>{{ doc.title }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ doc.word_count|default(0)|int }} words
                                        </small>
                                    </td>
                                    <td>
                                        <div class="tool-badges" id="tools-{{ doc.id }}">
                                            {% set doc_tools = run.recommended_strategy.get(doc.id|string, []) %}
                                            {% if doc_tools %}
                                                {% for tool in doc_tools %}
                                                <span class="badge bg-primary me-1 mb-1 tool-badge" data-tool="{{ tool }}">
                                                    {{ tool }}
                                                    <i class="fas fa-times ms-1 remove-tool" style="cursor: pointer;" title="Remove tool"></i>
                                                </span>
                                                {% endfor %}
                                            {% else %}
                                                <span class="text-muted">No tools recommended</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary add-tool-btn"
                                                data-document-id="{{ doc.id }}">
                                            <i class="fas fa-plus me-1"></i>Add Tool
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Available Tools Reference -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-wrench me-2"></i>Available Processing Tools
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <span class="badge bg-secondary me-2">segment_paragraph</span>
                            <small>Segment into paragraphs</small>
                        </div>
                        <div class="col-md-4 mb-2">
                            <span class="badge bg-secondary me-2">segment_sentence</span>
                            <small>Segment into sentences</small>
                        </div>
                        <div class="col-md-4 mb-2">
                            <span class="badge bg-secondary me-2">extract_entities_spacy</span>
                            <small>Extract named entities</small>
                        </div>
                        <div class="col-md-4 mb-2">
                            <span class="badge bg-secondary me-2">extract_temporal</span>
                            <small>Extract time markers</small>
                        </div>
                        <div class="col-md-4 mb-2">
                            <span class="badge bg-secondary me-2">extract_causal</span>
                            <small>Extract causal relationships</small>
                        </div>
                        <div class="col-md-4 mb-2">
                            <span class="badge bg-secondary me-2">extract_definitions</span>
                            <small>Extract term definitions</small>
                        </div>
                        <div class="col-md-4 mb-2">
                            <span class="badge bg-secondary me-2">period_aware_embedding</span>
                            <small>Historical embeddings</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button id="cancel-btn" class="btn btn-lg btn-outline-danger">
                                <i class="fas fa-times me-2"></i>Cancel
                            </button>
                        </div>
                        <div>
                            <button id="approve-btn" class="btn btn-lg btn-success">
                                <i class="fas fa-check me-2"></i>Approve & Process
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Add Tool Modal -->
<div class="modal fade" id="addToolModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Processing Tool</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Select a tool to add to <strong id="modal-doc-name"></strong></p>
                <select class="form-select" id="tool-select">
                    <option value="">-- Select Tool --</option>
                    <option value="segment_paragraph">Segment into Paragraphs</option>
                    <option value="segment_sentence">Segment into Sentences</option>
                    <option value="extract_entities_spacy">Extract Named Entities (spaCy)</option>
                    <option value="extract_temporal">Extract Temporal Markers</option>
                    <option value="extract_causal">Extract Causal Relationships</option>
                    <option value="extract_definitions">Extract Term Definitions</option>
                    <option value="period_aware_embedding">Period-Aware Embeddings</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-add-tool">Add Tool</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Processing Experiment</h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong id="progress-stage">Initializing...</strong>
                </div>
                <div class="progress" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted" id="progress-details">Starting orchestration...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const runId = "{{ run.id }}";
const experimentId = {{ experiment.id }};
let currentDocumentId = null;
let modifiedStrategy = {{ run.recommended_strategy|tojson }};

// Available tools list
const availableTools = [
    'segment_paragraph',
    'segment_sentence',
    'extract_entities_spacy',
    'extract_temporal',
    'extract_causal',
    'extract_definitions',
    'period_aware_embedding'
];

// Handle remove tool
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-tool')) {
        const toolBadge = e.target.closest('.tool-badge');
        const toolName = toolBadge.dataset.tool;
        const documentId = toolBadge.closest('tr').dataset.documentId;

        // Remove from UI
        toolBadge.remove();

        // Remove from modified strategy
        modifiedStrategy[documentId] = modifiedStrategy[documentId].filter(t => t !== toolName);

        // Show message if no tools left
        const toolsContainer = document.getElementById(`tools-${documentId}`);
        if (toolsContainer.querySelectorAll('.tool-badge').length === 0) {
            toolsContainer.innerHTML = '<span class="text-muted">No tools selected</span>';
        }
    }
});

// Handle add tool button
document.querySelectorAll('.add-tool-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const documentId = this.dataset.documentId;
        const docName = this.closest('tr').querySelector('strong').textContent;

        currentDocumentId = documentId;
        document.getElementById('modal-doc-name').textContent = docName;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('addToolModal'));
        modal.show();
    });
});

// Confirm add tool
document.getElementById('confirm-add-tool').addEventListener('click', function() {
    const toolSelect = document.getElementById('tool-select');
    const selectedTool = toolSelect.value;

    if (!selectedTool) {
        alert('Please select a tool');
        return;
    }

    // Check if tool already added
    if (modifiedStrategy[currentDocumentId] && modifiedStrategy[currentDocumentId].includes(selectedTool)) {
        alert('This tool is already added to this document');
        return;
    }

    // Add to modified strategy
    if (!modifiedStrategy[currentDocumentId]) {
        modifiedStrategy[currentDocumentId] = [];
    }
    modifiedStrategy[currentDocumentId].push(selectedTool);

    // Update UI
    const toolsContainer = document.getElementById(`tools-${currentDocumentId}`);
    const noToolsMsg = toolsContainer.querySelector('.text-muted');
    if (noToolsMsg) {
        noToolsMsg.remove();
    }

    const toolBadge = document.createElement('span');
    toolBadge.className = 'badge bg-primary me-1 mb-1 tool-badge';
    toolBadge.dataset.tool = selectedTool;
    toolBadge.innerHTML = `
        ${selectedTool}
        <i class="fas fa-times ms-1 remove-tool" style="cursor: pointer;" title="Remove tool"></i>
    `;
    toolsContainer.appendChild(toolBadge);

    // Close modal and reset
    bootstrap.Modal.getInstance(document.getElementById('addToolModal')).hide();
    toolSelect.value = '';
});

// Cancel button
document.getElementById('cancel-btn').addEventListener('click', function() {
    if (confirm('Are you sure you want to cancel? You will return to the experiment page.')) {
        window.location.href = `/experiments/${experimentId}`;
    }
});

// Approve button
document.getElementById('approve-btn').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';

    try {
        // Submit approval with modified strategy
        const response = await fetch(`/orchestration/experiment/${runId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                approved: true,
                modified_strategy: modifiedStrategy,
                review_notes: 'User reviewed and approved strategy'
            })
        });

        const data = await response.json();

        if (data.success) {
            // Redirect to results page (which will show strategy and track processing via SSE)
            window.location.href = `/orchestration/experiment/${runId}/results`;
        } else {
            alert(`Error: ${data.error || 'Failed to approve strategy'}`);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Approve & Process';
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Approve & Process';
    }
});

// SSE Progress Tracking
function startProgressTracking(runId) {
    const eventSource = new EventSource(`/orchestration/experiment/${runId}/status`);

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.heartbeat) {
            // Just a keepalive, ignore
            return;
        }

        // Update progress UI
        if (data.stage) {
            document.getElementById('progress-stage').textContent = getStageLabel(data.stage);
        }

        if (data.progress !== undefined) {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${data.progress}%`;
            progressBar.textContent = `${data.progress}%`;
            progressBar.setAttribute('aria-valuenow', data.progress);
        }

        if (data.message) {
            document.getElementById('progress-details').textContent = data.message;
        }

        // Handle completion
        if (data.status === 'completed') {
            eventSource.close();
            setTimeout(() => {
                window.location.href = `/orchestration/experiment/${runId}/results`;
            }, 1000);
        }

        // Handle error
        if (data.status === 'failed') {
            eventSource.close();
            alert(`Processing failed: ${data.error || 'Unknown error'}`);
            window.location.href = `/experiments/${experimentId}`;
        }
    };

    eventSource.onerror = function(error) {
        console.error('SSE error:', error);
        eventSource.close();
        alert('Connection lost. Please check the experiment page for status.');
        window.location.href = `/experiments/${experimentId}`;
    };
}

function getStageLabel(stage) {
    const labels = {
        'analyzing': 'Analyzing Experiment',
        'recommending': 'Recommending Strategy',
        'reviewing': 'Awaiting Review',
        'executing': 'Processing Documents',
        'synthesizing': 'Synthesizing Results',
        'completed': 'Complete'
    };
    return labels[stage] || stage;
}
</script>

{% endblock %}
