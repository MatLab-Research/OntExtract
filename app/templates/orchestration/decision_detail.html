{% extends "base.html" %}

{% block title %}Decision Detail: {{ decision.term_text }} - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-robot me-2"></i>Orchestration Decision Detail
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="{{ url_for('orchestration_feedback.dashboard') }}">Orchestration</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{{ url_for('orchestration_feedback.decisions') }}">Decisions</a>
                            </li>
                            <li class="breadcrumb-item active">{{ decision.term_text }}</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                        <i class="fas fa-comment me-2"></i>Provide Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Decision Information -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Decision Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Details</h6>
                            <dl class="row">
                                <dt class="col-sm-4">Term:</dt>
                                <dd class="col-sm-8"><strong>{{ decision.term_text }}</strong></dd>
                                
                                <dt class="col-sm-4">Decision ID:</dt>
                                <dd class="col-sm-8"><small class="font-monospace">{{ decision.id }}</small></dd>
                                
                                <dt class="col-sm-4">Confidence:</dt>
                                <dd class="col-sm-8">
                                    {% if decision.decision_confidence %}
                                        <span class="badge bg-{{ 'success' if decision.decision_confidence > 0.8 else 'warning' if decision.decision_confidence > 0.6 else 'danger' }}">
                                            {{ "%.0f" | format(decision.decision_confidence * 100) }}%
                                        </span>
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">Created:</dt>
                                <dd class="col-sm-8">{{ decision.created_at.strftime('%Y-%m-%d %H:%M:%S') if decision.created_at else 'Unknown' }}</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6>Processing Details</h6>
                            <dl class="row">
                                <dt class="col-sm-5">Tools Selected:</dt>
                                <dd class="col-sm-7">
                                    {% if decision.selected_tools %}
                                        {% for tool in decision.selected_tools %}
                                            <span class="badge bg-secondary me-1">{{ tool }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-5">Embedding Model:</dt>
                                <dd class="col-sm-7">
                                    {% if decision.embedding_model %}
                                        <code>{{ decision.embedding_model }}</code>
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-5">Strategy:</dt>
                                <dd class="col-sm-7">{{ decision.processing_strategy or 'Not specified' }}</dd>
                                
                                <dt class="col-sm-5">Runtime:</dt>
                                <dd class="col-sm-7">
                                    {% if decision.actual_runtime_seconds %}
                                        {{ decision.actual_runtime_seconds }}s
                                        {% if decision.expected_runtime_seconds %}
                                            (expected: {{ decision.expected_runtime_seconds }}s)
                                        {% endif %}
                                    {% else %}
                                        Not recorded
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Context -->
            {% if decision.input_metadata %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Input Context
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for key, value in decision.input_metadata.items() %}
                        <div class="col-md-4 mb-2">
                            <strong>{{ key.replace('_', ' ').title() }}:</strong>
                            <br>
                            {% if key in ['year'] and value is number %}
                                {{ value }}
                            {% elif value is string %}
                                {{ value }}
                            {% else %}
                                {{ value }}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Reasoning -->
            {% if decision.reasoning_summary or decision.decision_factors %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-brain me-2"></i>LLM Reasoning
                    </h5>
                </div>
                <div class="card-body">
                    {% if decision.reasoning_summary %}
                    <h6>Summary</h6>
                    <p>{{ decision.reasoning_summary }}</p>
                    {% endif %}

                    {% if decision.decision_factors %}
                    <h6>Decision Factors</h6>
                    <div class="accordion" id="reasoningAccordion">
                        {% for factor_key, factor_value in decision.decision_factors.items() %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                    {{ factor_key.replace('_', ' ').title() }}
                                </button>
                            </h2>
                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#reasoningAccordion">
                                <div class="accordion-body">
                                    {% if factor_value is mapping %}
                                        <pre class="bg-light p-2 rounded"><code>{{ factor_value | tojson(indent=2) }}</code></pre>
                                    {% else %}
                                        {{ factor_value }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Status Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Status Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary">{{ existing_feedback | length }}</h4>
                                <small class="text-muted">Feedback Entries</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">{{ decision.manual_overrides | length if decision.manual_overrides else 0 }}</h4>
                            <small class="text-muted">Manual Overrides</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Applicable Learning Patterns -->
            {% if applicable_patterns %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Applicable Patterns
                    </h5>
                </div>
                <div class="card-body">
                    {% for pattern in applicable_patterns %}
                    <div class="border-bottom pb-2 mb-2">
                        <h6 class="mb-1">{{ pattern.pattern_name }}</h6>
                        <small class="text-muted">{{ pattern.pattern_type | title }}</small>
                        <div class="mt-1">
                            <span class="badge bg-primary">{{ "%.0f" | format(pattern.confidence * 100) }}% confidence</span>
                            {% if pattern.success_rate %}
                                <span class="badge bg-success">{{ "%.0f" | format(pattern.success_rate * 100) }}% success</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tools me-2"></i>Actions
                    </h5>
                </div>
                <div class="card-body d-grid gap-2">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                        <i class="fas fa-comment me-2"></i>Provide Feedback
                    </button>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#overrideModal">
                        <i class="fas fa-user-cog me-2"></i>Manual Override
                    </button>
                    {% if decision.experiment_id %}
                    <a href="{{ url_for('experiments.view', experiment_id=decision.experiment_id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-flask me-2"></i>View Experiment
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Feedback -->
    {% if existing_feedback %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>Existing Feedback ({{ existing_feedback | length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% for feedback in existing_feedback %}
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ feedback.feedback_type | title }} Feedback</strong>
                                <span class="badge bg-{{ 'success' if feedback.agreement_level in ['agree', 'strongly_agree'] else 'warning' if feedback.agreement_level == 'neutral' else 'danger' }}">
                                    {{ feedback.agreement_level.replace('_', ' ').title() }}
                                </span>
                            </div>
                            <small class="text-muted">{{ feedback.provided_at.strftime('%Y-%m-%d %H:%M') if feedback.provided_at else 'Unknown' }}</small>
                        </div>
                        <div class="card-body">
                            <p>{{ feedback.reasoning }}</p>
                            {% if feedback.suggested_tools %}
                            <div class="mt-2">
                                <strong>Suggested Tools:</strong>
                                {% for tool in feedback.suggested_tools %}
                                    <span class="badge bg-info me-1">{{ tool }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Provide Detailed Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="detailedFeedbackForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="feedbackType" class="form-label">Feedback Type</label>
                            <select class="form-select" id="feedbackType" required>
                                <option value="">Choose...</option>
                                <option value="assessment">Assessment</option>
                                <option value="correction">Correction</option>
                                <option value="enhancement">Enhancement</option>
                                <option value="validation">Validation</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="agreementLevel" class="form-label">Agreement Level</label>
                            <select class="form-select" id="agreementLevel" required>
                                <option value="">Choose...</option>
                                <option value="strongly_agree">Strongly Agree</option>
                                <option value="agree">Agree</option>
                                <option value="neutral">Neutral</option>
                                <option value="disagree">Disagree</option>
                                <option value="strongly_disagree">Strongly Disagree</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="feedbackReasoning" class="form-label">Detailed Reasoning</label>
                        <textarea class="form-control" id="feedbackReasoning" rows="4" 
                                  placeholder="Provide detailed explanation of your assessment..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="confidenceAssessment" class="form-label">Confidence in Your Assessment</label>
                        <select class="form-select" id="confidenceAssessment">
                            <option value="0.95">Very High (95%)</option>
                            <option value="0.9">High (90%)</option>
                            <option value="0.8" selected>Moderate (80%)</option>
                            <option value="0.7">Low (70%)</option>
                            <option value="0.5">Very Low (50%)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitDetailedFeedback()">Submit Feedback</button>
            </div>
        </div>
    </div>
</div>

<!-- Override Modal -->
<div class="modal fade" id="overrideModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manual Override</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="overrideForm">
                    <div class="mb-3">
                        <label for="overrideType" class="form-label">Override Type</label>
                        <select class="form-select" id="overrideType" required>
                            <option value="">Choose...</option>
                            <option value="tool_replacement">Replace Selected Tools</option>
                            <option value="model_change">Change Embedding Model</option>
                            <option value="full_replacement">Complete Replacement</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="overrideJustification" class="form-label">Justification</label>
                        <textarea class="form-control" id="overrideJustification" rows="4" 
                                  placeholder="Explain why this override is necessary based on your domain expertise..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitOverride()">Apply Override</button>
            </div>
        </div>
    </div>
</div>

<script>
function submitDetailedFeedback() {
    const feedbackType = document.getElementById('feedbackType').value;
    const agreementLevel = document.getElementById('agreementLevel').value;
    const reasoning = document.getElementById('feedbackReasoning').value;
    const confidenceAssessment = parseFloat(document.getElementById('confidenceAssessment').value);
    
    if (!feedbackType || !agreementLevel || !reasoning) {
        alert('Please fill in all required fields');
        return;
    }
    
    fetch(`/orchestration/decisions/{{ decision.id }}/feedback`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            feedback_type: feedbackType,
            feedback_scope: 'overall_decision', 
            agreement_level: agreementLevel,
            reasoning: reasoning,
            confidence_assessment: confidenceAssessment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
            location.reload();
        } else {
            alert('Error submitting feedback: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting feedback');
    });
}

function submitOverride() {
    const overrideType = document.getElementById('overrideType').value;
    const justification = document.getElementById('overrideJustification').value;
    
    if (!overrideType || !justification) {
        alert('Please fill in all required fields');
        return;
    }
    
    fetch(`/orchestration/decisions/{{ decision.id }}/override`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            override_type: overrideType,
            justification: justification,
            expert_knowledge_applied: {
                'manual_override': true,
                'expertise_level': 'domain_expert'
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            bootstrap.Modal.getInstance(document.getElementById('overrideModal')).hide();
            location.reload();
        } else {
            alert('Error submitting override: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting override');
    });
}
</script>
{% endblock %}