{% extends "base.html" %}

{% block title %}Experiment Results - {{ experiment.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Experiment Analysis Results</h2>
                    <p class="text-muted mb-0">{{ experiment.name }}</p>
                    {% if run.term_context %}
                    <p class="text-muted mb-0">
                        Focus Term: <span class="badge bg-info">{{ run.term_context }}</span>
                    </p>
                    {% endif %}
                </div>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                    <a href="{{ url_for('experiments.view', experiment_id=experiment.id) }}"
                       class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Experiment
                    </a>
                </div>
            </div>

            <!-- Processing Status Banner (shown if still processing) -->\n            {% if run.status in ['processing', 'strategy_ready'] %}
            <div class="alert alert-info" id="processing-banner">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-3" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <div>
                        <strong id="processing-stage">Processing Documents...</strong>
                        <div class="progress mt-2" style="height: 20px; width: 400px;">
                            <div id="processing-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <small class="text-muted mt-1" id="processing-details">Starting...</small>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Processing Summary -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>Processing Complete
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <small class="text-muted">Documents Processed</small><br>
                            <strong class="fs-4">{{ documents|length }}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Started</small><br>
                            <strong>{{ run.started_at.strftime('%Y-%m-%d %H:%M') if run.started_at else 'N/A' }}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Completed</small><br>
                            <strong>{{ run.completed_at.strftime('%Y-%m-%d %H:%M') if run.completed_at else 'N/A' }}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Status</small><br>
                            <span class="badge bg-success">{{ run.status|upper }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Term Evolution Analysis (if focus term exists) -->
            {% if run.term_evolution_analysis %}
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Term Evolution Analysis: "{{ run.term_context }}"
                    </h5>
                </div>
                <div class="card-body">
                    <div class="bg-light p-4 rounded" style="white-space: pre-wrap; line-height: 1.8;">{{ run.term_evolution_analysis }}</div>
                </div>
            </div>
            {% endif %}

            <!-- Cross-Document Insights -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Cross-Document Insights
                    </h5>
                </div>
                <div class="card-body">
                    {% if run.cross_document_insights %}
                    <div class="bg-light p-4 rounded" style="white-space: pre-wrap; line-height: 1.8;">{{ run.cross_document_insights }}</div>
                    {% else %}
                    <p class="text-muted mb-0">No cross-document insights available.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Comparative Summary -->
            {% if run.comparative_summary %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-balance-scale me-2"></i>Comparative Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="bg-light p-4 rounded" style="white-space: pre-wrap; line-height: 1.8;">{{ run.comparative_summary }}</div>
                </div>
            </div>
            {% endif %}

            <!-- Per-Document Results -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Per-Document Results
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Expand each document to see detailed processing results.</p>

                    <div class="accordion" id="documentsAccordion">
                        {% for doc in documents %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapse{{ loop.index }}"
                                        aria-expanded="false"
                                        aria-controls="collapse{{ loop.index }}">
                                    <i class="fas fa-file-alt me-2"></i>
                                    <strong>{{ doc.title }}</strong>
                                    <span class="ms-3 text-muted">
                                        {% if run.recommended_strategy and run.recommended_strategy.get(doc.id|string) %}
                                        <small>
                                            Tools:
                                            {% for tool in run.recommended_strategy.get(doc.id|string, []) %}
                                                <span class="badge bg-secondary">{{ tool }}</span>
                                            {% endfor %}
                                        </small>
                                        {% endif %}
                                    </span>
                                </button>
                            </h2>
                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse"
                                 aria-labelledby="heading{{ loop.index }}"
                                 data-bs-parent="#documentsAccordion">
                                <div class="accordion-body">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <small class="text-muted">Word Count</small><br>
                                            <strong>{{ doc.word_count|default(0)|int|string|wordcount }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">File Type</small><br>
                                            <strong>{{ doc.file_type|upper }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Created</small><br>
                                            <strong>{{ doc.created_at.strftime('%Y-%m-%d') if doc.created_at else 'N/A' }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <a href="{{ url_for('text_input.document_detail', document_id=doc.id) }}"
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye me-1"></i>View Document
                                            </a>
                                        </div>
                                    </div>

                                    {% if run.processing_results and run.processing_results.get(doc.id|string) %}
                                    <h6>Processing Results:</h6>
                                    <div class="bg-light p-3 rounded">
                                        <pre class="mb-0" style="white-space: pre-wrap;">{{ run.processing_results.get(doc.id|string)|tojson(indent=2) }}</pre>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        No processing results available for this document.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Execution Trace (Provenance) -->
            {% if run.execution_trace %}
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Execution Trace (PROV-O)
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Complete provenance record for reproducibility.</p>

                    <div class="timeline">
                        {% for entry in run.execution_trace %}
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ loop.index }}. {{ entry.activity|default('Processing Step') }}</strong>
                                    <br>
                                    <small class="text-muted">{{ entry.timestamp|default('N/A') }}</small>
                                </div>
                                {% if entry.status %}
                                <span class="badge bg-{{ 'success' if entry.status == 'completed' else 'warning' }}">
                                    {{ entry.status|upper }}
                                </span>
                                {% endif %}
                            </div>
                            {% if entry.details %}
                            <div class="mt-2 ms-3">
                                <small class="text-muted">{{ entry.details }}</small>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Strategy Used -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Strategy Used
                    </h5>
                </div>
                <div class="card-body">
                    {% if run.modified_strategy %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Modified Strategy:</strong> User reviewed and modified the recommended strategy before processing.
                    </div>
                    {% endif %}

                    <h6>LLM Reasoning:</h6>
                    <div class="bg-light p-3 rounded mb-3" style="white-space: pre-wrap;">{{ run.strategy_reasoning }}</div>

                    <h6>Confidence Score:</h6>
                    {% set confidence_pct = (run.confidence * 100)|int %}
                    {% set confidence_color = 'success' if confidence_pct > 80 else ('warning' if confidence_pct > 60 else 'danger') %}
                    <div class="progress mb-3" style="height: 30px;">
                        <div class="progress-bar bg-{{ confidence_color }}" role="progressbar"
                             style="width: {{ confidence_pct }}%;"
                             aria-valuenow="{{ confidence_pct }}"
                             aria-valuemin="0" aria-valuemax="100">
                            {{ confidence_pct }}%
                        </div>
                    </div>

                    <h6>Strategy Details:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th>Tools Applied</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documents %}
                                <tr>
                                    <td>{{ doc.title }}</td>
                                    <td>
                                        {% set strategy = run.modified_strategy if run.modified_strategy else run.recommended_strategy %}
                                        {% set doc_tools = strategy.get(doc.id|string, []) %}
                                        {% if doc_tools %}
                                            {% for tool in doc_tools %}
                                                <span class="badge bg-primary me-1">{{ tool }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No tools</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">
                        <i class="fas fa-download me-2"></i>Export Results
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="exportJSON()">
                            <i class="fas fa-file-code me-2"></i>Export as JSON
                        </button>
                        <button class="btn btn-outline-success" onclick="window.print()">
                            <i class="fas fa-file-pdf me-2"></i>Export as PDF (Print)
                        </button>
                        <a href="{{ url_for('experiments.view', experiment_id=experiment.id) }}"
                           class="btn btn-primary">
                            <i class="fas fa-flask me-2"></i>Back to Experiment
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
const runData = {{ run.to_dict()|tojson }};

function exportJSON() {
    const dataStr = JSON.stringify(runData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `experiment_${runData.experiment_id}_results.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// Custom filter for word count formatting
function formatWordCount(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// SSE tracking for document processing
const runStatus = "{{ run.status }}";
const runId = "{{ run.id }}";

if (runStatus === 'processing' || runStatus === 'strategy_ready') {
    // Connect to SSE for processing updates
    const eventSource = new EventSource(`/orchestration/experiment/${runId}/status`);

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.heartbeat) {
            return; // Ignore keepalive
        }

        // Update progress UI
        if (data.stage) {
            document.getElementById('processing-stage').textContent = getStageLabel(data.stage);
        }

        if (data.progress !== undefined) {
            const progressBar = document.getElementById('processing-progress-bar');
            progressBar.style.width = `${data.progress}%`;
            progressBar.textContent = `${data.progress}%`;
            progressBar.setAttribute('aria-valuenow', data.progress);
        }

        if (data.message) {
            document.getElementById('processing-details').textContent = data.message;
        }

        // Handle completion
        if (data.status === 'completed') {
            eventSource.close();
            // Reload page to show final results
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // Handle error
        if (data.status === 'failed') {
            eventSource.close();
            document.getElementById('processing-banner').classList.remove('alert-info');
            document.getElementById('processing-banner').classList.add('alert-danger');
            document.getElementById('processing-stage').textContent = 'Processing Failed';
            document.getElementById('processing-details').textContent = data.error || 'Unknown error';
        }
    };

    eventSource.onerror = function(error) {
        console.error('SSE error:', error);
        eventSource.close();
    };
}

function getStageLabel(stage) {
    const labels = {
        'processing': 'Processing Documents',
        'synthesizing': 'Synthesizing Results',
        'completed': 'Complete'
    };
    return labels[stage] || stage;
}
</script>

{% endblock %}
