{% extends "base.html" %}

{% block title %}Edit {{ term.term_text }} - OntExtract{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Edit Term: {{ term.term_text }}
                    </h3>
                    <p class="text-muted mb-0">Edit research domain, status, and notes</p>
                    
                    <!-- Version Selector -->
                    {% if versions|length > 0 %}
                    <div class="mt-3">
                        <div class="d-flex align-items-center">
                            <label for="version-selector" class="form-label mb-0 me-2">
                                <strong>Current Version Data:</strong>
                            </label>
                            <select id="version-selector" class="form-select form-select-sm" style="width: auto;" onchange="selectVersion()">
                                {% for version in versions %}
                                <option value="{{ version.id }}" 
                                        {% if selected_version and version.id == selected_version.id %}selected{% endif %}>
                                    {{ version.temporal_period }}
                                    {% if version.is_current %}(Current){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        {% if selected_version %}
                        <div class="mt-2 p-2 bg-light rounded">
                            <small class="text-muted">
                                <strong>Version Details:</strong> 
                                Created {{ selected_version.generated_at_time.strftime('%b %d, %Y') }}
                                {% if selected_version.confidence_level %}
                                    â€¢ Confidence: <span class="badge bg-secondary fs-6">{{ selected_version.confidence_level }}</span>
                                {% endif %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('terms.edit_term', term_id=term.id) }}">
                        {{ form.hidden_tag() }}

                        <!-- Term Text (Read-Only) -->
                        <div class="mb-3">
                            {{ form.term_text.label(class="form-label") }}
                            {{ form.term_text(class="form-control-plaintext") }}
                            <small class="form-text text-muted">Term text cannot be changed</small>
                        </div>

                        <!-- Research Domain -->
                        <div class="mb-3">
                            {{ form.research_domain.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.research_domain(class="form-control" + (" is-invalid" if form.research_domain.errors else ""), list="research-domain-options", autocomplete="on") }}
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Choose from existing domains or add a new one">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                            {% if form.research_domain.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.research_domain.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Research domain or field of study (e.g., Philosophy, Science, Politics)</div>

                            <!-- Research domain options (existing + predefined) -->
                            <datalist id="research-domain-options">
                                <!-- Existing domains from database -->
                                {% for domain in existing_domains %}
                                <option value="{{ domain }}">
                                {% endfor %}

                                <!-- Predefined domain suggestions -->
                                {% set predefined_domains = [
                                    'Anthropology',
                                    'Artificial Intelligence',
                                    'Biology',
                                    'Business',
                                    'Chemistry',
                                    'Computer Science',
                                    'Economics',
                                    'Education',
                                    'Engineering',
                                    'Engineering Ethics',
                                    'Environmental Science',
                                    'Geography',
                                    'History',
                                    'Information Science',
                                    'Law',
                                    'Linguistics',
                                    'Literature',
                                    'Mathematics',
                                    'Medicine',
                                    'Music',
                                    'Philosophy',
                                    'Physics',
                                    'Political Science',
                                    'Psychology',
                                    'Religion',
                                    'Science',
                                    'Sociology'
                                ] %}
                                {% for domain in predefined_domains %}
                                    {% if domain not in existing_domains %}
                                <option value="{{ domain }}">
                                    {% endif %}
                                {% endfor %}
                            </datalist>
                        </div>

                        <!-- Version-Specific Data (Read-Only Display) -->
                        {% if selected_version %}
                        <div class="mb-4">
                            <hr class="my-4">

                            <!-- Meaning Description from Version -->
                            <div class="mb-3">
                                <label class="form-label"><strong>Meaning Description</strong></label>
                                <div class="p-3 bg-light border rounded">
                                    {{ selected_version.meaning_description }}
                                </div>
                                <small class="form-text text-muted">This is the meaning for the {{ selected_version.temporal_period }} period</small>
                            </div>
                            
                            <!-- Additional Version Info -->
                            <div class="row">
                                {% if selected_version.corpus_source %}
                                <div class="col-md-6 mb-2">
                                    <strong>Corpus Source:</strong> {{ selected_version.corpus_source }}
                                </div>
                                {% endif %}
                                {% if selected_version.fuzziness_score %}
                                <div class="col-md-6 mb-2">
                                    <strong>Fuzziness Score:</strong> {{ "%.3f"|format(selected_version.fuzziness_score) }}
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if selected_version.context_anchor %}
                            <div class="mb-2">
                                <strong>Context Anchors:</strong> 
                                <span class="text-muted">{{ selected_version.context_anchor|join(', ') }}</span>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <!-- No versions available -->
                        <div class="mb-4">
                            <hr class="my-4">
                            <div class="text-center py-3">
                                <i class="fas fa-clock fa-2x text-muted mb-2"></i>
                                <h6>No Temporal Versions</h6>
                                <p class="text-muted">This term doesn't have any temporal versions yet.</p>
                                <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="tooltip-light" title="Coming soon">
                                    <button class="btn btn-secondary btn-sm" disabled style="pointer-events: none;">
                                        <i class="fas fa-plus me-1"></i>Add First Version
                                    </button>
                                </span>
                            </div>
                        </div>
                        {% endif %}

                        <hr class="my-4">

                        <!-- Status -->
                        <div class="mb-3">
                            {{ form.status.label(class="form-label") }}
                            {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.status.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows="3") }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="{{ url_for('terms.view_term', term_id=term.id) }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Cancel
                                </a>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Note about versions -->
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> You can edit the research domain, status, and notes for this term. Version-specific data (meaning descriptions, temporal periods, etc.) is shown for reference. To modify version data or create new versions, use the "Add Version" feature from the term details page.
            </div>
        </div>
    </div>
</div>

<script>
function selectVersion() {
    const selector = document.getElementById('version-selector');
    const selectedVersionId = selector.value;
    
    if (selectedVersionId) {
        // Reload the page with the selected version
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('version_id', selectedVersionId);
        window.location.href = currentUrl.toString();
    }
}

// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

{% endblock %}