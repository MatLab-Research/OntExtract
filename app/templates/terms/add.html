{% extends "base.html" %}

{% block title %}Add New Term - OntExtract{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        Add New Term
                    </h3>
                    <p class="text-muted mb-0">Create a new anchor term for semantic change analysis</p>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('terms.add_term') }}">
                        {{ form.hidden_tag() }}
                        
                        <!-- Term Text (MOST IMPORTANT FIELD - ALWAYS VISIBLE) -->
                        <div class="mb-4 p-3 bg-light border rounded">
                            <div class="mb-2">
                                <h5 class="mb-1">{{ form.term_text.label(class="form-label") }}</h5>
                                <small class="text-muted">Enter the term manually or use the options below to search and auto-populate</small>
                            </div>
                            {{ form.term_text(class="form-control form-control-lg" + (" is-invalid" if form.term_text.errors else "")) }}
                            {% if form.term_text.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.term_text.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">The word or phrase you want to analyze for semantic change</div>
                        </div>
                        
                        <!-- Anchoring Methods -->
                        <div class="mb-4">
                            <!-- Tab Navigation -->
                            <ul class="nav nav-tabs mb-3" id="anchorTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="services-tab" data-bs-toggle="tab" data-bs-target="#services-pane" type="button" role="tab">
                                        <i class="fas fa-cloud me-1"></i> Connected Services
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-pane" type="button" role="tab">
                                        <i class="fas fa-keyboard me-1"></i> Manual Entry
                                    </button>
                                </li>
                                <!-- Reference Document tab disabled for JCDL presentation
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="reference-tab" data-bs-toggle="tab" data-bs-target="#reference-pane" type="button" role="tab">
                                        <i class="fas fa-file-text me-1"></i> Reference Document
                                    </button>
                                </li>
                                -->
                            </ul>
                            
                            <!-- Tab Content -->
                            <div class="tab-content" id="anchorTabContent">

                                <!-- Connected Services Tab (Default) -->
                                <div class="tab-pane fade show active" id="services-pane" role="tabpanel">
                                    <!-- Info: Anchor Term -->
                                    <div class="mb-3">
                                        <a class="text-decoration-none" data-bs-toggle="collapse" href="#anchorTermHelp" role="button" aria-expanded="false" aria-controls="anchorTermHelp">
                                            <i class="fas fa-info-circle text-primary"></i>
                                            <span class="text-primary ms-2">Anchor Term</span>
                                        </a>

                                        <div class="collapse" id="anchorTermHelp">
                                            <div class="alert alert-primary mt-2 mb-0">
                                                <p class="mb-2">
                                                    Select a term definition from an authoritative source (OED, Merriam-Webster, WordNet)
                                                    to establish your <strong>anchor term</strong> - a current/modern reference point that serves as a "mile marker"
                                                    for where your semantic change analysis begins. This anchor provides a stable, well-documented starting point.
                                                </p>
                                                <p class="mb-0">
                                                    <strong>Timeline Analysis:</strong> After creating your anchor term, use the Experiments section to track
                                                    semantic evolution over time and discover how meaning has changed across different historical periods.
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Service Selection -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-book fa-2x text-danger mb-2"></i>
                                                    <h6>Merriam-Webster Dictionary</h6>
                                                    <p class="small text-muted">Authoritative American English definitions</p>
                                                    <button type="button" class="btn btn-outline-danger btn-sm" id="mw-dict-service-btn">
                                                        Search Dictionary
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-list-alt fa-2x text-secondary mb-2"></i>
                                                    <h6>Merriam-Webster Thesaurus</h6>
                                                    <p class="small text-muted">Synonyms and antonyms for context anchoring</p>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="mw-thes-service-btn">
                                                        Search Thesaurus
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-book fa-2x text-warning mb-2"></i>
                                                    <h6>Oxford English Dictionary</h6>
                                                    <p class="small text-muted">Authoritative English language definitions</p>
                                                    <button type="button" class="btn btn-outline-warning btn-sm" id="oed-service-btn">
                                                        Search OED
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-sitemap fa-2x text-success mb-2"></i>
                                                    <h6>WordNet</h6>
                                                    <p class="small text-muted">Lexical database with semantic relationships</p>
                                                    <button type="button" class="btn btn-outline-success btn-sm" id="wordnet-service-btn">
                                                        Search WordNet
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    <!-- Service Results -->
                                    <div id="service-results" class="mt-3" style="display: none;">
                                        <div class="border rounded p-3 bg-light">
                                            <div id="service-results-content">
                                                <!-- Service search results will appear here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Manual Entry Tab -->
                                <div class="tab-pane fade" id="manual-pane" role="tabpanel">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Manual Entry:</strong> Enter term information manually. Use the fields below to specify the term, meaning, and related context.
                                    </div>
                                    
                                    <!-- Source Type -->
                                    <div class="mt-3">
                                        <label class="form-label">Source Type</label>
                                        <select class="form-select" id="manual-source-type">
                                            <option value="">Select source type...</option>
                                            <option value="corpus">Corpus</option>
                                            <option value="dictionary">Dictionary</option>
                                            <option value="standard">Technical Standard</option>
                                            <option value="academic">Academic Publication</option>
                                            <option value="government">Government Document</option>
                                            <option value="industry">Industry Specification</option>
                                        </select>
                                        <div class="form-text">The actual source name will be in the Source Citation field below</div>
                                    </div>
                                </div>

                                <!-- Reference Document Tab - Disabled for JCDL Presentation
                                <div class="tab-pane fade" id="reference-pane" role="tabpanel">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Reference Document:</strong> Use a document from your collection as the contextual anchor.
                                    </div>

                                    <label class="form-label">Reference Document *</label>
                                    <select class="form-select" id="anchor-document-select">
                                        <option value="">Select a document from your collection...</option>
                                        {% for doc in documents %}
                                        <option value="{{ doc.id }}" data-title="{{ doc.title }}" data-type="{{ doc.document_type or 'document' }}">
                                            {{ doc.title }}
                                            {% if doc.author %} - {{ doc.author }}{% endif %}
                                            {% if doc.year %} ({{ doc.year }}){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text mb-3">Choose a document from your collection to provide contextual anchoring</div>

                                    {% if not documents %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>No documents found.</strong>
                                        <a href="{{ url_for('upload.unified') }}" class="alert-link">Upload documents</a>
                                        to use them as reference sources.
                                    </div>
                                    {% endif %}

                                    <div class="mt-3">
                                        <div class="alert alert-info">
                                            <i class="fas fa-magic me-2"></i>
                                            <strong>Automatic Processing:</strong> Once you select a document, the system will automatically analyze it to extract relevant terms and context.
                                        </div>
                                    </div>
                                </div>
                                -->
                                
                            </div> <!-- End tab-content -->
                        </div>

                        <!-- Meaning Description -->
                        <div class="mb-3">
                            {{ form.meaning_description.label(class="form-label") }}
                            {{ form.meaning_description(class="form-control" + (" is-invalid" if form.meaning_description.errors else ""), rows="4") }}
                            {% if form.meaning_description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.meaning_description.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Describe the current or baseline meaning of this term</div>
                        </div>

                        <!-- Context Anchors -->
                        <div class="mb-3">
                            {{ form.context_anchor.label(class="form-label") }}
                            {{ form.context_anchor(class="form-control" + (" is-invalid" if form.context_anchor.errors else "")) }}
                            {% if form.context_anchor.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.context_anchor.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Related terms that help anchor this meaning (comma-separated)</div>
                        </div>

                        <!-- Source Citation -->
                        <div class="mb-3">
                            {{ form.source_citation.label(class="form-label") }} *
                            {{ form.source_citation(class="form-control" + (" is-invalid" if form.source_citation.errors else "")) }}
                            {% if form.source_citation.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.source_citation.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Provide the authoritative source for this term definition (required for PROV-O compliance)</div>
                        </div>

                        <!-- Research Domain -->
                        <div class="mb-3">
                            {{ form.research_domain.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.research_domain(class="form-control" + (" is-invalid" if form.research_domain.errors else ""), list="research-domain-options", autocomplete="on") }}
                                <button class="btn btn-outline-secondary" type="button" id="research-domain-help" data-bs-toggle="tooltip" data-bs-placement="top" title="Choose from existing domains or add a new one">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                            {% if form.research_domain.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.research_domain.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Research domain or field of study (e.g., Philosophy, Science, Politics, Engineering Ethics)</div>
                            
                            <!-- Research domain options (existing + predefined) -->
                            <datalist id="research-domain-options">
                                <!-- Existing domains from database (populated first) -->
                                {% for domain in existing_domains %}
                                <option value="{{ domain }}">
                                {% endfor %}
                                
                                <!-- Predefined domain suggestions -->
                                {% set predefined_domains = [
                                    'Philosophy', 'Science', 'Politics', 'Engineering Ethics',
                                    'Medical Ethics', 'Business Ethics', 'Environmental Science',
                                    'Computer Science', 'Linguistics', 'Psychology', 'Sociology',
                                    'History', 'Law', 'Economics', 'Anthropology'
                                ] %}
                                {% for domain in predefined_domains %}
                                    {% if domain not in existing_domains %}
                                    <option value="{{ domain }}">
                                    {% endif %}
                                {% endfor %}
                            </datalist>
                        </div>

                        <!-- Temporal Period Configuration -->
                        <div class="mb-4">
                            <label class="form-label">Reference Time Period *</label>
                            <div class="form-text mb-3">This is the historical period where this term meaning is anchored.</div>
                            
                            <!-- Period Selection Method -->
                            <div class="btn-group mb-3" role="group" aria-label="Period selection method">
                                <input type="radio" class="btn-check" name="period-method" id="single-year" value="single" checked>
                                <label class="btn btn-outline-primary" for="single-year">
                                    <i class="fas fa-calendar-day"></i> Single Year
                                </label>
                                
                                <input type="radio" class="btn-check" name="period-method" id="year-range" value="range">
                                <label class="btn btn-outline-primary" for="year-range">
                                    <i class="fas fa-calendar-alt"></i> Year Range
                                </label>
                                
                                <input type="radio" class="btn-check" name="period-method" id="period-name" value="named">
                                <label class="btn btn-outline-primary" for="period-name">
                                    <i class="fas fa-clock"></i> Named Period
                                </label>
                            </div>
                            
                            <!-- Single Year Input -->
                            <div id="single-year-input" class="period-input">
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="number" class="form-control" id="reference-year" 
                                               placeholder="e.g., 2000" min="1400" max="2030" value="2000">
                                        <small class="text-muted">Reference year for this meaning</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Year Range Input -->
                            <div id="year-range-input" class="period-input" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Start Year</label>
                                        <input type="number" class="form-control" id="start-year" 
                                               placeholder="e.g., 1990" min="1400" max="2030" value="2000">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">End Year</label>
                                        <input type="number" class="form-control" id="end-year" 
                                               placeholder="e.g., 2020" min="1400" max="2030" value="2020">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Named Period Input -->
                            <div id="named-period-input" class="period-input" style="display: none;">
                                <div class="row">
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" id="period-name-text" 
                                               placeholder="e.g., Early 20th Century, Victorian Era, Modern Period">
                                        <small class="text-muted">Descriptive name for the historical period</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden field for backend -->
                            {{ form.temporal_period(class="form-control", style="display: none;") }}
                            {% if form.temporal_period.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.temporal_period.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>


                        <!-- Note about fuzziness score -->
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Automatic Calculation:</strong> Fuzziness scores will be calculated automatically based on semantic drift analysis using the Choi research framework.
                        </div>


                        <!-- Notes -->
                        <div class="mb-4">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows="3") }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Additional notes or context (optional)</div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('terms.term_index') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Create Term
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Term Entry Interface -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Period selection method handling
    const periodMethods = document.querySelectorAll('input[name="period-method"]');
    const singleYearInput = document.getElementById('single-year-input');
    const yearRangeInput = document.getElementById('year-range-input');
    const namedPeriodInput = document.getElementById('named-period-input');
    const hiddenPeriodField = document.getElementById('temporal_period');
    
    periodMethods.forEach(method => {
        method.addEventListener('change', function() {
            // Hide all inputs
            singleYearInput.style.display = 'none';
            yearRangeInput.style.display = 'none';
            namedPeriodInput.style.display = 'none';
            
            // Show selected input
            if (this.value === 'single') {
                singleYearInput.style.display = 'block';
                updateHiddenField();
            } else if (this.value === 'range') {
                yearRangeInput.style.display = 'block';
                updateHiddenField();
            } else if (this.value === 'named') {
                namedPeriodInput.style.display = 'block';
                updateHiddenField();
            }
        });
    });
    
    // Update hidden field with current selection
    function updateHiddenField() {
        const selectedMethod = document.querySelector('input[name="period-method"]:checked').value;
        let value = '';
        
        if (selectedMethod === 'single') {
            const year = document.getElementById('reference-year').value;
            if (year) value = year;
        } else if (selectedMethod === 'range') {
            const startYear = document.getElementById('start-year').value;
            const endYear = document.getElementById('end-year').value;
            if (startYear && endYear) value = `${startYear}-${endYear}`;
        } else if (selectedMethod === 'named') {
            const periodName = document.getElementById('period-name-text').value;
            if (periodName) value = periodName;
        }
        
        hiddenPeriodField.value = value;
    }
    
    // Listen for changes on all period inputs
    document.getElementById('reference-year').addEventListener('input', updateHiddenField);
    document.getElementById('start-year').addEventListener('input', updateHiddenField);
    document.getElementById('end-year').addEventListener('input', updateHiddenField);
    document.getElementById('period-name-text').addEventListener('input', updateHiddenField);
    
    // Initialize with default selection
    updateHiddenField();
    
    // Anchoring method handling
    const anchorMethods = document.querySelectorAll('input[name="anchor-method"]');
    const manualAnchorInput = document.getElementById('manual-anchor-input');
    const documentAnchorInput = document.getElementById('document-anchor-input');
    const oedAnchorInput = document.getElementById('oed-anchor-input');
    const ontologyAnchorInput = document.getElementById('ontology-anchor-input');
    
    anchorMethods.forEach(method => {
        method.addEventListener('change', function() {
            // Hide all anchor inputs
            document.querySelectorAll('.anchor-input').forEach(input => {
                input.style.display = 'none';
            });
            
            // Show selected input
            if (this.value === 'manual') {
                manualAnchorInput.style.display = 'block';
            } else if (this.value === 'document') {
                documentAnchorInput.style.display = 'block';
                loadReferenceDocuments();
            } else if (this.value === 'oed') {
                oedAnchorInput.style.display = 'block';
            } else if (this.value === 'ontology') {
                ontologyAnchorInput.style.display = 'block';
                loadOntServeOntologies();
            }
        });
    });
    
    // Load reference documents for anchor selection
    function loadReferenceDocuments() {
        const select = document.getElementById('anchor-document-select');
        // TODO: Implement AJAX call to load references
        // fetch('/references/api/list')
        //     .then(response => response.json())
        //     .then(data => populateDocumentSelect(data));
        
        // Placeholder options
        select.innerHTML = `
            <option value="">Select a reference document...</option>
            <option value="ieee-standard">IEEE Standard 830 - Software Requirements Specification</option>
            <option value="w3c-prov">W3C PROV-O Specification</option>
            <option value="webster-dict">Webster's Technical Dictionary</option>
        `;
    }
    
    // Load OntServe ontologies
    function loadOntServeOntologies() {
        const ontologySelect = document.getElementById('ontology-select');
        const conceptsDiv = document.getElementById('ontology-concepts');
        const conceptSelect = document.getElementById('concept-select');
        
        // TODO: Implement AJAX call to OntServe
        // fetch('/ontserve/api/ontologies')
        //     .then(response => response.json())
        //     .then(data => populateOntologySelect(data));
        
        ontologySelect.addEventListener('change', function() {
            if (this.value) {
                conceptsDiv.style.display = 'block';
                loadOntologyConcepts(this.value);
            } else {
                conceptsDiv.style.display = 'none';
            }
        });
    }
    
    // Load concepts from selected ontology
    function loadOntologyConcepts(ontologyId) {
        const conceptSelect = document.getElementById('concept-select');
        
        // TODO: Implement AJAX call to OntServe for specific ontology
        // fetch(`/ontserve/api/ontologies/${ontologyId}/concepts`)
        //     .then(response => response.json())
        //     .then(data => populateConceptSelect(data));
        
        // Placeholder options based on ontology
        if (ontologyId === 'prov-o') {
            conceptSelect.innerHTML = `
                <option value="prov:Entity">prov:Entity</option>
                <option value="prov:Activity">prov:Activity</option>
                <option value="prov:Agent">prov:Agent</option>
                <option value="prov:wasDerivedFrom">prov:wasDerivedFrom</option>
                <option value="prov:wasGeneratedBy">prov:wasGeneratedBy</option>
                <option value="prov:wasAssociatedWith">prov:wasAssociatedWith</option>
            `;
        }
    }
    
    // Merriam-Webster Dictionary Search
    document.getElementById('mw-dict-service-btn').addEventListener('click', function() {
        const searchTerm = prompt('Enter term to search in Merriam-Webster Dictionary:');
        if (!searchTerm) return;
        
        searchMerriamWebster(searchTerm, 'dictionary');
    });
    
    // Merriam-Webster Thesaurus Search
    document.getElementById('mw-thes-service-btn').addEventListener('click', function() {
        const searchTerm = prompt('Enter term to search in Merriam-Webster Thesaurus:');
        if (!searchTerm) return;
        
        searchMerriamWebster(searchTerm, 'thesaurus');
    });
    
    // Generic Merriam-Webster search function
    async function searchMerriamWebster(term, service) {
        const resultsDiv = document.getElementById('service-results');
        const resultsContent = document.getElementById('service-results-content');
        
        resultsContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Searching Merriam-Webster ${service} for "${term}"...
            </div>
        `;
        resultsDiv.style.display = 'block';
        
        try {
            const response = await fetch(`/api/merriam-webster/${service}/${encodeURIComponent(term)}`);
            const data = await response.json();
            
            if (data.success && data.results && data.results.length > 0) {
                // Store results for selection function
                currentSearchResults = data;
                currentSearchTerm = term;
                currentSearchService = service;
                let html = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Merriam-Webster ${service.charAt(0).toUpperCase() + service.slice(1)} Results for "${term}"</strong>
                    </div>
                `;
                
                data.results.forEach((result, index) => {
                    html += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <strong>${result.word || result.id}</strong>
                                    ${result.functional_label ? `<span class="badge bg-secondary ms-2">${result.functional_label}</span>` : ''}
                                </h6>
                    `;
                    
                    if (service === 'dictionary') {
                        if (result.definitions && result.definitions.length > 0) {
                            html += `<ul class="mb-2">`;
                            result.definitions.forEach(def => {
                                html += `<li>${def}</li>`;
                            });
                            html += `</ul>`;
                        }
                    } else if (service === 'thesaurus') {
                        if (result.synonyms && result.synonyms.length > 0) {
                            html += `
                                <p><strong>Synonyms:</strong> 
                                ${result.synonyms.flat().slice(0, 10).join(', ')}</p>
                            `;
                        }
                        if (result.antonyms && result.antonyms.length > 0) {
                            html += `
                                <p><strong>Antonyms:</strong> 
                                ${result.antonyms.flat().slice(0, 10).join(', ')}</p>
                            `;
                        }
                    }
                    
                    html += `
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="selectMerriamWebsterResult('${term}', '${service}', ${index})">
                                Use This Definition
                            </button>
                        </div>
                    </div>
                    `;
                });
                
                html += `
                    <div class="mt-3 p-2 bg-light rounded">
                        <small><strong>Citation:</strong> ${data.citation}</small>
                    </div>
                `;
                
                resultsContent.innerHTML = html;
                
            } else if (data.success && (!data.results || data.results.length === 0)) {
                // Clear stored results if no results found
                currentSearchResults = null;
                currentSearchTerm = null;
                currentSearchService = null;
                
                resultsContent.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No results found for "${term}" in Merriam-Webster ${service}.
                        <br><small>Try a different spelling or search term.</small>
                    </div>
                `;
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
            
        } catch (error) {
            console.error('Merriam-Webster API Error:', error);
            
            // Clear stored results on error
            currentSearchResults = null;
            currentSearchTerm = null;
            currentSearchService = null;
            
            resultsContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Error searching Merriam-Webster ${service}</strong>
                    <br>${error.message}
                    <br><small>Please try again or contact support if the problem persists.</small>
                </div>
            `;
        }
    }
    
    // Store search results for result selection
    let currentSearchResults = null;
    let currentSearchTerm = null;
    let currentSearchService = null;

    // Function to handle selecting a Merriam-Webster result
    window.selectMerriamWebsterResult = function(term, service, index) {
        if (!currentSearchResults || !currentSearchResults.results) {
            alert('Error: Search results not available. Please search again.');
            return;
        }
        
        const selectedResult = currentSearchResults.results[index];
        if (!selectedResult) {
            alert('Error: Selected result not found. Please try again.');
            return;
        }
        
        // Switch to Manual Entry tab
        const manualTab = document.getElementById('manual-tab');
        const manualPane = document.getElementById('manual-pane');
        
        // Activate manual tab
        manualTab.click();
        
        // Populate Term Text field with the searched term
        const termTextField = document.getElementById('term_text');
        if (termTextField) {
            termTextField.value = term;
        }
        
        // Populate Meaning Description with the selected definition
        const meaningDescriptionField = document.getElementById('meaning_description');
        if (meaningDescriptionField && selectedResult) {
            let meaningText = '';
            
            if (service === 'dictionary' && selectedResult.definitions && selectedResult.definitions.length > 0) {
                // Use the first definition as the primary meaning
                meaningText = selectedResult.definitions[0];
                
                // Add additional definitions if available
                if (selectedResult.definitions.length > 1) {
                    const additionalDefs = selectedResult.definitions.slice(1, 3); // Take up to 2 more
                    meaningText += '; ' + additionalDefs.join('; ');
                }
            } else if (service === 'thesaurus' && selectedResult.shortdef && selectedResult.shortdef.length > 0) {
                // Use short definition from thesaurus
                meaningText = selectedResult.shortdef[0];
            }
            
            if (meaningText) {
                meaningDescriptionField.value = meaningText;
            }
        }
        
        // Populate context anchor field
        const contextAnchorField = document.getElementById('context_anchor');
        if (contextAnchorField) {
            let contextTerms = [term]; // Start with the search term
            
            if (service === 'dictionary' && selectedResult.definitions) {
                // Extract key terms from definitions for context anchoring
                selectedResult.definitions.forEach(def => {
                    // Simple extraction of potential anchor terms (nouns, key concepts)
                    const words = def.toLowerCase().match(/\b[a-z]{4,}\b/g);
                    if (words) {
                        contextTerms = contextTerms.concat(words.slice(0, 3)); // Take first 3 meaningful words
                    }
                });
            } else if (service === 'thesaurus') {
                // Use synonyms as context anchors
                if (selectedResult.synonyms && selectedResult.synonyms.length > 0) {
                    const synonymList = selectedResult.synonyms.flat();
                    contextTerms = contextTerms.concat(synonymList.slice(0, 5));
                }
            }
            
            // Remove duplicates and join
            contextTerms = [...new Set(contextTerms)];
            contextAnchorField.value = contextTerms.slice(0, 8).join(', ');
        }
        
        // Populate source citation field
        const sourceCitationField = document.getElementById('manual-source-citation');
        if (sourceCitationField && currentSearchResults.citation) {
            sourceCitationField.value = currentSearchResults.citation;
        }
        
        // Set source type to dictionary
        const sourceTypeField = document.getElementById('manual-source-type');
        if (sourceTypeField) {
            sourceTypeField.value = 'dictionary';
        }
        
        // Populate temporal period with current year from API response
        if (currentSearchResults.current_year) {
            // Set to single year mode (should already be default)
            const singleYearRadio = document.getElementById('single-year');
            if (singleYearRadio) {
                singleYearRadio.checked = true;
            }
            
            // Set the reference year to current year
            const referenceYearField = document.getElementById('reference-year');
            if (referenceYearField) {
                referenceYearField.value = currentSearchResults.current_year;
            }
            
            // Update the hidden field
            const hiddenPeriodField = document.getElementById('temporal_period');
            if (hiddenPeriodField) {
                hiddenPeriodField.value = currentSearchResults.current_year.toString();
            }
        }
        
        // Suggest research domain based on term characteristics
        const researchDomainField = document.getElementById('research_domain');
        if (researchDomainField && selectedResult) {
            // Auto-suggest domain based on term characteristics
            let suggestedDomain = '';
            
            if (service === 'dictionary' && selectedResult.functional_label) {
                const label = selectedResult.functional_label.toLowerCase();
                if (label.includes('noun') && selectedResult.definitions) {
                    const def = selectedResult.definitions[0].toLowerCase();
                    
                    // Simple domain classification based on definition content
                    if (def.includes('philosophy') || def.includes('philosophical') || def.includes('ethics') || def.includes('moral')) {
                        suggestedDomain = 'Philosophy';
                    } else if (def.includes('science') || def.includes('scientific') || def.includes('research')) {
                        suggestedDomain = 'Science';
                    } else if (def.includes('political') || def.includes('government') || def.includes('policy')) {
                        suggestedDomain = 'Politics';
                    } else if (def.includes('legal') || def.includes('court') || def.includes('judicial')) {
                        suggestedDomain = 'Law';
                    } else if (def.includes('economic') || def.includes('business') || def.includes('commerce')) {
                        suggestedDomain = 'Economics';
                    } else if (def.includes('language') || def.includes('linguistic') || def.includes('grammar')) {
                        suggestedDomain = 'Linguistics';
                    }
                }
            }
            
            // Only populate if field is empty and we have a suggestion
            if (suggestedDomain && !researchDomainField.value.trim()) {
                researchDomainField.value = suggestedDomain;
            }
        }
        
        // Close the service results
        const resultsDiv = document.getElementById('service-results');
        if (resultsDiv) {
            resultsDiv.style.display = 'none';
        }
        
        // Show success message
        const suggestedDomainText = researchDomainField && researchDomainField.value ? `, research domain (${researchDomainField.value})` : '';
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Result Selected!</strong> 
                Term text, meaning description, temporal period (${currentSearchResults.current_year || 'current year'})${suggestedDomainText}, context anchors, and source citation have been populated from Merriam-Webster ${service}.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Insert alert at top of manual pane
        const manualPaneElement = document.getElementById('manual-pane');
        if (manualPaneElement) {
            manualPaneElement.insertAdjacentHTML('afterbegin', alertHtml);
        }
        
        // Auto-dismiss success message after 4 seconds
        setTimeout(() => {
            const alert = manualPaneElement.querySelector('.alert-success');
            if (alert) {
                alert.remove();
            }
        }, 4000);
    }
    
    // OED Search functionality - integrated with existing OED API
    if (document.getElementById('oed-service-btn')) {
        document.getElementById('oed-service-btn').addEventListener('click', async function() {
            const searchTerm = prompt('Enter term to search in OED:');
            if (!searchTerm) return;
            
            const resultsDiv = document.getElementById('service-results');
            const resultsContent = document.getElementById('service-results-content');
            
            resultsContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Searching OED for "${searchTerm}"...
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            try {
                // First, get suggested entry IDs for the headword
                const suggestRes = await fetch(`/references/api/oed/suggest?q=${encodeURIComponent(searchTerm)}`);
                const suggestData = await suggestRes.json();
                
                if (!suggestData.success) {
                    resultsContent.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>OED API Error:</strong> ${suggestData.error || 'Unable to search OED'}
                            <br><small>Make sure OED API is configured with OED_USE_API=true and proper credentials.</small>
                        </div>
                    `;
                    return;
                }
                
                const suggestions = suggestData.suggestions || [];
                
                if (suggestions.length === 0) {
                    resultsContent.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No OED entries found for "${searchTerm}".
                            <br><small>Try a different spelling or search term.</small>
                        </div>
                    `;
                    return;
                }
                
                // Display the results
                let html = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>OED Results for "${searchTerm}"</strong>
                    </div>
                `;
                
                suggestions.forEach((entry, index) => {
                    const entryId = entry.entry_id || '';
                    const headword = entry.headword || entry.word || searchTerm;
                    const pos = entry.pos || entry.part_of_speech || '';
                    const senseCount = entry.sense_count || 0;
                    
                    html += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <strong>${headword}</strong>
                                    ${pos ? `<span class="badge bg-secondary ms-2">${pos}</span>` : ''}
                                    <small class="text-muted ms-2">(${entryId})</small>
                                </h6>
                    `;

                    // Show definition if available
                    const definition = entry.definition || '';
                    if (definition) {
                        // Truncate long definitions
                        const shortDef = definition.length > 150 ?
                            definition.substring(0, 150) + '...' : definition;
                        html += `<p class="mb-2 small">${shortDef}</p>`;
                    }

                    if (senseCount > 1) {
                        html += `<p class="small text-muted mb-2"><i class="fas fa-info-circle me-1"></i>${senseCount} senses available - click "Use This Entry" to see all</p>`;
                    }
                    
                    html += `
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="selectOEDResult('${searchTerm}', '${entryId}', '${headword}', '${pos}', ${index})">
                                Use This Entry
                            </button>
                        </div>
                    </div>
                    `;
                });
                
                html += `
                    <div class="mt-3 p-2 bg-light rounded">
                        <small><strong>Source:</strong> Oxford English Dictionary (via OED Researcher API)</small>
                        <br><small class="text-muted">Note: Only metadata is stored; definitions are fetched on demand.</small>
                    </div>
                `;
                
                resultsContent.innerHTML = html;
                
                // Store results for selection
                window.currentOEDResults = suggestions;
                
            } catch (error) {
                console.error('OED API Error:', error);
                resultsContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Error searching OED</strong>
                        <br>${error.message}
                        <br><small>Please check your OED API configuration and try again.</small>
                    </div>
                `;
            }
        });
    }
    
    // Function to handle selecting an OED result
    window.selectOEDResult = async function(searchTerm, entryId, headword, pos, index) {
        // Switch to Manual Entry tab
        const manualTab = document.getElementById('manual-tab');
        manualTab.click();
        
        // Populate Term Text field
        const termTextField = document.getElementById('term_text');
        if (termTextField) {
            termTextField.value = headword || searchTerm;
        }
        
        // Try to fetch full entry details for better definition
        try {
            const res = await fetch(`/references/api/oed/word/${encodeURIComponent(entryId)}`);
            const json = await res.json();
            
            if (json.success && json.data) {
                const data = json.data;
                
                // Populate Meaning Description with first available definition
                const meaningDescriptionField = document.getElementById('meaning_description');
                if (meaningDescriptionField) {
                    let meaningText = '';
                    
                    // Try to extract definition from senses
                    if (data.senses && data.senses.length > 0) {
                        const firstSense = data.senses[0];
                        let definition = firstSense.definition || '';
                        if (Array.isArray(definition)) {
                            definition = definition[0] || '';
                        }
                        if (definition) {
                            meaningText = definition;
                        }
                    }
                    
                    // If we have extracted_senses, use those as fallback
                    if (!meaningText && data.extracted_senses && data.extracted_senses.length > 0) {
                        const firstExtracted = data.extracted_senses[0];
                        meaningText = firstExtracted.definition || firstExtracted.excerpt || '';
                    }
                    
                    if (meaningText) {
                        meaningDescriptionField.value = meaningText;
                    }
                }
                
                // Populate context anchors with related terms from OED
                const contextAnchorField = document.getElementById('context_anchor');
                if (contextAnchorField) {
                    let contextTerms = [headword];
                    
                    // Extract etymological or related terms if available
                    if (data.etymology) {
                        // Simple extraction of potential related terms from etymology
                        const etymWords = data.etymology.match(/\b[a-z]{4,}\b/gi);
                        if (etymWords) {
                            contextTerms = contextTerms.concat(etymWords.slice(0, 3));
                        }
                    }
                    
                    // Add variants if available
                    if (data.variants && Array.isArray(data.variants)) {
                        contextTerms = contextTerms.concat(data.variants.slice(0, 3));
                    }
                    
                    // Remove duplicates
                    contextTerms = [...new Set(contextTerms)];
                    contextAnchorField.value = contextTerms.slice(0, 8).join(', ');
                }
            }
        } catch (error) {
            console.warn('Could not fetch full OED entry details:', error);
        }
        
        // Populate source citation
        const sourceCitationField = document.getElementById('source_citation');
        if (sourceCitationField) {
            sourceCitationField.value = `Oxford English Dictionary, s.v. "${headword}" (entry ID: ${entryId}), Oxford University Press`;
        }

        // Auto-select "Dictionary" as source type
        const sourceTypeSelect = document.getElementById('manual-source-type');
        if (sourceTypeSelect) {
            sourceTypeSelect.value = 'dictionary';
        }
        
        // Set temporal period to current year (OED is continuously updated)
        const singleYearRadio = document.getElementById('single-year');
        if (singleYearRadio) {
            singleYearRadio.checked = true;
        }
        
        const referenceYearField = document.getElementById('reference-year');
        if (referenceYearField) {
            const currentYear = new Date().getFullYear();
            referenceYearField.value = currentYear;
        }
        
        const hiddenPeriodField = document.getElementById('temporal_period');
        if (hiddenPeriodField) {
            hiddenPeriodField.value = new Date().getFullYear().toString();
        }
        
        // Suggest research domain based on part of speech
        const researchDomainField = document.getElementById('research_domain');
        if (researchDomainField && !researchDomainField.value.trim()) {
            // Default to Linguistics for OED entries
            researchDomainField.value = 'Linguistics';
        }
        
        // Close the service results
        const resultsDiv = document.getElementById('service-results');
        if (resultsDiv) {
            resultsDiv.style.display = 'none';
        }
        
        // Show success message
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <strong>OED Entry Selected!</strong> 
                Term text, meaning description, context anchors, and source citation have been populated from the Oxford English Dictionary.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const manualPaneElement = document.getElementById('manual-pane');
        if (manualPaneElement) {
            manualPaneElement.insertAdjacentHTML('afterbegin', alertHtml);
        }
        
        // Auto-dismiss success message after 4 seconds
        setTimeout(() => {
            const alert = manualPaneElement.querySelector('.alert-success');
            if (alert) {
                alert.remove();
            }
        }, 4000);
    }
    
    // WordNet Search functionality - integrated with NLTK WordNet
    if (document.getElementById('wordnet-service-btn')) {
        document.getElementById('wordnet-service-btn').addEventListener('click', async function() {
            const searchTerm = prompt('Enter term to search in WordNet:');
            if (!searchTerm) return;
            
            const resultsDiv = document.getElementById('service-results');
            const resultsContent = document.getElementById('service-results-content');
            
            resultsContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Searching WordNet for "${searchTerm}"...
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            try {
                const res = await fetch(`/references/api/wordnet/search?q=${encodeURIComponent(searchTerm)}`);
                const data = await res.json();
                
                if (!data.success) {
                    resultsContent.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>WordNet Error:</strong> ${data.error || 'Unable to search WordNet'}
                            <br><small>Make sure NLTK WordNet data is installed.</small>
                        </div>
                    `;
                    return;
                }
                
                const synsets = data.synsets || [];
                
                if (synsets.length === 0) {
                    resultsContent.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.message || `No WordNet entries found for "${searchTerm}".`}
                            <br><small>Try a different spelling or search term.</small>
                        </div>
                    `;
                    return;
                }
                
                // Display the results
                let html = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>WordNet Results for "${searchTerm}"</strong> (${data.total_synsets} synset${data.total_synsets > 1 ? 's' : ''})
                    </div>
                `;
                
                synsets.forEach((synset, index) => {
                    const name = synset.name || '';
                    const pos = synset.pos_name || synset.pos || '';
                    const definition = synset.definition || '';
                    const examples = synset.examples || [];
                    const synonyms = synset.synonyms || [];
                    const antonyms = synset.antonyms || [];
                    
                    html += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <strong>${searchTerm}</strong>
                                    ${pos ? `<span class="badge bg-secondary ms-2">${pos}</span>` : ''}
                                    <small class="text-muted ms-2">(${name})</small>
                                </h6>
                    `;
                    
                    // Show definition
                    if (definition) {
                        html += `<p class="mb-2">${definition}</p>`;
                    }
                    
                    // Show examples
                    if (examples.length > 0) {
                        html += `<div class="mb-2">
                            <strong class="small">Examples:</strong>
                            <ul class="small mb-2">`;
                        examples.slice(0, 2).forEach(example => {
                            html += `<li><em>"${example}"</em></li>`;
                        });
                        html += `</ul></div>`;
                    }
                    
                    // Show synonyms
                    if (synonyms.length > 0) {
                        html += `<p class="small mb-1"><strong>Synonyms:</strong> ${synonyms.slice(0, 5).join(', ')}</p>`;
                    }
                    
                    // Show antonyms
                    if (antonyms.length > 0) {
                        html += `<p class="small mb-2"><strong>Antonyms:</strong> ${antonyms.slice(0, 3).join(', ')}</p>`;
                    }
                    
                    html += `
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="selectWordNetResult('${searchTerm}', '${name}', '${pos}', '${definition}', ${index})">
                                Use This Synset
                            </button>
                        </div>
                    </div>
                    `;
                });
                
                html += `
                    <div class="mt-3 p-2 bg-light rounded">
                        <small><strong>Source:</strong> ${data.citation || 'WordNet: A Lexical Database for English. Princeton University.'}</small>
                    </div>
                `;
                
                resultsContent.innerHTML = html;
                
                // Store results for selection
                window.currentWordNetResults = data;
                
            } catch (error) {
                console.error('WordNet API Error:', error);
                resultsContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Error searching WordNet</strong>
                        <br>${error.message}
                        <br><small>Please check your WordNet installation and try again.</small>
                    </div>
                `;
            }
        });
    }
    
    // Function to handle selecting a WordNet result
    window.selectWordNetResult = function(searchTerm, synsetName, pos, definition, index) {
        // Switch to Manual Entry tab
        const manualTab = document.getElementById('manual-tab');
        manualTab.click();
        
        // Populate Term Text field
        const termTextField = document.getElementById('term_text');
        if (termTextField) {
            termTextField.value = searchTerm;
        }
        
        // Populate Meaning Description with definition
        const meaningDescriptionField = document.getElementById('meaning_description');
        if (meaningDescriptionField && definition) {
            meaningDescriptionField.value = definition;
        }
        
        // Populate context anchors with synonyms and related terms from the selected synset
        const contextAnchorField = document.getElementById('context_anchor');
        if (contextAnchorField && window.currentWordNetResults) {
            const synsets = window.currentWordNetResults.synsets || [];
            if (synsets[index]) {
                const synset = synsets[index];
                let contextTerms = [searchTerm];
                
                // Add synonyms
                if (synset.synonyms && synset.synonyms.length > 0) {
                    contextTerms = contextTerms.concat(synset.synonyms.slice(0, 5));
                }
                
                // Add hypernyms (more general terms)
                if (synset.hypernyms && synset.hypernyms.length > 0) {
                    synset.hypernyms.slice(0, 2).forEach(hyper => {
                        if (hyper.lemmas && hyper.lemmas.length > 0) {
                            contextTerms.push(hyper.lemmas[0]);
                        }
                    });
                }
                
                // Add hyponyms (more specific terms)
                if (synset.hyponyms && synset.hyponyms.length > 0) {
                    synset.hyponyms.slice(0, 2).forEach(hypo => {
                        if (hypo.lemmas && hypo.lemmas.length > 0) {
                            contextTerms.push(hypo.lemmas[0]);
                        }
                    });
                }
                
                // Remove duplicates
                contextTerms = [...new Set(contextTerms)];
                contextAnchorField.value = contextTerms.slice(0, 8).join(', ');
            }
        }
        
        // Populate source citation
        const sourceCitationField = document.getElementById('manual-source-citation');
        if (sourceCitationField) {
            sourceCitationField.value = `WordNet: A Lexical Database for English. Princeton University. Synset: ${synsetName}`;
        }
        
        // Set source type to dictionary
        const sourceTypeField = document.getElementById('manual-source-type');
        if (sourceTypeField) {
            sourceTypeField.value = 'dictionary';
        }
        
        // Set temporal period to current year (WordNet is continuously updated)
        const singleYearRadio = document.getElementById('single-year');
        if (singleYearRadio) {
            singleYearRadio.checked = true;
        }
        
        const referenceYearField = document.getElementById('reference-year');
        if (referenceYearField) {
            const currentYear = new Date().getFullYear();
            referenceYearField.value = currentYear;
        }
        
        const hiddenPeriodField = document.getElementById('temporal_period');
        if (hiddenPeriodField) {
            hiddenPeriodField.value = new Date().getFullYear().toString();
        }
        
        // Suggest research domain based on part of speech
        const researchDomainField = document.getElementById('research_domain');
        if (researchDomainField && !researchDomainField.value.trim()) {
            // Default to Linguistics for WordNet entries
            researchDomainField.value = 'Linguistics';
        }
        
        // Close the service results
        const resultsDiv = document.getElementById('service-results');
        if (resultsDiv) {
            resultsDiv.style.display = 'none';
        }
        
        // Show success message
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <strong>WordNet Synset Selected!</strong> 
                Term text, meaning description, context anchors (with synonyms and related terms), and source citation have been populated from WordNet.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const manualPaneElement = document.getElementById('manual-pane');
        if (manualPaneElement) {
            manualPaneElement.insertAdjacentHTML('afterbegin', alertHtml);
        }
        
        // Auto-dismiss success message after 4 seconds
        setTimeout(() => {
            const alert = manualPaneElement.querySelector('.alert-success');
            if (alert) {
                alert.remove();
            }
        }, 4000);
    }
    
    // Reference Document Selection Handler
    document.getElementById('anchor-document-select')?.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (selectedOption.value) {
            const docTitle = selectedOption.dataset.title;
            const docType = selectedOption.dataset.type;
            
            // Update source citation with document reference
            const sourceCitationField = document.getElementById('source_citation');
            if (sourceCitationField) {
                sourceCitationField.value = `${docTitle} (Document ID: ${selectedOption.value})`;
            }
            
            // Set temporal period to current year (when document was added)
            const singleYearRadio = document.getElementById('single-year');
            if (singleYearRadio) {
                singleYearRadio.checked = true;
            }
            
            const referenceYearField = document.getElementById('reference-year');
            if (referenceYearField) {
                const currentYear = new Date().getFullYear();
                referenceYearField.value = currentYear;
            }
            
            const hiddenPeriodField = document.getElementById('temporal_period');
            if (hiddenPeriodField) {
                hiddenPeriodField.value = new Date().getFullYear().toString();
            }
            
            // Show confirmation message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show mt-2" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Document Selected!</strong> The system will automatically process "${docTitle}" to extract relevant terms.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Add alert to the reference tab
            const referencePane = document.getElementById('reference-pane');
            if (referencePane) {
                const existingAlert = referencePane.querySelector('.alert-success');
                if (existingAlert) {
                    existingAlert.remove();
                }
                referencePane.insertAdjacentHTML('beforeend', alertHtml);
            }
        }
    });
    
    // Auto-suggest for manual context anchor
    const contextInput = document.getElementById('context_anchor');
    if (contextInput) {
        contextInput.addEventListener('input', function() {
            // TODO: Implement context anchor suggestions from:
            // 1. Existing terms in database
            // 2. OntServe ontologies 
            // 3. Related terms from corpus analysis
        });
    }
    
    // Form validation enhancement
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const periodValue = hiddenPeriodField.value;
            if (!periodValue.trim()) {
                e.preventDefault();
                alert('Please specify a reference time period for this term.');
                return false;
            }
        });
    }

    // ========================================================================
    // OED TEMPORAL TIMELINE - Multi-version term creation
    // ========================================================================

    window.showOEDTimeline = async function(entryId, headword) {
        try {
            // Fetch timeline data
            const res = await fetch(`/references/api/oed/timeline/${encodeURIComponent(entryId)}`);
            const data = await res.json();

            if (!data.success) {
                alert(`Error loading timeline: ${data.error || 'Unknown error'}`);
                return;
            }

            const waypoints = data.waypoints || [];

            if (waypoints.length === 0) {
                alert('No temporal waypoints found for this entry.');
                return;
            }

            // Build modal HTML
            let modalHtml = `
                <div class="modal fade" id="oedTimelineModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-clock me-2"></i>
                                    OED Temporal Evolution: "${headword}"
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Select temporal waypoints</strong> to create a multi-version term showing semantic evolution.
                                    Each waypoint represents the first use of a new sense in the OED.
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Research Domain (optional)</label>
                                    <input type="text" class="form-control" id="timeline-research-domain"
                                           placeholder="e.g., philosophy, linguistics, computer science">
                                </div>

                                <h6 class="mb-3">Available Waypoints (${waypoints.length} found):</h6>

                                <div class="waypoints-list">
            `;

            waypoints.forEach((wp, idx) => {
                const year = wp.year || 'unknown';
                const datestring = wp.datestring || year;
                const senseLabel = wp.sense_label || '';
                const definition = wp.definition || 'No definition available';
                const quoteText = (wp.quotation && wp.quotation.text) ? wp.quotation.text.substring(0, 100) : '';
                const quoteSource = (wp.quotation && wp.quotation.source) || '';
                const isFirst = wp.first_in_word;

                modalHtml += `
                    <div class="card mb-3 waypoint-card">
                        <div class="card-body">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input waypoint-checkbox"
                                       id="waypoint-${idx}" data-index="${idx}"
                                       ${isFirst ? 'checked' : ''}>
                                <label class="form-check-label" for="waypoint-${idx}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                <span class="badge bg-primary">${datestring}</span>
                                                ${senseLabel ? `<span class="badge bg-secondary">Sense ${senseLabel}</span>` : ''}
                                                ${isFirst ? '<span class="badge bg-success">First Use</span>' : ''}
                                            </h6>
                                            <p class="mb-2">${definition}</p>
                                            ${quoteText ? `<p class="small text-muted mb-1"><em>"${quoteText}..."</em></p>` : ''}
                                            ${quoteSource ? `<p class="small text-muted mb-0">Source: ${quoteSource}</p>` : ''}
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
            });

            modalHtml += `
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div class="me-auto">
                                    <span id="waypoint-count">0</span> waypoints selected
                                </div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="create-multi-version-btn" disabled>
                                    <i class="fas fa-plus-circle me-1"></i>Create Multi-Version Term
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existing = document.getElementById('oedTimelineModal');
            if (existing) {
                existing.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Store timeline data for later use
            window.currentTimelineData = {
                entry_id: entryId,
                headword: headword,
                waypoints: waypoints,
                date_range: data.date_range
            };

            // Initialize modal
            const modal = new bootstrap.Modal(document.getElementById('oedTimelineModal'));

            // Update counter and enable/disable button
            function updateWaypointCount() {
                const checked = document.querySelectorAll('.waypoint-checkbox:checked');
                document.getElementById('waypoint-count').textContent = checked.length;
                document.getElementById('create-multi-version-btn').disabled = checked.length === 0;
            }

            // Add event listeners to checkboxes
            document.querySelectorAll('.waypoint-checkbox').forEach(cb => {
                cb.addEventListener('change', updateWaypointCount);
            });

            // Handle create button
            document.getElementById('create-multi-version-btn').addEventListener('click', createMultiVersionTerm);

            // Initial count
            updateWaypointCount();

            // Show modal
            modal.show();

        } catch (error) {
            console.error('Error showing OED timeline:', error);
            alert(`Error: ${error.message}`);
        }
    };

    async function createMultiVersionTerm() {
        try {
            const data = window.currentTimelineData;
            if (!data) {
                alert('Timeline data not found');
                return;
            }

            // Get selected waypoints
            const selectedWaypoints = [];
            document.querySelectorAll('.waypoint-checkbox:checked').forEach(cb => {
                const idx = parseInt(cb.dataset.index);
                const waypoint = data.waypoints[idx];
                if (waypoint) {
                    selectedWaypoints.push(waypoint);
                }
            });

            if (selectedWaypoints.length === 0) {
                alert('Please select at least one waypoint');
                return;
            }

            // Get research domain
            const researchDomain = document.getElementById('timeline-research-domain').value.trim();

            // Disable button during creation
            const btn = document.getElementById('create-multi-version-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';

            // Call API
            const response = await fetch('/terms/create_from_oed_waypoints', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    entry_id: data.entry_id,
                    headword: data.headword,
                    research_domain: researchDomain,
                    waypoints: selectedWaypoints
                })
            });

            const result = await response.json();

            if (result.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('oedTimelineModal')).hide();

                // Show success message
                alert(`Success! Created term "${result.term_text}" with ${result.versions_created} temporal versions.`);

                // Redirect to term view
                if (result.redirect_url) {
                    window.location.href = result.redirect_url;
                }
            } else {
                alert(`Error: ${result.error || 'Failed to create term'}`);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i>Create Multi-Version Term';
            }

        } catch (error) {
            console.error('Error creating multi-version term:', error);
            alert(`Error: ${error.message}`);
        }
    }
});
</script>
{% endblock %}