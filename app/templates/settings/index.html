{% extends "base.html" %}

{% block title %}Settings - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12">
            <h2><i class="fas fa-cog me-2"></i>Settings</h2>
            <p class="text-muted">Configure OntExtract for your workflow</p>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-12">
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'llm' %}active{% endif %}"
                            id="llm-tab" data-bs-toggle="tab" data-bs-target="#llm"
                            type="button" role="tab">
                        <i class="fas fa-robot me-2"></i>LLM Integration
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'nlp' %}active{% endif %}"
                            id="nlp-tab" data-bs-toggle="tab" data-bs-target="#nlp"
                            type="button" role="tab">
                        <i class="fas fa-brain me-2"></i>NLP Tools
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'prompts' %}active{% endif %}"
                            id="prompts-tab" data-bs-toggle="tab" data-bs-target="#prompts"
                            type="button" role="tab">
                        <i class="fas fa-file-alt me-2"></i>Prompt Templates
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'provenance' %}active{% endif %}"
                            id="provenance-tab" data-bs-toggle="tab" data-bs-target="#provenance"
                            type="button" role="tab">
                        <i class="fas fa-history me-2"></i>Provenance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'processing' %}active{% endif %}"
                            id="processing-tab" data-bs-toggle="tab" data-bs-target="#processing"
                            type="button" role="tab">
                        <i class="fas fa-microchip me-2"></i>Processing
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-4" id="settingsTabContent">
                <!-- LLM Integration Tab -->
                <div class="tab-pane fade {% if active_tab == 'llm' %}show active{% endif %}"
                     id="llm" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">LLM Integration Settings</h5>
                            <p class="text-muted">
                                Configure LLM-assisted processing suggestions. When enabled, the LLM
                                will analyze your experiment description and suggest optimal processing methods.
                            </p>

                            <form id="llm-settings-form">
                                <!-- API Key Status -->
                                <div class="alert {% if api_key_available %}alert-success{% else %}alert-warning{% endif %} mb-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas {% if api_key_available %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %} fa-2x me-3"></i>
                                        <div>
                                            <strong>API Key Status:</strong>
                                            {% if api_key_available %}
                                                <span class="badge bg-success ms-2">Available</span>
                                                <p class="mb-0 mt-1 small">ANTHROPIC_API_KEY is configured. LLM features can be enabled.</p>
                                            {% else %}
                                                <span class="badge bg-warning text-dark ms-2">Not Found</span>
                                                <p class="mb-0 mt-1 small">Set ANTHROPIC_API_KEY environment variable to enable LLM features.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- LLM Provider Info (Read-only) -->
                                <div class="mb-3">
                                    <label class="form-label">LLM Provider</label>
                                    <div class="form-control-plaintext">
                                        <i class="fas fa-robot me-2"></i>
                                        <strong>Anthropic Claude</strong>
                                        <small class="text-muted ms-2">(Model: claude-sonnet-4-5-20250929)</small>
                                    </div>
                                    <small class="text-muted">Provider and model are configured via environment variables.</small>
                                </div>

                                <hr class="my-4">

                                <!-- Enable/Disable Toggle -->
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               id="enable_llm_enhancement"
                                               {% if settings.llm.enable_llm_enhancement %}checked{% endif %}
                                               {% if not api_key_available %}disabled{% endif %}>
                                        <label class="form-check-label" for="enable_llm_enhancement">
                                            <strong>Enable LLM Template Enhancement</strong>
                                            <small class="d-block text-muted">
                                                LLM will enhance prompt template outputs (experiment descriptions, etc.)
                                            </small>
                                        </label>
                                    </div>
                                    {% if not api_key_available %}
                                    <small class="text-warning">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Disabled: API key not found
                                    </small>
                                    {% endif %}
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Note: This setting controls template enhancement only. The "LLM Analyze" feature in experiments works independently when an API key is available.
                                    </small>
                                </div>

                                <!-- Max Tokens -->
                                <div class="mb-3">
                                    <label for="llm_max_tokens" class="form-label">Max Tokens</label>
                                    <input type="number" class="form-control" id="llm_max_tokens"
                                           value="{{ settings.llm.llm_max_tokens or 200 }}" min="50" max="1000">
                                    <small class="text-muted">Maximum response length for template enhancement (50-1000). Default: 200 (~150 words)</small>
                                </div>

                                <div class="d-flex gap-2">
                                    {% if api_key_available %}
                                    <button type="button" class="btn btn-outline-primary" onclick="testLLMConnection()">
                                        <i class="fas fa-plug me-2"></i>Test Connection
                                    </button>
                                    {% endif %}
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- NLP Tools Tab -->
                <div class="tab-pane fade {% if active_tab == 'nlp' %}show active{% endif %}"
                     id="nlp" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Definition Extraction</h5>
                            <p class="text-muted">Configure the transformer-based definition extraction tool</p>

                            <form id="nlp-settings-form">
                                <div class="mb-3">
                                    <label for="definition_extraction_confidence_threshold" class="form-label">
                                        Confidence Threshold
                                        <span class="text-muted">(0.5 - 0.95)</span>
                                    </label>
                                    <div class="d-flex align-items-center gap-3">
                                        <input type="range" class="form-range flex-grow-1" id="definition_extraction_confidence_threshold"
                                               min="0.5" max="0.95" step="0.05"
                                               value="{{ settings.nlp.definition_extraction_confidence_threshold or 0.70 }}"
                                               oninput="updateConfidenceDisplay(this.value)">
                                        <span class="badge bg-primary fs-6" id="confidence-display">{{ (settings.nlp.definition_extraction_confidence_threshold or 0.70)|round(2) }}</span>
                                    </div>
                                    <small class="form-text text-muted">
                                        Higher values = fewer but higher-quality definitions. Lower values = more definitions with potential false positives.
                                        <br><strong>Recommended: 0.70</strong> (70% confidence)
                                    </small>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Prompt Templates Tab -->
                <div class="tab-pane fade {% if active_tab == 'prompts' %}show active{% endif %}"
                     id="prompts" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Prompt Templates</h5>
                            <p class="text-muted">Manage Jinja2 templates for experiment descriptions</p>

                            {% if templates %}
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Template</th>
                                            <th>Category</th>
                                            <th>Variables</th>
                                            <th>LLM Enhancement</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                        <tr>
                                            <td><code>{{ template.template_key }}</code></td>
                                            <td>{{ template.category }}</td>
                                            <td><small>{{ template.variables.keys() | list | join(', ') }}</small></td>
                                            <td>
                                                {% if template.supports_llm_enhancement %}
                                                <span class="badge bg-success">Yes</span>
                                                {% else %}
                                                <span class="badge bg-secondary">No</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-nowrap">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-outline-primary"
                                                            onclick="viewTemplate({{ template.id }})"
                                                            title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary"
                                                            onclick="editTemplate({{ template.id }})"
                                                            title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted">No prompt templates configured.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Provenance Tab -->
                <div class="tab-pane fade {% if active_tab == 'provenance' %}show active{% endif %}"
                     id="provenance" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Provenance Settings</h5>
                            <p class="text-muted">
                                Configure how provenance records are handled when documents, terms, or experiments are deleted.
                                These settings affect the audit trail and data reproducibility.
                            </p>

                            <form id="provenance-settings-form">
                                <!-- Purge vs Invalidate -->
                                <div class="mb-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               id="purge_provenance_on_delete"
                                               {% if settings.provenance.purge_provenance_on_delete is not defined or settings.provenance.purge_provenance_on_delete %}checked{% endif %}>
                                        <label class="form-check-label" for="purge_provenance_on_delete">
                                            <strong>Purge provenance records on delete</strong>
                                        </label>
                                    </div>
                                    <div class="ms-4 mt-2">
                                        <div class="alert alert-info py-2 mb-0">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong><i class="fas fa-check-circle me-1"></i>When enabled (default):</strong>
                                                    <ul class="mb-0 small">
                                                        <li>Provenance records are permanently deleted</li>
                                                        <li>Cleaner database, less storage</li>
                                                        <li>No audit trail of deleted items</li>
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong><i class="fas fa-history me-1"></i>When disabled:</strong>
                                                    <ul class="mb-0 small">
                                                        <li>Records are marked as "invalidated" but preserved</li>
                                                        <li>Complete audit trail maintained</li>
                                                        <li>Can view deleted items in timeline (see below)</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- Show Deleted in Timeline (only relevant when purge is disabled) -->
                                <div class="mb-4" id="show-deleted-section">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               id="show_deleted_in_timeline"
                                               {% if settings.provenance.show_deleted_in_timeline %}checked{% endif %}>
                                        <label class="form-check-label" for="show_deleted_in_timeline">
                                            <strong>Show deleted items in timeline by default</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted d-block ms-4 mt-1">
                                        <i class="fas fa-info-circle me-1"></i>
                                        When disabled, deleted items are hidden by default but can be shown via a checkbox on each timeline view.
                                        This setting only applies when "Purge provenance records" is disabled.
                                    </small>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Provenance Impact Info -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>What Gets Affected</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <h6><i class="fas fa-file-alt me-2 text-primary"></i>Document Deletion</h6>
                                    <ul class="small">
                                        <li>Document upload records</li>
                                        <li>Text extraction records</li>
                                        <li>Processing operation records</li>
                                        <li>Relationships to activities</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="fas fa-tags me-2 text-success"></i>Term Deletion</h6>
                                    <ul class="small">
                                        <li>Term creation records</li>
                                        <li>Term update records</li>
                                        <li>Version history records</li>
                                        <li>Relationships to activities</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="fas fa-flask me-2 text-warning"></i>Experiment Deletion</h6>
                                    <ul class="small">
                                        <li>Experiment creation records</li>
                                        <li>Experimental document versions</li>
                                        <li>Processing artifacts</li>
                                        <li><strong>Note:</strong> Original documents preserved</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Tab -->
                <div class="tab-pane fade {% if active_tab == 'processing' %}show active{% endif %}"
                     id="processing" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Text Cleanup Processing</h5>
                            <p class="text-muted">
                                Configure how document text is processed during LLM-based cleanup.
                                Large documents are split into chunks for processing.
                            </p>

                            <form id="processing-settings-form">
                                <!-- Concurrent Processing Toggle -->
                                <div class="mb-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               id="concurrent_chunk_processing"
                                               {% if settings.processing.concurrent_chunk_processing is not defined or settings.processing.concurrent_chunk_processing %}checked{% endif %}>
                                        <label class="form-check-label" for="concurrent_chunk_processing">
                                            <strong>Enable concurrent chunk processing</strong>
                                        </label>
                                    </div>
                                    <div class="ms-4 mt-2">
                                        <div class="alert alert-info py-2 mb-0">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong><i class="fas fa-bolt me-1"></i>When enabled (default):</strong>
                                                    <ul class="mb-0 small">
                                                        <li>Multiple chunks processed simultaneously</li>
                                                        <li>Faster overall processing time</li>
                                                        <li>Higher concurrent API usage</li>
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong><i class="fas fa-list-ol me-1"></i>When disabled:</strong>
                                                    <ul class="mb-0 small">
                                                        <li>Chunks processed one at a time</li>
                                                        <li>Predictable, sequential progress</li>
                                                        <li>Lower concurrent API usage</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- Max Concurrent Chunks -->
                                <div class="mb-4" id="max-concurrent-section">
                                    <label for="max_concurrent_chunks" class="form-label">
                                        <strong>Maximum Concurrent Chunks</strong>
                                        <span class="text-muted">(1 - 10)</span>
                                    </label>
                                    <div class="d-flex align-items-center gap-3">
                                        <input type="range" class="form-range flex-grow-1" id="max_concurrent_chunks"
                                               min="1" max="10" step="1"
                                               value="{{ settings.processing.max_concurrent_chunks or 3 }}"
                                               oninput="updateConcurrentDisplay(this.value)">
                                        <span class="badge bg-primary fs-6" id="concurrent-display">{{ settings.processing.max_concurrent_chunks or 3 }}</span>
                                    </div>
                                    <small class="form-text text-muted">
                                        Higher values = faster processing but more concurrent API calls.
                                        <br><strong>Recommended: 3</strong> (balances speed and API rate limits)
                                    </small>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Processing Info -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>How Text Cleanup Works</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <h6><i class="fas fa-cut me-2 text-primary"></i>1. Chunking</h6>
                                    <p class="small mb-0">
                                        Documents over 8,000 characters are split by paragraph boundaries
                                        to maintain natural context.
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="fas fa-cogs me-2 text-success"></i>2. Processing</h6>
                                    <p class="small mb-0">
                                        Each chunk is sent to Claude for OCR correction, spelling fixes,
                                        and formatting improvements.
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="fas fa-object-group me-2 text-warning"></i>3. Reassembly</h6>
                                    <p class="small mb-0">
                                        Cleaned chunks are reassembled in order, preserving the
                                        original document structure.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Template Modal -->
<div class="modal fade" id="viewTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">View Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Template Key</label>
                    <div class="form-control-plaintext"><code id="view-template-key"></code></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Category</label>
                    <div class="form-control-plaintext" id="view-category"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Required Variables</label>
                    <div class="form-control-plaintext"><code id="view-variables"></code></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Template Text</label>
                    <pre class="border rounded p-3 bg-light"><code id="view-template-text"></code></pre>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">LLM Enhancement</label>
                    <div class="form-control-plaintext" id="view-llm-support"></div>
                </div>
                <div class="mb-3" id="view-enhancement-prompt-section" style="display: none;">
                    <label class="form-label fw-bold">Enhancement Prompt</label>
                    <pre class="border rounded p-3 bg-light"><code id="view-enhancement-prompt"></code></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Template Modal -->
<div class="modal fade" id="editTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-template-id">
                <div class="mb-3">
                    <label class="form-label fw-bold">Template Key</label>
                    <div class="form-control-plaintext"><code id="edit-template-key"></code></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Category</label>
                    <div class="form-control-plaintext" id="edit-category"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Required Variables</label>
                    <div class="form-control-plaintext"><code id="edit-variables"></code></div>
                </div>
                <div class="mb-3">
                    <label for="edit-template-text" class="form-label fw-bold">Template Text (Jinja2)</label>
                    <textarea class="form-control font-monospace" id="edit-template-text" rows="8"></textarea>
                    <small class="text-muted">Use Jinja2 syntax. Variables: {% raw %}{{ variable_name }}{% endraw %}</small>
                </div>
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="edit-supports-llm">
                        <label class="form-check-label" for="edit-supports-llm">
                            Supports LLM Enhancement
                        </label>
                    </div>
                </div>
                <div class="mb-3" id="edit-enhancement-prompt-section">
                    <label for="edit-enhancement-prompt" class="form-label fw-bold">Enhancement Prompt</label>
                    <textarea class="form-control font-monospace" id="edit-enhancement-prompt" rows="6"></textarea>
                    <small class="text-muted">Prompt sent to LLM to enhance template output. Use {% raw %}{{ template_output }}{% endraw %} to reference rendered template.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Update confidence threshold display
function updateConfidenceDisplay(value) {
    document.getElementById('confidence-display').textContent = parseFloat(value).toFixed(2);
}

// Update concurrent chunks display
function updateConcurrentDisplay(value) {
    document.getElementById('concurrent-display').textContent = value;
}

// Save settings forms
['llm', 'nlp', 'provenance', 'processing'].forEach(category => {
    const form = document.getElementById(`${category}-settings-form`);
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {};

            // Collect all form inputs
            form.querySelectorAll('input, select').forEach(input => {
                let value = input.type === 'checkbox' ? input.checked : input.value;
                let dataType = 'string';

                if (input.type === 'checkbox') {
                    dataType = 'boolean';
                } else if (input.type === 'number' || input.type === 'range') {
                    dataType = 'integer';
                    value = parseFloat(value);
                }

                settings[input.id] = {
                    setting_key: input.id,
                    setting_value: value,
                    category: category,
                    data_type: dataType,
                    user_specific: true
                };
            });

            // Save each setting
            for (const [key, data] of Object.entries(settings)) {
                try {
                    const response = await fetch('/settings/update', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to save ${key}`);
                    }
                } catch (error) {
                    alert('Error saving settings: ' + error.message);
                    return;
                }
            }

            alert('Settings saved successfully!');
        });
    }
});

function testLLMConnection() {
    const provider = 'anthropic';

    fetch('/settings/test-llm-connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({provider: provider})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Connection successful!\n\nResponse: ' + data.response);
        } else {
            alert('Connection failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error testing connection: ' + error.message);
    });
}

async function viewTemplate(templateId) {
    try {
        const response = await fetch(`/settings/template/${templateId}`);
        const data = await response.json();

        document.getElementById('view-template-key').textContent = data.template_key;
        document.getElementById('view-category').textContent = data.category;
        document.getElementById('view-variables').textContent = Object.keys(data.variables).join(', ');
        document.getElementById('view-template-text').textContent = data.template_text;

        const llmSupport = data.supports_llm_enhancement ?
            '<span class="badge bg-success">Enabled</span>' :
            '<span class="badge bg-secondary">Disabled</span>';
        document.getElementById('view-llm-support').innerHTML = llmSupport;

        const enhancementSection = document.getElementById('view-enhancement-prompt-section');
        if (data.supports_llm_enhancement && data.llm_enhancement_prompt) {
            document.getElementById('view-enhancement-prompt').textContent = data.llm_enhancement_prompt;
            enhancementSection.style.display = 'block';
        } else {
            enhancementSection.style.display = 'none';
        }

        const modal = new bootstrap.Modal(document.getElementById('viewTemplateModal'));
        modal.show();
    } catch (error) {
        alert('Error loading template: ' + error.message);
    }
}

async function editTemplate(templateId) {
    try {
        const response = await fetch(`/settings/template/${templateId}`);
        const data = await response.json();

        document.getElementById('edit-template-id').value = data.id;
        document.getElementById('edit-template-key').textContent = data.template_key;
        document.getElementById('edit-category').textContent = data.category;
        document.getElementById('edit-variables').textContent = Object.keys(data.variables).join(', ');
        document.getElementById('edit-template-text').value = data.template_text;
        document.getElementById('edit-supports-llm').checked = data.supports_llm_enhancement;
        document.getElementById('edit-enhancement-prompt').value = data.llm_enhancement_prompt || '';

        toggleEnhancementPrompt();

        const modal = new bootstrap.Modal(document.getElementById('editTemplateModal'));
        modal.show();
    } catch (error) {
        alert('Error loading template: ' + error.message);
    }
}

async function saveTemplate() {
    const templateId = document.getElementById('edit-template-id').value;
    const templateText = document.getElementById('edit-template-text').value;
    const supportsLlm = document.getElementById('edit-supports-llm').checked;
    const enhancementPrompt = document.getElementById('edit-enhancement-prompt').value;

    try {
        const response = await fetch(`/settings/template/${templateId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                template_text: templateText,
                supports_llm_enhancement: supportsLlm,
                llm_enhancement_prompt: enhancementPrompt
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('Template saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('editTemplateModal')).hide();
            location.reload();
        } else {
            alert('Error saving template: ' + data.error);
        }
    } catch (error) {
        alert('Error saving template: ' + error.message);
    }
}

function toggleEnhancementPrompt() {
    const supportsLlm = document.getElementById('edit-supports-llm').checked;
    const section = document.getElementById('edit-enhancement-prompt-section');
    section.style.display = supportsLlm ? 'block' : 'none';
}

document.getElementById('edit-supports-llm')?.addEventListener('change', toggleEnhancementPrompt);
</script>
{% endblock %}
