{% extends "base.html" %}

{% block title %}Settings - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12">
            <h2><i class="fas fa-cog me-2"></i>Settings</h2>
            <p class="text-muted">Configure OntExtract for your workflow</p>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-12">
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'llm' %}active{% endif %}"
                            id="llm-tab" data-bs-toggle="tab" data-bs-target="#llm"
                            type="button" role="tab">
                        <i class="fas fa-robot me-2"></i>LLM Integration
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'processing' %}active{% endif %}"
                            id="processing-tab" data-bs-toggle="tab" data-bs-target="#processing"
                            type="button" role="tab">
                        <i class="fas fa-cogs me-2"></i>Processing
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'nlp' %}active{% endif %}"
                            id="nlp-tab" data-bs-toggle="tab" data-bs-target="#nlp"
                            type="button" role="tab">
                        <i class="fas fa-brain me-2"></i>NLP Tools
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'prompts' %}active{% endif %}"
                            id="prompts-tab" data-bs-toggle="tab" data-bs-target="#prompts"
                            type="button" role="tab">
                        <i class="fas fa-file-alt me-2"></i>Prompt Templates
                    </button>
                </li>
                <!-- UI Preferences tab hidden - theme switching not yet implemented -->
                <!--
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'ui' %}active{% endif %}"
                            id="ui-tab" data-bs-toggle="tab" data-bs-target="#ui"
                            type="button" role="tab">
                        <i class="fas fa-palette me-2"></i>UI Preferences
                    </button>
                </li>
                -->
            </ul>

            <div class="tab-content mt-4" id="settingsTabContent">
                <!-- LLM Integration Tab -->
                <div class="tab-pane fade {% if active_tab == 'llm' %}show active{% endif %}"
                     id="llm" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">LLM Integration Settings</h5>
                            <p class="text-muted">
                                Configure LLM-assisted processing suggestions. When enabled, the LLM
                                will analyze your experiment description and suggest optimal processing methods.
                            </p>

                            <form id="llm-settings-form">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               id="enable_llm_enhancement"
                                               {% if settings.llm.enable_llm_enhancement %}checked{% endif %}>
                                        <label class="form-check-label" for="enable_llm_enhancement">
                                            <strong>Enable LLM Processing Suggestions</strong>
                                            <small class="d-block text-muted">
                                                LLM will analyze experiment descriptions and suggest processing methods
                                            </small>
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="default_llm_provider" class="form-label">LLM Provider</label>
                                    <select class="form-select" id="default_llm_provider">
                                        <option value="anthropic" {% if settings.llm.default_llm_provider == 'anthropic' %}selected{% endif %}>
                                            Anthropic (Claude)
                                        </option>
                                        <option value="openai" {% if settings.llm.default_llm_provider == 'openai' %}selected{% endif %}>
                                            OpenAI (GPT)
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="llm_model" class="form-label">Model</label>
                                    <select class="form-select" id="llm_model">
                                        <option value="claude-3-5-sonnet-20241022"
                                                {% if settings.llm.llm_model == 'claude-3-5-sonnet-20241022' %}selected{% endif %}>
                                            Claude 3.5 Sonnet
                                        </option>
                                        <option value="gpt-4"
                                                {% if settings.llm.llm_model == 'gpt-4' %}selected{% endif %}>
                                            GPT-4
                                        </option>
                                        <option value="gpt-3.5-turbo"
                                                {% if settings.llm.llm_model == 'gpt-3.5-turbo' %}selected{% endif %}>
                                            GPT-3.5 Turbo
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="llm_max_tokens" class="form-label">Max Tokens</label>
                                    <input type="number" class="form-control" id="llm_max_tokens"
                                           value="{{ settings.llm.llm_max_tokens }}" min="100" max="4000">
                                    <small class="text-muted">Maximum response length (100-4000)</small>
                                </div>

                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> API keys are read from environment variables
                                    (ANTHROPIC_API_KEY or OPENAI_API_KEY). Set these before enabling LLM features.
                                </div>

                                <button type="button" class="btn btn-outline-primary" onclick="testLLMConnection()">
                                    <i class="fas fa-plug me-2"></i>Test Connection
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Processing Tab -->
                <div class="tab-pane fade {% if active_tab == 'processing' %}show active{% endif %}"
                     id="processing" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Processing Defaults</h5>
                            <p class="text-muted">
                                Default processing methods. LLM can suggest alternatives based on experiment context.
                            </p>

                            <form id="processing-settings-form">
                                <div class="mb-3">
                                    <label for="default_segmentation_method" class="form-label">Segmentation Method</label>
                                    <select class="form-select" id="default_segmentation_method">
                                        <option value="paragraph" {% if settings.processing.default_segmentation_method == 'paragraph' %}selected{% endif %}>
                                            Paragraph
                                        </option>
                                        <option value="sentence" {% if settings.processing.default_segmentation_method == 'sentence' %}selected{% endif %}>
                                            Sentence
                                        </option>
                                        <option value="semantic" {% if settings.processing.default_segmentation_method == 'semantic' %}selected{% endif %}>
                                            Semantic
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="default_embedding_model" class="form-label">Embedding Model</label>
                                    <select class="form-select" id="default_embedding_model">
                                        <option value="all-MiniLM-L6-v2" {% if settings.processing.default_embedding_model == 'all-MiniLM-L6-v2' %}selected{% endif %}>
                                            all-MiniLM-L6-v2 (Fast, General)
                                        </option>
                                        <option value="all-mpnet-base-v2" {% if settings.processing.default_embedding_model == 'all-mpnet-base-v2' %}selected{% endif %}>
                                            all-mpnet-base-v2 (Better Quality)
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="max_segment_length" class="form-label">Max Segment Length (tokens)</label>
                                    <input type="number" class="form-control" id="max_segment_length"
                                           value="{{ settings.processing.max_segment_length }}" min="128" max="2048">
                                </div>

                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               id="enable_period_aware_processing"
                                               {% if settings.processing.enable_period_aware_processing %}checked{% endif %}>
                                        <label class="form-check-label" for="enable_period_aware_processing">
                                            Enable Period-Aware Processing
                                            <small class="d-block text-muted">
                                                Use historical embedding models for older documents
                                            </small>
                                        </label>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="resetCategory('processing')">
                                    <i class="fas fa-undo me-2"></i>Reset to Defaults
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- NLP Tools Tab -->
                <div class="tab-pane fade {% if active_tab == 'nlp' %}show active{% endif %}"
                     id="nlp" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">NLP Tool Configuration</h5>
                            <p class="text-muted">Configure SpaCy, NLTK, and other NLP tools</p>

                            <form id="nlp-settings-form">
                                <div class="mb-3">
                                    <label for="spacy_model" class="form-label">SpaCy Model</label>
                                    <select class="form-select" id="spacy_model">
                                        <option value="en_core_web_sm" {% if settings.nlp.spacy_model == 'en_core_web_sm' %}selected{% endif %}>
                                            en_core_web_sm (Small, Fast)
                                        </option>
                                        <option value="en_core_web_md" {% if settings.nlp.spacy_model == 'en_core_web_md' %}selected{% endif %}>
                                            en_core_web_md (Medium)
                                        </option>
                                        <option value="en_core_web_lg" {% if settings.nlp.spacy_model == 'en_core_web_lg' %}selected{% endif %}>
                                            en_core_web_lg (Large, Best Quality)
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="default_language" class="form-label">Default Language</label>
                                    <input type="text" class="form-control" id="default_language"
                                           value="{{ settings.nlp.default_language }}">
                                </div>

                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               id="enable_lemmatization"
                                               {% if settings.nlp.enable_lemmatization %}checked{% endif %}>
                                        <label class="form-check-label" for="enable_lemmatization">
                                            Enable Lemmatization
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               id="enable_pos_tagging"
                                               {% if settings.nlp.enable_pos_tagging %}checked{% endif %}>
                                        <label class="form-check-label" for="enable_pos_tagging">
                                            Enable POS Tagging
                                        </label>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Prompt Templates Tab -->
                <div class="tab-pane fade {% if active_tab == 'prompts' %}show active{% endif %}"
                     id="prompts" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Prompt Templates</h5>
                            <p class="text-muted">Manage Jinja2 templates for experiment descriptions</p>

                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Template</th>
                                            <th>Category</th>
                                            <th>Variables</th>
                                            <th>LLM +</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                        <tr>
                                            <td><code>{{ template.template_key }}</code></td>
                                            <td>{{ template.category }}</td>
                                            <td><small>{{ template.variables.keys() | list | join(', ') }}</small></td>
                                            <td>
                                                {% if template.supports_llm_enhancement %}
                                                <span class="badge bg-success">Yes</span>
                                                {% else %}
                                                <span class="badge bg-secondary">No</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-info me-2"
                                                        onclick="viewTemplate({{ template.id }})">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary"
                                                        onclick="editTemplate({{ template.id }})">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UI Preferences Tab - hidden until theme switching is implemented -->
                <!--
                <div class="tab-pane fade {% if active_tab == 'ui' %}show active{% endif %}"
                     id="ui" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">UI Preferences</h5>
                            <p class="text-muted">Customize the user interface</p>

                            <form id="ui-settings-form">
                                <div class="mb-3">
                                    <label for="theme" class="form-label">Theme</label>
                                    <select class="form-select" id="theme">
                                        <option value="darkly" {% if settings.ui.theme == 'darkly' %}selected{% endif %}>
                                            Darkly (Dark Mode)
                                        </option>
                                        <option value="flatly" {% if settings.ui.theme == 'flatly' %}selected{% endif %}>
                                            Flatly (Light Mode)
                                        </option>
                                    </select>
                                    <small class="text-muted">Note: Theme change requires page reload</small>
                                </div>

                                <div class="mb-3">
                                    <label for="items_per_page" class="form-label">Items Per Page</label>
                                    <input type="number" class="form-control" id="items_per_page"
                                           value="{{ settings.ui.items_per_page }}" min="10" max="100">
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                -->
            </div>
        </div>
    </div>
</div>

<!-- View Template Modal -->
<div class="modal fade" id="viewTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">View Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Template Key</label>
                    <div class="form-control-plaintext"><code id="view-template-key"></code></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Category</label>
                    <div class="form-control-plaintext" id="view-category"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Required Variables</label>
                    <div class="form-control-plaintext"><code id="view-variables"></code></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Template Text</label>
                    <pre class="border rounded p-3 bg-light"><code id="view-template-text"></code></pre>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">LLM Enhancement</label>
                    <div class="form-control-plaintext" id="view-llm-support"></div>
                </div>
                <div class="mb-3" id="view-enhancement-prompt-section" style="display: none;">
                    <label class="form-label fw-bold">Enhancement Prompt</label>
                    <pre class="border rounded p-3 bg-light"><code id="view-enhancement-prompt"></code></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Template Modal -->
<div class="modal fade" id="editTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-template-id">
                <div class="mb-3">
                    <label class="form-label fw-bold">Template Key</label>
                    <div class="form-control-plaintext"><code id="edit-template-key"></code></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Category</label>
                    <div class="form-control-plaintext" id="edit-category"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Required Variables</label>
                    <div class="form-control-plaintext"><code id="edit-variables"></code></div>
                </div>
                <div class="mb-3">
                    <label for="edit-template-text" class="form-label fw-bold">Template Text (Jinja2)</label>
                    <textarea class="form-control font-monospace" id="edit-template-text" rows="8"></textarea>
                    <small class="text-muted">Use Jinja2 syntax. Variables: {% raw %}{{ variable_name }}{% endraw %}</small>
                </div>
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="edit-supports-llm">
                        <label class="form-check-label" for="edit-supports-llm">
                            Supports LLM Enhancement
                        </label>
                    </div>
                </div>
                <div class="mb-3" id="edit-enhancement-prompt-section">
                    <label for="edit-enhancement-prompt" class="form-label fw-bold">Enhancement Prompt</label>
                    <textarea class="form-control font-monospace" id="edit-enhancement-prompt" rows="6"></textarea>
                    <small class="text-muted">Prompt sent to LLM to enhance template output. Use {% raw %}{{ template_output }}{% endraw %} to reference rendered template.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Save settings forms
['llm', 'processing', 'nlp', 'ui'].forEach(category => {
    const form = document.getElementById(`${category}-settings-form`);
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const settings = {};

            // Collect all form inputs
            form.querySelectorAll('input, select').forEach(input => {
                let value = input.type === 'checkbox' ? input.checked : input.value;
                settings[input.id] = {
                    setting_key: input.id,
                    setting_value: value,
                    category: category,
                    data_type: input.type === 'checkbox' ? 'boolean' :
                              input.type === 'number' ? 'integer' : 'string',
                    user_specific: true
                };
            });

            // Save each setting
            for (const [key, data] of Object.entries(settings)) {
                try {
                    const response = await fetch('/settings/update', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to save ${key}`);
                    }
                } catch (error) {
                    alert('Error saving settings: ' + error.message);
                    return;
                }
            }

            alert('Settings saved successfully!');
        });
    }
});

function testLLMConnection() {
    const provider = document.getElementById('default_llm_provider').value;

    fetch('/settings/test-llm-connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({provider: provider})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Connection successful!\\n\\nResponse: ' + data.response);
        } else {
            alert('Connection failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error testing connection: ' + error.message);
    });
}

function resetCategory(category) {
    if (confirm(`Reset all ${category} settings to system defaults?`)) {
        window.location.href = `/settings/reset/${category}`;
    }
}

async function viewTemplate(templateId) {
    try {
        const response = await fetch(`/settings/template/${templateId}`);
        const data = await response.json();

        document.getElementById('view-template-key').textContent = data.template_key;
        document.getElementById('view-category').textContent = data.category;
        document.getElementById('view-variables').textContent = Object.keys(data.variables).join(', ');
        document.getElementById('view-template-text').textContent = data.template_text;

        const llmSupport = data.supports_llm_enhancement ?
            '<span class="badge bg-success">Enabled</span>' :
            '<span class="badge bg-secondary">Disabled</span>';
        document.getElementById('view-llm-support').innerHTML = llmSupport;

        const enhancementSection = document.getElementById('view-enhancement-prompt-section');
        if (data.supports_llm_enhancement && data.llm_enhancement_prompt) {
            document.getElementById('view-enhancement-prompt').textContent = data.llm_enhancement_prompt;
            enhancementSection.style.display = 'block';
        } else {
            enhancementSection.style.display = 'none';
        }

        const modal = new bootstrap.Modal(document.getElementById('viewTemplateModal'));
        modal.show();
    } catch (error) {
        alert('Error loading template: ' + error.message);
    }
}

async function editTemplate(templateId) {
    try {
        const response = await fetch(`/settings/template/${templateId}`);
        const data = await response.json();

        document.getElementById('edit-template-id').value = data.id;
        document.getElementById('edit-template-key').textContent = data.template_key;
        document.getElementById('edit-category').textContent = data.category;
        document.getElementById('edit-variables').textContent = Object.keys(data.variables).join(', ');
        document.getElementById('edit-template-text').value = data.template_text;
        document.getElementById('edit-supports-llm').checked = data.supports_llm_enhancement;
        document.getElementById('edit-enhancement-prompt').value = data.llm_enhancement_prompt || '';

        toggleEnhancementPrompt();

        const modal = new bootstrap.Modal(document.getElementById('editTemplateModal'));
        modal.show();
    } catch (error) {
        alert('Error loading template: ' + error.message);
    }
}

async function saveTemplate() {
    const templateId = document.getElementById('edit-template-id').value;
    const templateText = document.getElementById('edit-template-text').value;
    const supportsLlm = document.getElementById('edit-supports-llm').checked;
    const enhancementPrompt = document.getElementById('edit-enhancement-prompt').value;

    try {
        const response = await fetch(`/settings/template/${templateId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                template_text: templateText,
                supports_llm_enhancement: supportsLlm,
                llm_enhancement_prompt: enhancementPrompt
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('Template saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('editTemplateModal')).hide();
            location.reload();
        } else {
            alert('Error saving template: ' + data.error);
        }
    } catch (error) {
        alert('Error saving template: ' + error.message);
    }
}

function toggleEnhancementPrompt() {
    const supportsLlm = document.getElementById('edit-supports-llm').checked;
    const section = document.getElementById('edit-enhancement-prompt-section');
    section.style.display = supportsLlm ? 'block' : 'none';
}

document.getElementById('edit-supports-llm')?.addEventListener('change', toggleEnhancementPrompt);
</script>
{% endblock %}
