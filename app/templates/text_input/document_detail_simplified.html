{% extends "base.html" %}

{% block title %}{{ document.title }} - OntExtract{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <!-- Document Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div class="flex-grow-1">
                    <h1 class="h3 mb-2">{{ document.title }}</h1>

                    <!-- Version Selector -->
                    {% if version_family and version_family|length > 1 %}
                    <div class="d-flex align-items-center mb-2">
                        <label class="text-muted me-2 mb-0">Version:</label>
                        <select class="form-select form-select-sm" style="width: auto;"
                                onchange="window.location.href='/input/document/' + this.value">
                            {% for version in version_family %}
                            <option value="{{ version.uuid }}"
                                    {% if version.id == document.id %}selected{% endif %}>
                                v{{ version.version_number }} - {{ version.version_type|title }}
                                {% if version.is_latest_version() %} (Latest){% endif %}
                            </option>
                            {% endfor %}
                        </select>

                        {% if not is_latest_version %}
                        <span class="badge bg-warning ms-2">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Older Version
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="text-muted">
                        <i class="fas fa-calendar me-2"></i>Created {{ document.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                        {% if document.content_type == 'file' %}
                        <br><i class="fas fa-file me-2"></i>{{ document.original_filename }}
                        {% if document.file_size %}
                        ({{ "%.1f"|format(document.file_size / 1024) }} KB)
                        {% endif %}
                        {% endif %}
                        {% if temporal_metadata %}
                        <br><i class="fas fa-book me-2"></i>{{ temporal_metadata.publication_year }} - {{ temporal_metadata.discipline|title }}
                        {% elif document.detected_language %}
                        <br><i class="fas fa-language me-2"></i>{{ document.detected_language.upper() }}
                        {% if document.language_confidence %}
                        ({{ "%.0f"|format(document.language_confidence * 100) }}% confidence)
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% if current_user.is_authenticated %}
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportDocument('{{ document.uuid }}')">
                                <i class="fas fa-download me-2"></i>Export
                            </a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteDocument('{{ document.uuid }}')">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a></li>
                    </ul>
                </div>
                {% endif %}
            </div>

            <!-- Document Metadata -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <button class="btn btn-link text-decoration-none p-0 text-start w-100" type="button"
                            data-bs-toggle="collapse" data-bs-target="#metadataCollapse"
                            aria-expanded="{% if document.source_metadata or temporal_metadata %}true{% else %}false{% endif %}">
                            <i class="fas fa-info-circle me-2"></i>Document Metadata
                            {% if document.source_metadata and document.source_metadata.get('zotero_key') %}
                            <span class="badge bg-success ms-2">Zotero Enhanced</span>
                            {% elif document.metadata_provenance and document.metadata_provenance.items() | selectattr('1.source', 'equalto', 'crossref_auto') | list | length > 0 %}
                            <span class="badge bg-success ms-2">CrossRef Enhanced</span>
                            {% elif document.source_metadata %}
                            <span class="badge bg-primary ms-2">Manual Entry</span>
                            {% elif temporal_metadata %}
                            <span class="badge bg-info ms-2">Temporal Metadata</span>
                            {% else %}
                            <span class="badge bg-secondary ms-2">Empty</span>
                            {% endif %}
                            <i class="fas fa-chevron-down float-end mt-1"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse {% if document.source_metadata and (document.source_metadata.get('zotero_key') or document.source_metadata.get('title') or document.source_metadata.get('authors')) %}show{% elif temporal_metadata %}show{% endif %}"
                    id="metadataCollapse">
                    <div class="card-body">
                        {% if temporal_metadata %}
                        <!-- Temporal Metadata Section -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">Publication Year</label>
                                <div class="form-control-plaintext py-1">{{ temporal_metadata.publication_year or '—' }}</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">Discipline</label>
                                <div class="form-control-plaintext py-1">{{ temporal_metadata.discipline|title if temporal_metadata.discipline else '—' }}</div>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label text-muted small mb-1">Key Definition</label>
                                <div class="form-control-plaintext py-1 small">{{ temporal_metadata.key_definition or '—' }}</div>
                            </div>
                        </div>
                        {% endif %}

                        {% if document.source_metadata %}
                        <!-- Zotero Metadata (if available) -->
                        {% if document.source_metadata.get('zotero_key') %}
                        <div class="alert alert-success">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Enhanced with Zotero Metadata</strong>
                                <span class="ms-auto">
                                    <span class="badge bg-light text-dark">Key: {{ document.source_metadata.zotero_key }}</span>
                                    {% if document.source_metadata.get('zotero_match_score') %}
                                    <span class="badge bg-light text-dark">Match: {{ "%.0f"|format(document.source_metadata.zotero_match_score * 100) }}%</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Metadata Fields -->
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">Title</label>
                                <div class="form-control-plaintext py-1">{{ document.title or '—' }}</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">Authors</label>
                                <div class="form-control-plaintext py-1">
                                    {% if document.source_metadata.get('authors') %}
                                        {% if document.source_metadata.authors is string %}
                                        {{ document.source_metadata.authors }}
                                        {% elif document.source_metadata.authors is sequence %}
                                        {{ document.source_metadata.authors|join(', ') }}
                                        {% endif %}
                                    {% else %}
                                    —
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">Publication Date</label>
                                <div class="form-control-plaintext py-1">{{ document.source_metadata.get('publication_date', document.source_metadata.get('publication_year', '—')) }}</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">Journal/Publisher</label>
                                <div class="form-control-plaintext py-1">{{ document.source_metadata.get('journal', '—') }}</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">Publisher</label>
                                <div class="form-control-plaintext py-1">{{ document.source_metadata.get('publisher', '—') }}</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">Type</label>
                                <div class="form-control-plaintext py-1">{{ document.source_metadata.get('type', '—') }}</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">DOI</label>
                                <div class="form-control-plaintext py-1">
                                    {% if document.source_metadata.get('doi') %}
                                    <a href="https://doi.org/{{ document.source_metadata.doi }}" target="_blank"
                                        class="text-decoration-none">
                                        {{ document.source_metadata.doi }} <i class="fas fa-external-link-alt ms-1 small"></i>
                                    </a>
                                    {% else %}
                                    —
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-muted small mb-1">ISBN</label>
                                <div class="form-control-plaintext py-1">{{ document.source_metadata.get('isbn', '—') }}</div>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label text-muted small mb-1">URL</label>
                                <div class="form-control-plaintext py-1">
                                    {% if document.source_metadata.get('url') %}
                                    <a href="{{ document.source_metadata.url }}" target="_blank"
                                        class="text-decoration-none">
                                        {{ document.source_metadata.url }} <i class="fas fa-external-link-alt ms-1 small"></i>
                                    </a>
                                    {% else %}
                                    —
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label text-muted small mb-1">Abstract</label>
                                <div class="form-control-plaintext py-1 small">{{ document.source_metadata.get('abstract', '—') }}</div>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label text-muted small mb-1">Citation</label>
                                <div class="form-control-plaintext py-1 small">{{ document.source_metadata.get('citation', '—') }}</div>
                            </div>
                        </div>

                        <!-- Action buttons -->
                        {% if current_user.is_authenticated %}
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="editMetadata('{{ document.uuid }}')">
                                <i class="fas fa-edit me-1"></i>Edit Metadata
                            </button>
                        </div>
                        {% endif %}

                        {% elif not temporal_metadata %}
                        <!-- No metadata available -->
                        <div class="text-center py-4">
                            <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No metadata available for this document</p>
                            {% if current_user.is_authenticated %}
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-primary btn-sm" onclick="addMetadata('{{ document.uuid }}')">
                                    <i class="fas fa-plus me-1"></i>Add Metadata
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if not document.source_metadata and temporal_metadata %}
                        <!-- Option to add more detailed metadata -->
                        {% if current_user.is_authenticated %}
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="editMetadata('{{ document.uuid }}')">
                                <i class="fas fa-edit me-1"></i>Add/Edit Metadata
                            </button>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Text Content -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-align-left me-2"></i>Content
                        <span class="badge bg-secondary ms-2">
                            {{ document.content|length|int|filesizeformat if document.content else '0 bytes' }}
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if document.content %}
                    <div class="content-preview" style="max-height: 400px; overflow-y: auto;">
                        <pre class="text-wrap">{{ document.content }}</pre>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleFullContent()">
                            <i class="fas fa-expand me-2"></i>Show Full Content
                        </button>
                    </div>
                    {% else %}
                    <p class="text-muted">No content available</p>
                    {% endif %}
                </div>
            </div>

            <!-- Create Experiment Action -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>Analysis
                    </h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Create an experiment to analyze this document with processing tools like embeddings, segmentation, and entity extraction.
                    </p>
                    <div class="d-grid gap-2">
                        <!-- Primary: Create Experiment -->
                        <a href="{{ url_for('experiments.new') }}" class="btn btn-primary">
                            <i class="fas fa-flask me-2"></i>Create Experiment
                        </a>

                        <!-- Secondary: Analyze this Document -->
                        <a href="{{ url_for('experiments.new',
                                            mode='single_document',
                                            document_uuid=document.uuid,
                                            document_title=document.title) }}"
                           class="btn btn-outline-primary">
                            <i class="fas fa-microscope me-2"></i>Analyze this Document
                        </a>
                    </div>
                </div>
            </div>

            <!-- Related Experiments -->
            {% if this_version_experiments or all_version_experiments %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-flask me-2"></i>Related Experiments
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="expScope" id="expThisVersion" checked autocomplete="off">
                        <label class="btn btn-outline-primary" for="expThisVersion" onclick="showExperimentScope('this')">
                            This Version ({{ this_version_experiments|length }})
                        </label>

                        <input type="radio" class="btn-check" name="expScope" id="expAllVersions" autocomplete="off">
                        <label class="btn btn-outline-primary" for="expAllVersions" onclick="showExperimentScope('all')">
                            All Versions ({{ all_version_experiments|length }})
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <!-- This Version Experiments -->
                    <div id="this-version-exps">
                        {% if this_version_experiments %}
                        {% for exp_doc in this_version_experiments %}
                    <div class="experiment-item border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <a href="{{ url_for('experiments.view', experiment_id=exp_doc.experiment.id) }}"
                                       class="text-decoration-none">
                                        {{ exp_doc.experiment.name }}
                                    </a>
                                </h6>
                                <p class="text-muted small mb-2">
                                    <i class="fas fa-tag me-1"></i>Term:
                                    <strong>{{ exp_doc.experiment.term.term_text if exp_doc.experiment.term else 'No term' }}</strong>
                                </p>
                                {% if exp_doc.processing_results %}
                                <div class="processing-badges">
                                    <small class="text-muted">Processing applied:</small><br>
                                    {% for processing in exp_doc.processing_results %}
                                    <span class="badge bg-secondary me-1 mb-1">
                                        {{ processing.processing_type|title }}: {{ processing.processing_method|title }}
                                        {% if processing.status == 'completed' %}
                                        <i class="fas fa-check-circle text-success ms-1"></i>
                                        {% elif processing.status == 'running' %}
                                        <i class="fas fa-spinner fa-spin text-warning ms-1"></i>
                                        {% elif processing.status == 'failed' %}
                                        <i class="fas fa-exclamation-circle text-danger ms-1"></i>
                                        {% endif %}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <small class="text-muted">No processing applied yet</small>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <small class="text-muted">{{ exp_doc.experiment.created_at.strftime('%m/%d/%Y') }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                        {% else %}
                        <p class="text-muted mb-0">No experiments using this specific version</p>
                        {% endif %}
                    </div>

                    <!-- All Versions Experiments -->
                    <div id="all-version-exps" style="display: none;">
                        {% if all_version_experiments %}
                        {% for exp_doc in all_version_experiments %}
                    <div class="experiment-item border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <!-- Version Badge -->
                                <span class="badge {% if exp_doc.is_current_version %}bg-success{% else %}bg-secondary{% endif %} mb-2">
                                    <i class="fas fa-file-alt me-1"></i>v{{ exp_doc.document_version }} - {{ exp_doc.version_type|title }}
                                    {% if exp_doc.is_current_version %} (Current){% endif %}
                                </span>

                                <h6 class="mb-1">
                                    <a href="{{ url_for('experiments.view', experiment_id=exp_doc.experiment.id) }}"
                                       class="text-decoration-none">
                                        {{ exp_doc.experiment.name }}
                                    </a>
                                </h6>
                                <p class="text-muted small mb-2">
                                    <i class="fas fa-tag me-1"></i>Term:
                                    <strong>{{ exp_doc.experiment.term.term_text if exp_doc.experiment.term else 'No term' }}</strong>
                                </p>
                                {% if exp_doc.processing_results %}
                                <div class="processing-badges">
                                    <small class="text-muted">Processing applied:</small><br>
                                    {% for processing in exp_doc.processing_results %}
                                    <span class="badge bg-secondary me-1 mb-1">
                                        {{ processing.processing_type|title }}: {{ processing.processing_method|title }}
                                        {% if processing.status == 'completed' %}
                                        <i class="fas fa-check-circle text-success ms-1"></i>
                                        {% elif processing.status == 'running' %}
                                        <i class="fas fa-spinner fa-spin text-warning ms-1"></i>
                                        {% elif processing.status == 'failed' %}
                                        <i class="fas fa-exclamation-circle text-danger ms-1"></i>
                                        {% endif %}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <small class="text-muted">No processing applied yet</small>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <small class="text-muted">{{ exp_doc.experiment.created_at.strftime('%m/%d/%Y') }}</small>
                            </div>
                        </div>
                    </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted mb-0">No experiments across any version</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- Document Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Statistics
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="border-end">
                                <h4 class="text-primary mb-1">
                                    {{ document.content.split()|length if document.content else 0 }}
                                </h4>
                                <small class="text-muted">Words</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <h4 class="text-info mb-1">
                                {{ document.content|length if document.content else 0 }}
                            </h4>
                            <small class="text-muted">Characters</small>
                        </div>
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-success mb-1">
                                    {{ document_experiments|length if document_experiments else 0 }}
                                </h4>
                                <small class="text-muted">Experiments</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning mb-1">
                                {{ total_processing_count or 0 }}
                            </h4>
                            <small class="text-muted">Processing Results</small>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-12">
                            <div class="d-flex align-items-center justify-content-center">
                                {% if document.status == 'uploaded' %}
                                <span class="badge bg-primary">Uploaded</span>
                                {% elif document.status == 'processing' %}
                                <span class="badge bg-warning">Processing</span>
                                {% elif document.status == 'completed' %}
                                <span class="badge bg-success">Completed</span>
                                {% elif document.status == 'error' %}
                                <span class="badge bg-danger">Error</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metadata Provenance (PROV-O) - Sidebar -->
            {% if document.metadata_provenance or document_provenance_activities %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>Metadata Provenance
                        <span class="badge bg-info ms-1" style="font-size: 0.7rem;">PROV-O</span>
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        Metadata extraction and updates tracked with PROV-O standard.
                    </p>

                    {% set crossref_count = namespace(value=0) %}
                    {% if document.metadata_provenance %}
                    {% for field_name, prov_data in document.metadata_provenance.items() %}
                        {% if prov_data.get('source') == 'crossref_auto' %}
                            {% set crossref_count.value = crossref_count.value + 1 %}
                        {% endif %}
                    {% endfor %}
                    {% endif %}

                    {% if crossref_count.value > 0 %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-success">
                                <i class="fas fa-book-medical me-1"></i>CrossRef API
                            </span>
                            <span class="text-muted small">{{ crossref_count.value }} fields extracted</span>
                        </div>
                        <div class="p-2 bg-light border rounded">
                            <small class="text-muted">
                                Metadata automatically retrieved from CrossRef using DOI or title search.
                                {% if document.metadata_provenance.get('match_score') and document.metadata_provenance.match_score.get('raw_value') %}
                                <br>
                                <strong>Match Score: {{ "%.2f"|format(document.metadata_provenance.match_score.raw_value) }}</strong>
                                <a href="https://www.crossref.org/documentation/retrieve-metadata/rest-api/tips-for-using-the-crossref-rest-api/"
                                   target="_blank"
                                   class="text-muted text-decoration-none ms-1"
                                   title="CrossRef relevance score documentation">
                                    <i class="fas fa-question-circle"></i>
                                </a>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endif %}

                    {% if document.metadata_provenance and document.metadata_provenance.get('extracted_doi') %}
                    <div class="mb-3 p-2 bg-light rounded">
                        <div class="small">
                            <strong><i class="fas fa-microscope me-1"></i>PDF Extraction:</strong><br>
                            <span class="text-muted">DOI: {{ document.metadata_provenance.extracted_doi.raw_value[:30] }}{{ '...' if document.metadata_provenance.extracted_doi.raw_value|length > 30 }}</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if document_provenance_activities %}
                    <div class="mb-3">
                        <strong class="small d-block mb-2">
                            <i class="fas fa-edit me-1"></i>Recent Activity
                        </strong>
                        {% for item in document_provenance_activities[:3] %}
                        {% set activity_type = item.activity.type %}
                        {% set params = item.activity.parameters %}
                        <div class="p-2 mb-2 bg-light border-start border-3 {% if activity_type == 'metadata_field_update' %}border-primary{% else %}border-secondary{% endif %} rounded-end">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <small class="d-block fw-bold">
                                        {% if activity_type == 'metadata_field_update' %}
                                            Field Update: {{ params.field_name|title }}
                                        {% elif activity_type == 'metadata_update' %}
                                            Metadata Updated
                                        {% elif activity_type == 'metadata_extraction' %}
                                            {{ params.extraction_source|title }} Extraction
                                        {% elif activity_type == 'metadata_extraction_pdf' %}
                                            PDF Identifier Extraction
                                        {% elif activity_type == 'text_extraction' %}
                                            Text Extraction ({{ params.extraction_method }})
                                        {% elif activity_type == 'document_save' %}
                                            Document Saved
                                        {% elif activity_type == 'document_upload' %}
                                            Document Uploaded
                                        {% elif activity_type == 'document_segmentation' %}
                                            Segmentation ({{ params.method }}: {{ params.segment_count }} segments)
                                        {% elif activity_type == 'embedding_generation' %}
                                            Embeddings ({{ params.model_name }})
                                        {% else %}
                                            {{ activity_type|replace('_', ' ')|title }}
                                        {% endif %}
                                    </small>
                                </div>
                                <small class="text-muted text-nowrap ms-2">
                                    {% if item.activity.started_at %}
                                        {% set dt_str = item.activity.started_at[:16]|replace('T', ' ') %}
                                        {{ dt_str[5:] }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="text-center">
                        <a href="{{ url_for('provenance.timeline', document_uuid=document.uuid) }}" class="btn btn-outline-primary btn-sm w-100">
                            <i class="fas fa-stream me-1"></i>Full Timeline
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showExperimentScope(scope) {
        const thisVersionDiv = document.getElementById('this-version-exps');
        const allVersionsDiv = document.getElementById('all-version-exps');

        if (scope === 'this') {
            thisVersionDiv.style.display = 'block';
            allVersionsDiv.style.display = 'none';
        } else {
            thisVersionDiv.style.display = 'none';
            allVersionsDiv.style.display = 'block';
        }
    }

    function toggleFullContent() {
        const preview = document.querySelector('.content-preview');
        const button = event.target;

        if (preview.style.maxHeight === '400px' || !preview.style.maxHeight) {
            preview.style.maxHeight = 'none';
            button.innerHTML = '<i class="fas fa-compress me-2"></i>Show Less';
        } else {
            preview.style.maxHeight = '400px';
            button.innerHTML = '<i class="fas fa-expand me-2"></i>Show Full Content';
        }
    }

    function deleteDocument(documentUuid) {
        if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
            fetch(`/input/document/${documentUuid}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "{{ url_for('text_input.document_list') }}";
                } else {
                    alert('Error deleting document: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting document');
            });
        }
    }

    function exportDocument(documentId) {
        alert('Document export feature coming soon!');
    }

    function editMetadata(documentUuid) {
        // Fetch current metadata
        fetch(`/input/document/${documentUuid}/metadata`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Check if metadata exists
                    const hasMetadata = data.metadata && Object.keys(data.metadata).length > 0;

                    if (hasMetadata) {
                        populateMetadataModal(data.metadata);
                    } else {
                        // Clear form for adding new metadata
                        document.getElementById('metadataForm').reset();
                        document.getElementById('metadataModalTitle').textContent = 'Add Metadata';
                    }

                    document.getElementById('metadataModalDocumentUuid').value = documentUuid;
                    new bootstrap.Modal(document.getElementById('metadataModal')).show();
                } else {
                    alert('Error loading metadata: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
    }

    function addMetadata(documentUuid) {
        // Clear form and show modal
        document.getElementById('metadataForm').reset();
        document.getElementById('metadataModalDocumentUuid').value = documentUuid;
        document.getElementById('metadataModalTitle').textContent = 'Add Metadata';
        new bootstrap.Modal(document.getElementById('metadataModal')).show();
    }

    function populateMetadataModal(metadata) {
        document.getElementById('metadataModalTitle').textContent = 'Edit Metadata';
        document.getElementById('metadataTitle').value = metadata.title || '';
        document.getElementById('metadataAuthors').value = metadata.authors || '';
        document.getElementById('metadataPublicationDate').value = metadata.publication_date || metadata.publication_year || '';
        document.getElementById('metadataJournal').value = metadata.journal || '';
        document.getElementById('metadataPublisher').value = metadata.publisher || '';
        document.getElementById('metadataType').value = metadata.type || '';
        document.getElementById('metadataDoi').value = metadata.doi || '';
        document.getElementById('metadataIsbn').value = metadata.isbn || '';
        document.getElementById('metadataUrl').value = metadata.url || '';
        document.getElementById('metadataAbstract').value = metadata.abstract || '';
        document.getElementById('metadataCitation').value = metadata.citation || '';
    }

    function saveMetadata() {
        const documentUuid = document.getElementById('metadataModalDocumentUuid').value;
        const formData = {
            title: document.getElementById('metadataTitle').value,
            authors: document.getElementById('metadataAuthors').value,
            publication_date: document.getElementById('metadataPublicationDate').value,
            journal: document.getElementById('metadataJournal').value,
            publisher: document.getElementById('metadataPublisher').value,
            type: document.getElementById('metadataType').value,
            doi: document.getElementById('metadataDoi').value,
            isbn: document.getElementById('metadataIsbn').value,
            url: document.getElementById('metadataUrl').value,
            abstract: document.getElementById('metadataAbstract').value,
            citation: document.getElementById('metadataCitation').value
        };

        fetch(`/input/document/${documentUuid}/metadata`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('metadataModal')).hide();
                location.reload();
            } else {
                alert('Error saving metadata: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }

    function enrichWithZotero(documentId) {
        alert('Zotero enhancement feature coming soon!');
    }
</script>

<!-- Metadata Edit Modal -->
<div class="modal fade" id="metadataModal" tabindex="-1" aria-labelledby="metadataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="metadataModalTitle">Edit Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="metadataForm">
                    <input type="hidden" id="metadataModalDocumentUuid">

                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="metadataTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="metadataTitle">
                        </div>

                        <div class="col-md-6">
                            <label for="metadataAuthors" class="form-label">Authors</label>
                            <input type="text" class="form-control" id="metadataAuthors" placeholder="Author 1, Author 2">
                            <div class="form-text">Comma-separated list</div>
                        </div>

                        <div class="col-md-6">
                            <label for="metadataPublicationDate" class="form-label">Publication Date/Year</label>
                            <input type="text" class="form-control" id="metadataPublicationDate" placeholder="2024 or 2024-01-15">
                        </div>

                        <div class="col-md-6">
                            <label for="metadataJournal" class="form-label">Journal/Publisher</label>
                            <input type="text" class="form-control" id="metadataJournal">
                        </div>

                        <div class="col-md-6">
                            <label for="metadataPublisher" class="form-label">Publisher</label>
                            <input type="text" class="form-control" id="metadataPublisher">
                        </div>

                        <div class="col-md-12">
                            <label for="metadataType" class="form-label">Type</label>
                            <input type="text" class="form-control" id="metadataType" placeholder="e.g., journal-article, book, conference-paper">
                        </div>

                        <div class="col-md-6">
                            <label for="metadataDoi" class="form-label">DOI</label>
                            <input type="text" class="form-control" id="metadataDoi" placeholder="10.1234/example">
                        </div>

                        <div class="col-md-6">
                            <label for="metadataIsbn" class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="metadataIsbn">
                        </div>

                        <div class="col-md-12">
                            <label for="metadataUrl" class="form-label">URL</label>
                            <input type="url" class="form-control" id="metadataUrl">
                        </div>

                        <div class="col-md-12">
                            <label for="metadataAbstract" class="form-label">Abstract</label>
                            <textarea class="form-control" id="metadataAbstract" rows="4"></textarea>
                        </div>

                        <div class="col-md-12">
                            <label for="metadataCitation" class="form-label">Citation</label>
                            <textarea class="form-control" id="metadataCitation" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMetadata()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}