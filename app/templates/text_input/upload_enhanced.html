{% extends "base.html" %}

{% block title %}Upload Document - OntExtract{% endblock %}

{% block extra_css %}
<style>
.upload-section {
    background: #303030;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    margin-bottom: 20px;
    border: 1px solid #444;
}

.section-header {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #444;
}

.upload-option {
    border: 2px solid #444;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #222;
}

.upload-option:hover {
    border-color: #375a7f;
    background: #2a2a2a;
}

.upload-option.active {
    border-color: #375a7f;
    background: #1a3a52;
}

.metadata-section {
    display: none;
    background: #222;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 20px;
    margin-top: 20px;
}

.metadata-section.show {
    display: block;
}

.metadata-field {
    margin-bottom: 15px;
}

.metadata-label {
    font-weight: 600;
    margin-bottom: 5px;
}

.metadata-source-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-left: 8px;
}

.source-crossref {
    background: #1e4620;
    color: #4dff4d;
    border: 1px solid #28a745;
}

.source-user {
    background: #1a3a52;
    color: #5bc0de;
    border: 1px solid #5bc0de;
}

.source-file {
    background: #4a3a1c;
    color: #ffc107;
    border: 1px solid #ffc107;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 40px;
}

.loading-spinner.active {
    display: block;
}

.metadata-confirmation {
    background: #1a3a52;
    border: 1px solid #375a7f;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12 col-lg-10 col-xl-9">
            <!-- Header -->
            <div class="mb-4">
                <h2>Upload Document</h2>
                <p class="text-muted">
                    Upload a document with automatic metadata extraction from CrossRef.
                    Review and confirm metadata before saving.
                </p>
            </div>

            <!-- Upload Method Selection -->
            <div class="upload-section">
                <div class="section-header">Step 1: Choose Upload Method</div>

                <div class="upload-option active" id="file-option" onclick="selectUploadMethod('file')">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-file-upload fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Upload PDF File</h5>
                            <p class="mb-0 text-muted small">
                                Upload a PDF document. We'll extract bibliographic metadata automatically.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="upload-option" id="doi-option" onclick="selectUploadMethod('doi')">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-link fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Enter DOI</h5>
                            <p class="mb-0 text-muted small">
                                Enter a DOI to retrieve bibliographic metadata from CrossRef. You'll still need to upload the file.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Upload Form -->
            <form id="file-form" class="upload-section" style="display: block;">
                <div class="section-header">Step 2: Upload Document</div>

                <div class="mb-3">
                    <label for="file-input" class="form-label">Select Document (PDF)</label>
                    <input type="file" class="form-control" id="file-input" accept=".pdf" required>
                    <div class="form-text">Upload a PDF file for analysis</div>
                </div>

                <div class="alert alert-info mb-3">
                    <i class="fas fa-magic"></i>
                    <strong>Automatic Metadata Extraction:</strong>
                    Leave fields blank and we'll automatically extract the DOI or title from your PDF, then fetch metadata from CrossRef!
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="file-title" class="form-label">Title (optional)</label>
                        <input type="text" class="form-control" id="file-title" placeholder="Leave blank for automatic extraction">
                        <div class="form-text">If provided, will be used to search CrossRef</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="file-year" class="form-label">Year (optional)</label>
                        <input type="number" class="form-control" id="file-year" placeholder="e.g., 2020" min="1800" max="2026">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="file-authors" class="form-label">Authors (optional)</label>
                    <input type="text" class="form-control" id="file-authors" placeholder="Comma-separated author names">
                </div>

                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-upload"></i> Upload and Extract Metadata
                </button>
            </form>

            <!-- DOI Form -->
            <form id="doi-form" class="upload-section" style="display: none;">
                <div class="section-header">Step 2: Enter DOI</div>

                <div class="mb-3">
                    <label for="doi-input" class="form-label">DOI</label>
                    <input type="text" class="form-control" id="doi-input"
                           placeholder="e.g., 10.1145/1234567.1234568 or https://doi.org/10.1145/1234567.1234568" required>
                    <div class="form-text">Enter the Digital Object Identifier</div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-search"></i> Retrieve Metadata from CrossRef
                </button>
            </form>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loading">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted" id="loading-message">Analyzing document and extracting metadata...</p>
                <div id="loading-details" class="small text-muted mt-2"></div>
            </div>

            <!-- Metadata Review Section -->
            <div id="metadata-review" class="metadata-section">
                <div class="section-header">Step 3: Review and Confirm Metadata</div>

                <div class="metadata-confirmation">
                    <i class="fas fa-info-circle"></i>
                    <strong>Please review the extracted metadata below.</strong>
                    You can edit any field before saving. Badges indicate the source of each field.
                </div>

                <form id="metadata-form">
                    <div class="row">
                        <div class="col-md-12 metadata-field">
                            <label for="review-title" class="metadata-label">
                                Title
                                <span id="title-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="text" class="form-control" id="review-title" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 metadata-field">
                            <label for="review-authors" class="metadata-label">
                                Authors
                                <span id="authors-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="text" class="form-control" id="review-authors"
                                   placeholder="Comma-separated author names">
                            <div class="form-text">Comma-separated list of authors</div>
                        </div>
                        <div class="col-md-4 metadata-field">
                            <label for="review-year" class="metadata-label">
                                Publication Year
                                <span id="year-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="number" class="form-control" id="review-year"
                                   min="1800" max="2026">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 metadata-field">
                            <label for="review-journal" class="metadata-label">
                                Journal/Publisher
                                <span id="journal-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="text" class="form-control" id="review-journal">
                        </div>
                        <div class="col-md-6 metadata-field">
                            <label for="review-doi" class="metadata-label">
                                DOI
                                <span id="doi-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="text" class="form-control" id="review-doi">
                        </div>
                    </div>

                    <div class="metadata-field">
                        <label for="review-abstract" class="metadata-label">
                            Abstract
                            <span id="abstract-source-badge" class="metadata-source-badge"></span>
                        </label>
                        <textarea class="form-control" id="review-abstract" rows="4"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 metadata-field">
                            <label for="review-type" class="metadata-label">Document Type</label>
                            <select class="form-select" id="review-type">
                                <option value="journal-article">Journal Article</option>
                                <option value="conference-paper">Conference Paper</option>
                                <option value="book">Book</option>
                                <option value="book-chapter">Book Chapter</option>
                                <option value="thesis">Thesis/Dissertation</option>
                                <option value="report">Technical Report</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 metadata-field">
                            <label for="review-url" class="metadata-label">URL</label>
                            <input type="url" class="form-control" id="review-url">
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-check"></i> Confirm and Save Document
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetUpload()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
console.log('=== Upload Enhanced Script Loading ===');

// Upload state management
let uploadState = {
    currentMethod: 'file',
    extractedMetadata: null,
    tempPath: null,
    currentFileName: null,
    provenance: {}
};

console.log('Upload state initialized:', uploadState);

function selectUploadMethod(method) {
    const fileOption = document.getElementById('file-option');
    const doiOption = document.getElementById('doi-option');
    const fileForm = document.getElementById('file-form');
    const doiForm = document.getElementById('doi-form');

    fileOption.classList.remove('active');
    doiOption.classList.remove('active');

    if (method === 'file') {
        fileOption.classList.add('active');
        fileForm.style.display = 'block';
        doiForm.style.display = 'none';
    } else if (method === 'doi') {
        doiOption.classList.add('active');
        fileForm.style.display = 'none';
        doiForm.style.display = 'block';
    }

    uploadState.currentMethod = method;
}

function showLoading(message = 'Analyzing document and extracting metadata...', details = '') {
    document.getElementById('loading').classList.add('active');
    document.getElementById('loading-message').textContent = message;
    document.getElementById('loading-details').textContent = details;
    document.querySelectorAll('.upload-section').forEach(section => {
        if (section.id !== 'loading') section.style.display = 'none';
    });
}

function hideLoading() {
    document.getElementById('loading').classList.remove('active');
}

function showMetadataReview() {
    console.log('showMetadataReview() called');
    hideLoading();
    const reviewSection = document.getElementById('metadata-review');
    console.log('Metadata review element:', reviewSection);
    if (reviewSection) {
        reviewSection.classList.add('show');
        console.log('Added show class. Element classes:', reviewSection.className);
    } else {
        console.error('metadata-review element not found!');
    }
}

function populateMetadataForm(metadata, provenance) {
    console.log('populateMetadataForm() called');
    console.log('Metadata:', metadata);
    console.log('Provenance:', provenance);

    // Helper to set field value and badge
    const setField = (fieldId, badgeId, value, source) => {
        const field = document.getElementById(fieldId);
        const badge = document.getElementById(badgeId);

        if (field && value != null) {
            if (Array.isArray(value)) {
                field.value = value.join(', ');
            } else {
                field.value = value;
            }
        }

        if (badge && source) {
            badge.textContent = source.toUpperCase();
            badge.className = `metadata-source-badge source-${source}`;
        }
    };

    // Populate fields
    setField('review-title', 'title-source-badge', metadata.title, provenance.title?.source);
    setField('review-authors', 'authors-source-badge', metadata.authors, provenance.authors?.source);
    setField('review-year', 'year-source-badge', metadata.publication_year, provenance.publication_year?.source);
    setField('review-journal', 'journal-source-badge', metadata.journal, provenance.journal?.source);
    setField('review-doi', 'doi-source-badge', metadata.doi, provenance.doi?.source);
    setField('review-abstract', 'abstract-source-badge', metadata.abstract, provenance.abstract?.source);
    setField('review-url', null, metadata.url, null);

    if (metadata.type) {
        document.getElementById('review-type').value = metadata.type;
    }
}

// File upload handler
console.log('Attaching file-form submit handler');
document.getElementById('file-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('File form submitted - JavaScript handler active');

    const fileInput = document.getElementById('file-input');
    const file = fileInput.files[0];

    if (!file) {
        alert('Please select a file');
        console.log('No file selected');
        return;
    }

    console.log('File selected:', file.name, file.size, 'bytes');

    uploadState.currentFileName = file.name;

    const formData = new FormData();
    formData.append('document_file', file);
    formData.append('source_type', 'file');
    formData.append('title', document.getElementById('file-title').value);
    formData.append('publication_year', document.getElementById('file-year').value);
    formData.append('authors', document.getElementById('file-authors').value);

    const title = document.getElementById('file-title').value;
    if (title) {
        showLoading('Uploading document and searching CrossRef...', `Searching for: ${title}`);
    } else {
        // No title provided - system will auto-extract from PDF
        if (file.name.toLowerCase().endsWith('.pdf')) {
            showLoading('Analyzing PDF...', 'Extracting DOI and title from document, then querying CrossRef');
        } else {
            showLoading('Uploading document...', 'No automatic extraction available for this file type');
        }
    }

    try {
        console.log('Uploading to: /upload/extract_metadata');
        const response = await fetch('/upload/extract_metadata', {
            method: 'POST',
            body: formData
        });

        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response data:', result);

        if (result.success) {
            console.log('Upload successful, processing metadata...');
            uploadState.extractedMetadata = result.metadata;
            uploadState.tempPath = result.temp_path;
            uploadState.provenance = result.provenance || {};
            console.log('Updated uploadState:', uploadState);

            console.log('Calling populateMetadataForm...');
            populateMetadataForm(result.metadata, uploadState.provenance);
            console.log('Calling showMetadataReview...');
            showMetadataReview();
            console.log('Metadata review should now be visible');
        } else {
            console.error('Server error:', result.error);
            alert('Error: ' + result.error);
            hideLoading();
        }
    } catch (error) {
        console.error('Upload error:', error);
        alert('Error uploading document: ' + error.message);
        hideLoading();
    }
});

// DOI upload handler
console.log('Attaching doi-form submit handler');
document.getElementById('doi-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('DOI form submitted - JavaScript handler active');

    const doi = document.getElementById('doi-input').value;
    console.log('DOI entered:', doi);

    const formData = new FormData();
    formData.append('source_type', 'doi');
    formData.append('doi', doi);

    showLoading('Retrieving metadata from CrossRef...', `Looking up DOI: ${doi}`);

    try {
        console.log('Looking up DOI:', doi);
        const response = await fetch('/upload/extract_metadata', {
            method: 'POST',
            body: formData
        });

        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response data:', result);

        if (result.success) {
            if (result.needs_file) {
                alert(result.message);
                hideLoading();
                // Switch to file upload mode
                selectUploadMethod('file');
            } else {
                uploadState.extractedMetadata = result.metadata;
                uploadState.tempPath = result.temp_path;
                uploadState.provenance = result.provenance || {};

                populateMetadataForm(result.metadata, uploadState.provenance);
                showMetadataReview();
            }
        } else {
            console.error('Server error:', result.error);
            alert('Error: ' + result.error);
            hideLoading();
        }
    } catch (error) {
        console.error('DOI lookup error:', error);
        alert('Error retrieving DOI metadata: ' + error.message);
        hideLoading();
    }
});

// Metadata form submission
console.log('Attaching metadata-form submit handler');
document.getElementById('metadata-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('Metadata form submitted - JavaScript handler active');

    // Collect updated metadata from form
    const updatedMetadata = {
        title: document.getElementById('review-title').value,
        authors: document.getElementById('review-authors').value.split(',').map(a => a.trim()).filter(Boolean),
        publication_year: parseInt(document.getElementById('review-year').value) || null,
        journal: document.getElementById('review-journal').value,
        doi: document.getElementById('review-doi').value,
        abstract: document.getElementById('review-abstract').value,
        type: document.getElementById('review-type').value,
        url: document.getElementById('review-url').value
    };

    // Update provenance for any user-edited fields
    const updatedProvenance = { ...uploadState.provenance };
    Object.keys(updatedMetadata).forEach(key => {
        if (updatedMetadata[key] !== uploadState.extractedMetadata[key]) {
            updatedProvenance[key] = {
                source: 'user',
                confidence: 1.0,
                timestamp: new Date().toISOString(),
                raw_value: updatedMetadata[key],
                previous_source: uploadState.provenance[key]?.source
            };
        }
    });

    showLoading();

    try {
        const response = await fetch('/upload/save_document', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                metadata: updatedMetadata,
                provenance: updatedProvenance,
                temp_path: uploadState.tempPath,
                filename: uploadState.currentFileName
            })
        });

        const result = await response.json();

        if (result.success) {
            // Redirect to document view using UUID
            window.location.href = `/input/document/${result.document_uuid}`;
        } else {
            alert('Error: ' + result.error);
            hideLoading();
        }
    } catch (error) {
        alert('Error saving document: ' + error.message);
        hideLoading();
    }
});

function resetUpload() {
    uploadState = {
        currentMethod: 'file',
        extractedMetadata: null,
        tempPath: null,
        currentFileName: null,
        provenance: {}
    };

    document.getElementById('file-form').reset();
    document.getElementById('doi-form').reset();
    document.getElementById('metadata-form').reset();
    document.getElementById('metadata-review').classList.remove('show');
    document.querySelectorAll('.upload-section').forEach(section => {
        section.style.display = 'none';
    });
    document.getElementById('file-form').style.display = 'block';
}
</script>
{% endblock %}
