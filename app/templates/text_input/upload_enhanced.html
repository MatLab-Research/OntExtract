{% extends "base.html" %}

{% block title %}Upload Document - OntExtract{% endblock %}

{% block extra_css %}
<style>
.upload-section {
    background: #303030;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    margin-bottom: 20px;
    border: 1px solid #444;
}

.section-header {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #444;
}

.upload-option {
    border: 2px solid #444;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #222;
}

.upload-option:hover {
    border-color: #375a7f;
    background: #2a2a2a;
}

.upload-option.active {
    border-color: #375a7f;
    background: #1a3a52;
}

.metadata-section {
    display: none;
    background: #222;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 20px;
    margin-top: 20px;
}

.metadata-section.show {
    display: block;
}

.metadata-field {
    margin-bottom: 15px;
}

.metadata-label {
    font-weight: 600;
    margin-bottom: 5px;
}

.metadata-source-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-left: 8px;
}

.source-crossref {
    background: #1e4620;
    color: #4dff4d;
    border: 1px solid #28a745;
}

.source-user {
    background: #1a3a52;
    color: #5bc0de;
    border: 1px solid #5bc0de;
}

.source-file {
    background: #4a3a1c;
    color: #ffc107;
    border: 1px solid #ffc107;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 40px;
}

.loading-spinner.active {
    display: block;
}

.metadata-confirmation {
    background: #1a3a52;
    border: 1px solid #375a7f;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
}

.drop-zone {
    border: 3px dashed #375a7f;
    border-radius: 12px;
    padding: 60px 40px;
    text-align: center;
    background: #1a1a1a;
    transition: all 0.3s ease;
    cursor: pointer;
}

.drop-zone:hover {
    border-color: #4a8fc7;
    background: #252525;
}

.drop-zone.drag-over {
    border-color: #5bc0de;
    background: #1a3a52;
    transform: scale(1.02);
}

.drop-zone i {
    color: #375a7f;
}

.drop-zone.drag-over i {
    color: #5bc0de;
}

.progress-message {
    margin-bottom: 8px;
    color: #aaa;
    font-size: 0.9rem;
    line-height: 1.4;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn 0.3s ease-in;
}

/* Progress Card */
.progress-card {
    display: none;
    background: #2b3e50;
    border: 1px solid #375a7f;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.progress-card.active {
    display: block;
}

.progress-step {
    font-size: 0.9rem;
    color: #aaa;
    margin-bottom: 10px;
}

.progress-step.current {
    color: #5bc0de;
    font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col-12 col-lg-10 col-xl-9">
            <!-- Header -->
            <div class="mb-4">
                <h2>Upload Document</h2>
                <p class="text-muted">
                    Upload a document with automatic metadata extraction from CrossRef.
                    Review and confirm metadata before saving.
                </p>
            </div>

            <!-- File Upload Form -->
            <form id="file-form" class="upload-section" style="display: block;">
                <div class="section-header">Upload Document</div>

                <div class="mb-3">
                    <label class="form-label">Select Document (PDF)</label>
                    <div id="drop-zone" class="drop-zone">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                        <p class="mb-2"><strong>Drag and drop your PDF here</strong></p>
                        <p class="mb-3 text-muted">or</p>
                        <label for="file-input" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-folder-open me-2"></i>Browse Files
                        </label>
                        <input type="file" id="file-input" accept=".pdf" required style="display: none;">
                        <p id="file-name" class="mt-3 text-info" style="display: none;"></p>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="enable-crossref" checked onchange="updateFieldRequirements()">
                    <label class="form-check-label" for="enable-crossref">
                        <strong>Automatic metadata extraction</strong> (recommended for published papers)
                    </label>
                    <div class="form-text">
                        If enabled, OntExtract will extract arXiv ID, DOI, or title from the PDF, then search Semantic Scholar and CrossRef databases.
                        Works best for published papers and arXiv preprints. Very recent (unpublished) or very old (pre-digital) documents may not be found in these databases.
                        Your provided title is used as a fallback. Disable this for personal papers or documents not in academic databases.
                    </div>
                </div>

                <div class="alert alert-info mb-3" id="metadata-tip">
                    <i class="fas fa-info-circle"></i>
                    Leave the fields below blank to automatically extract metadata from the PDF.
                    You can fill them in if automatic extraction fails.
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="file-title" class="form-label">Title (optional)</label>
                        <input type="text" class="form-control" id="file-title" placeholder="Leave blank for automatic extraction">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="file-date" class="form-label">Date (optional)</label>
                        <input type="text" class="form-control" id="file-date" placeholder="e.g., 2020 or 2020-05 or 2020-05-15">
                        <small class="form-text text-muted">Enter year, year-month, or full date</small>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="file-authors" class="form-label">Authors (optional)</label>
                    <input type="text" class="form-control" id="file-authors" placeholder="Comma-separated author names">
                </div>

                <!-- Additional metadata fields (shown when auto-extraction is disabled) -->
                <div id="additional-metadata-fields" style="display: none;">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Manual metadata entry:</strong> Since automatic extraction is disabled, you can provide additional metadata below.
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="file-journal" class="form-label">Journal/Venue (optional)</label>
                            <input type="text" class="form-control" id="file-journal" placeholder="e.g., Nature, JCDL, arXiv">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="file-publisher" class="form-label">Publisher (optional)</label>
                            <input type="text" class="form-control" id="file-publisher" placeholder="e.g., ACM, Springer">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="file-doi" class="form-label">DOI (optional)</label>
                            <input type="text" class="form-control" id="file-doi" placeholder="e.g., 10.1145/1234567.1234568">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="file-url" class="form-label">URL (optional)</label>
                            <input type="url" class="form-control" id="file-url" placeholder="e.g., https://example.com/paper.pdf">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="file-abstract" class="form-label">Abstract (optional)</label>
                        <textarea class="form-control" id="file-abstract" rows="4" placeholder="Paper abstract or summary"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="file-type" class="form-label">Document Type (optional)</label>
                            <select class="form-select" id="file-type">
                                <option value="">Select type...</option>
                                <option value="journal-article">Journal Article</option>
                                <option value="conference-paper">Conference Paper</option>
                                <option value="book">Book</option>
                                <option value="book-chapter">Book Chapter</option>
                                <option value="thesis">Thesis/Dissertation</option>
                                <option value="report">Technical Report</option>
                                <option value="preprint">Preprint (arXiv, etc.)</option>
                                <option value="dictionary-entry">Dictionary Entry</option>
                                <option value="encyclopedia-article">Encyclopedia Article</option>
                                <option value="magazine-article">Magazine Article</option>
                                <option value="newspaper-article">Newspaper Article</option>
                                <option value="manuscript">Manuscript</option>
                                <option value="presentation">Presentation/Slides</option>
                                <option value="webpage">Webpage</option>
                                <option value="blog-post">Blog Post</option>
                                <option value="patent">Patent</option>
                                <option value="case">Legal Case</option>
                                <option value="statute">Statute/Law</option>
                                <option value="letter">Letter/Correspondence</option>
                                <option value="interview">Interview</option>
                                <option value="podcast">Podcast</option>
                                <option value="video">Video Recording</option>
                                <option value="audio">Audio Recording</option>
                                <option value="artwork">Artwork</option>
                                <option value="map">Map</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="file-isbn" class="form-label">ISBN (optional)</label>
                            <input type="text" class="form-control" id="file-isbn" placeholder="e.g., 978-3-16-148410-0">
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                    <i class="fas fa-upload"></i> Upload and Extract Metadata
                </button>
            </form>

            <!-- Progress Card -->
            <div id="progress-card" class="progress-card">
                <h5 class="mb-3"><i class="fas fa-cog fa-spin me-2"></i>Processing Document</h5>
                <div class="progress mb-3" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>
                <div id="progress-steps"></div>
                <div id="current-step" class="progress-step current mt-2"></div>
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loading">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted" id="loading-message">Analyzing document and extracting metadata...</p>
                <div id="loading-details" class="small text-muted mt-2"></div>
            </div>

            <!-- Metadata Review Section -->
            <div id="metadata-review" class="metadata-section">
                <div class="section-header">Review and Confirm Metadata</div>

                <!-- Show uploaded file -->
                <div class="alert alert-secondary mb-3">
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    <strong>Uploaded file:</strong> <span id="uploaded-filename"></span>
                </div>

                <div class="metadata-confirmation">
                    <i class="fas fa-info-circle"></i>
                    <strong>Please review the extracted metadata below.</strong>
                    You can edit any field before saving. Badges indicate the source of each field.
                </div>

                <form id="metadata-form">
                    <div class="row">
                        <div class="col-md-12 metadata-field">
                            <label for="review-title" class="metadata-label">
                                Title
                                <span id="title-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="text" class="form-control" id="review-title" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 metadata-field">
                            <label for="review-authors" class="metadata-label">
                                Authors
                                <span id="authors-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="text" class="form-control" id="review-authors"
                                   placeholder="Comma-separated author names">
                            <div class="form-text">Comma-separated list of authors</div>
                        </div>
                        <div class="col-md-4 metadata-field">
                            <label for="review-date" class="metadata-label">
                                Date
                                <span id="date-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="text" class="form-control" id="review-date"
                                   placeholder="e.g., 2020 or 2020-05">
                            <small class="form-text text-muted">Year, year-month, or full date</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 metadata-field">
                            <label for="review-journal" class="metadata-label">
                                Journal/Publisher
                                <span id="journal-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="text" class="form-control" id="review-journal">
                        </div>
                        <div class="col-md-6 metadata-field">
                            <label for="review-doi" class="metadata-label">
                                DOI
                                <span id="doi-source-badge" class="metadata-source-badge"></span>
                            </label>
                            <input type="text" class="form-control" id="review-doi">
                        </div>
                    </div>

                    <div class="metadata-field">
                        <label for="review-abstract" class="metadata-label">
                            Abstract
                            <span id="abstract-source-badge" class="metadata-source-badge"></span>
                        </label>
                        <textarea class="form-control" id="review-abstract" rows="4"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 metadata-field">
                            <label for="review-type" class="metadata-label">Document Type</label>
                            <select class="form-select" id="review-type">
                                <option value="">Select type...</option>
                                <option value="journal-article">Journal Article</option>
                                <option value="conference-paper">Conference Paper</option>
                                <option value="book">Book</option>
                                <option value="book-chapter">Book Chapter</option>
                                <option value="thesis">Thesis/Dissertation</option>
                                <option value="report">Technical Report</option>
                                <option value="preprint">Preprint (arXiv, etc.)</option>
                                <option value="dictionary-entry">Dictionary Entry</option>
                                <option value="encyclopedia-article">Encyclopedia Article</option>
                                <option value="magazine-article">Magazine Article</option>
                                <option value="newspaper-article">Newspaper Article</option>
                                <option value="manuscript">Manuscript</option>
                                <option value="presentation">Presentation/Slides</option>
                                <option value="webpage">Webpage</option>
                                <option value="blog-post">Blog Post</option>
                                <option value="patent">Patent</option>
                                <option value="case">Legal Case</option>
                                <option value="statute">Statute/Law</option>
                                <option value="letter">Letter/Correspondence</option>
                                <option value="interview">Interview</option>
                                <option value="podcast">Podcast</option>
                                <option value="video">Video Recording</option>
                                <option value="audio">Audio Recording</option>
                                <option value="artwork">Artwork</option>
                                <option value="map">Map</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 metadata-field">
                            <label for="review-url" class="metadata-label">URL</label>
                            <input type="url" class="form-control" id="review-url">
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-check"></i> Confirm and Save Document
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetUpload()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
console.log('=== Upload Enhanced Script Loading ===');

// Upload state management
let uploadState = {
    extractedMetadata: null,
    tempPath: null,
    currentFileName: null,
    provenance: {},
    lowConfidenceSuggestion: null,  // Store low-confidence CrossRef match separately
    pdfExtractedData: null  // Store PDF-extracted data separately
};

console.log('Upload state initialized:', uploadState);

// Drag and drop functionality
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileNameDisplay = document.getElementById('file-name');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when dragging over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('drag-over');
    }, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('drag-over');
    }, false);
});

// Handle dropped files
dropZone.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files.length > 0) {
        fileInput.files = files;
        updateFileName(files[0]);
    }
}, false);

// Handle click to browse
dropZone.addEventListener('click', (e) => {
    // Don't trigger if clicking the label or file input itself
    // The label already triggers the file input via for="file-input"
    const isLabel = e.target.tagName === 'LABEL' || e.target.closest('label[for="file-input"]');
    if (e.target !== fileInput && !isLabel) {
        fileInput.click();
    }
});

// Handle file selection via browse
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        updateFileName(e.target.files[0]);
    }
});

function updateFileName(file) {
    fileNameDisplay.textContent = `Selected: ${file.name}`;
    fileNameDisplay.style.display = 'block';
}

// Update field requirements based on CrossRef checkbox
function updateFieldRequirements() {
    const enableCrossref = document.getElementById('enable-crossref').checked;
    const titleInput = document.getElementById('file-title');
    const dateInput = document.getElementById('file-date');
    const titleLabel = titleInput.previousElementSibling;
    const dateLabel = dateInput.previousElementSibling;
    const tip = document.getElementById('metadata-tip');
    const submitBtn = document.getElementById('submit-btn');

    const additionalFields = document.getElementById('additional-metadata-fields');

    if (enableCrossref) {
        // CrossRef enabled: fields are optional, hide additional fields
        titleInput.required = false;
        dateInput.required = false;
        titleLabel.innerHTML = 'Title (optional)';
        dateLabel.innerHTML = 'Date (optional)';
        titleInput.placeholder = 'Leave blank for automatic extraction';
        tip.style.display = 'block';
        submitBtn.innerHTML = '<i class="fas fa-upload"></i> Upload and Extract Metadata';
        additionalFields.style.display = 'none';
    } else {
        // CrossRef disabled: require at least title, show additional fields
        titleInput.required = true;
        dateInput.required = true;
        titleLabel.innerHTML = 'Title <span class="text-danger">*</span>';
        dateLabel.innerHTML = 'Date <span class="text-danger">*</span>';
        titleInput.placeholder = 'Enter document title';
        tip.style.display = 'none';
        submitBtn.innerHTML = '<i class="fas fa-upload"></i> Upload';
        additionalFields.style.display = 'block';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    updateFieldRequirements();
});

function showLoading(message = 'Uploading document...') {
    document.getElementById('loading').classList.add('active');
    document.getElementById('loading-message').textContent = message;
    document.querySelectorAll('.upload-section').forEach(section => {
        if (section.id !== 'loading') section.style.display = 'none';
    });
}

function hideLoading() {
    document.getElementById('loading').classList.remove('active');
}

/**
 * Fetch with timeout wrapper
 * @param {string} url - The URL to fetch
 * @param {object} options - Fetch options
 * @param {number} timeout - Timeout in milliseconds (default: 45000ms = 45s)
 */
async function fetchWithTimeout(url, options = {}, timeout = 45000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);

    try {
        const response = await fetch(url, {
            ...options,
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        return response;
    } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
            throw new Error(`Request timed out after ${timeout/1000} seconds. The metadata service may be slow or unavailable.`);
        }
        throw error;
    }
}

function showMetadataReview() {
    console.log('showMetadataReview() called');

    // Hide the upload form
    const fileForm = document.getElementById('file-form');
    if (fileForm) {
        fileForm.style.display = 'none';
    }

    // Show the metadata review section (progress card will remain visible above it)
    const reviewSection = document.getElementById('metadata-review');
    console.log('Metadata review element:', reviewSection);
    if (reviewSection) {
        reviewSection.classList.add('show');
        console.log('Added show class. Element classes:', reviewSection.className);

        // Update the uploaded filename display
        const filenameDisplay = document.getElementById('uploaded-filename');
        if (filenameDisplay && uploadState.currentFileName) {
            filenameDisplay.textContent = uploadState.currentFileName;
        }
    } else {
        console.error('metadata-review element not found!');
    }
}

function populateMetadataForm(metadata, provenance) {
    console.log('populateMetadataForm() called');
    console.log('Metadata:', metadata);
    console.log('Provenance:', provenance);

    // Helper to set field value and badge
    const setField = (fieldId, badgeId, value, source) => {
        const field = document.getElementById(fieldId);
        const badge = document.getElementById(badgeId);

        if (field && value != null) {
            if (Array.isArray(value)) {
                field.value = value.join(', ');
            } else {
                field.value = value;
            }
        }

        if (badge && source) {
            badge.textContent = source.toUpperCase();
            badge.className = `metadata-source-badge source-${source}`;
        }
    };

    // Populate fields
    setField('review-title', 'title-source-badge', metadata.title, provenance.title?.source);
    setField('review-authors', 'authors-source-badge', metadata.authors, provenance.authors?.source);
    setField('review-date', 'date-source-badge', metadata.publication_year, provenance.publication_year?.source);
    setField('review-journal', 'journal-source-badge', metadata.journal, provenance.journal?.source);
    setField('review-doi', 'doi-source-badge', metadata.doi, provenance.doi?.source);
    setField('review-abstract', 'abstract-source-badge', metadata.abstract, provenance.abstract?.source);
    setField('review-url', null, metadata.url, null);

    if (metadata.type) {
        document.getElementById('review-type').value = metadata.type;
    }
}

// File upload handler
console.log('Attaching file-form submit handler');
document.getElementById('file-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('File form submitted - JavaScript handler active');

    // Get checkbox state early (needed for error handling)
    const enableCrossref = document.getElementById('enable-crossref').checked;

    const fileInput = document.getElementById('file-input');
    const file = fileInput.files[0];

    if (!file) {
        // Show Bootstrap alert instead of browser alert
        const fileForm = document.getElementById('file-form');
        const existingAlert = fileForm.querySelector('.alert-danger');
        if (existingAlert) {
            existingAlert.remove();
        }

        const alertHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>No file selected!</strong> Please select a PDF file to upload.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        fileForm.insertAdjacentHTML('afterbegin', alertHTML);

        console.log('No file selected');
        return;
    }

    console.log('File selected:', file.name, file.size, 'bytes');

    uploadState.currentFileName = file.name;

    // Only show progress card if automatic extraction is enabled
    if (enableCrossref) {
        // Hide form and show progress card immediately
        document.getElementById('file-form').style.display = 'none';
        const progressCard = document.getElementById('progress-card');
        progressCard.classList.add('active');

        // Show initial progress
        const progressBar = document.getElementById('progress-bar');
        const currentStepDiv = document.getElementById('current-step');
        progressBar.style.width = '10%';
        progressBar.setAttribute('aria-valuenow', 10);
        progressBar.textContent = '10%';
        currentStepDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading document...';
    } else {
        // For manual entry, just show loading spinner
        showLoading('Uploading document...');
    }

    const formData = new FormData();
    formData.append('document_file', file);
    formData.append('source_type', 'file');
    formData.append('title', document.getElementById('file-title').value);
    formData.append('publication_year', document.getElementById('file-date').value);
    formData.append('authors', document.getElementById('file-authors').value);
    formData.append('enable_crossref', enableCrossref ? 'true' : 'false');

    // Add additional metadata fields if provided (shown when auto-extraction is disabled)
    if (!enableCrossref) {
        formData.append('journal', document.getElementById('file-journal').value);
        formData.append('publisher', document.getElementById('file-publisher').value);
        formData.append('doi', document.getElementById('file-doi').value);
        formData.append('url', document.getElementById('file-url').value);
        formData.append('abstract', document.getElementById('file-abstract').value);
        formData.append('type', document.getElementById('file-type').value);
        formData.append('isbn', document.getElementById('file-isbn').value);
    }

    try {
        console.log('Uploading to: /upload/extract_metadata');
        const response = await fetchWithTimeout('/upload/extract_metadata', {
            method: 'POST',
            body: formData
        }, 45000); // 45 second timeout

        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response data:', result);
        console.log('Progress array:', result.progress);

        if (result.success) {
            console.log('Upload successful, processing metadata...');

            // Check if this is a low-confidence match - if so, handle differently
            const isLowConfidence = result.crossref_found && result.confidence_level === 'low';

            if (isLowConfidence) {
                // Store CrossRef suggestion separately for low-confidence matches
                uploadState.lowConfidenceSuggestion = {
                    metadata: result.metadata,
                    provenance: result.provenance || {},
                    matchScore: result.match_score
                };

                // Create PDF-only metadata (exclude CrossRef fields)
                uploadState.pdfExtractedData = {};
                uploadState.provenance = {};

                // Only keep fields that came from PDF or user input
                for (const [key, value] of Object.entries(result.metadata)) {
                    const prov = result.provenance[key];
                    if (prov && (prov.source === 'file' || prov.source === 'user' || prov.source === 'pdf_analysis')) {
                        uploadState.pdfExtractedData[key] = value;
                        uploadState.provenance[key] = prov;
                    }
                }

                // Use PDF-extracted data for the form
                uploadState.extractedMetadata = uploadState.pdfExtractedData;
                uploadState.tempPath = result.temp_path;
            } else {
                // High-confidence or no CrossRef match: use all metadata as normal
                uploadState.extractedMetadata = result.metadata;
                uploadState.tempPath = result.temp_path;
                uploadState.provenance = result.provenance || {};
                uploadState.lowConfidenceSuggestion = null;
                uploadState.pdfExtractedData = null;
            }

            console.log('Updated uploadState:', uploadState);

            // Only show progress animation if automatic extraction was enabled
            if (enableCrossref) {
                // Display progress messages with animation (progress card already visible)
                console.log('Checking progress:', result.progress, result.progress ? result.progress.length : 'no progress');
                if (result.progress && result.progress.length > 0) {
                    console.log('INSIDE progress display block - will display', result.progress.length, 'messages');
                    const progressSteps = document.getElementById('progress-steps');
                    const currentStepDiv = document.getElementById('current-step');
                    const progressBar = document.getElementById('progress-bar');

                    progressSteps.innerHTML = '';  // Clear previous messages
                    const totalSteps = result.progress.length;

                    // Display messages one by one with delay and update progress bar
                    for (let i = 0; i < result.progress.length; i++) {
                        console.log('Setting timeout for message', i, ':', result.progress[i]);
                        setTimeout(() => {
                            // Add completed step
                            if (i > 0) {
                                const prevStep = document.createElement('div');
                                prevStep.className = 'progress-step';
                                prevStep.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${result.progress[i-1]}`;
                                progressSteps.appendChild(prevStep);
                            }

                            // Show current step
                            currentStepDiv.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${result.progress[i]}`;

                            // Update progress bar
                            const percentage = ((i + 1) / totalSteps) * 100;
                            progressBar.style.width = percentage + '%';
                            progressBar.setAttribute('aria-valuenow', percentage);
                            progressBar.textContent = Math.round(percentage) + '%';
                        }, i * 300);  // 300ms delay between messages
                    }

                    // Show final step and complete progress
                    setTimeout(() => {
                        const lastStep = document.createElement('div');
                        lastStep.className = 'progress-step';
                        lastStep.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${result.progress[result.progress.length - 1]}`;
                        progressSteps.appendChild(lastStep);
                        currentStepDiv.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Metadata extraction complete!';

                        // Show metadata review
                        setTimeout(() => {
                            console.log('Calling populateMetadataForm...');
                            populateMetadataForm(result.metadata, uploadState.provenance);
                            console.log('Calling showMetadataReview...');
                            showMetadataReview();
                            console.log('Metadata review should now be visible');
                        }, 500);
                    }, totalSteps * 300 + 300);
                } else {
                    // No progress messages, show review immediately
                    console.log('Calling populateMetadataForm...');
                    populateMetadataForm(result.metadata, uploadState.provenance);
                    console.log('Calling showMetadataReview...');
                    showMetadataReview();
                    console.log('Metadata review should now be visible');
                }
            } else {
                // Manual entry: hide loading and show review immediately
                hideLoading();
                console.log('Calling populateMetadataForm...');
                populateMetadataForm(result.metadata, uploadState.provenance);
                console.log('Calling showMetadataReview...');
                showMetadataReview();
                console.log('Metadata review should now be visible');
            }

            // Show message about CrossRef search result
            if (result.message) {
                let alertHTML;

                // Check if this is a low-confidence CrossRef match
                if (result.crossref_found && result.confidence_level === 'low') {
                    // Show warning with preview and Accept/Reject buttons (non-dismissible)
                    const suggestion = uploadState.lowConfidenceSuggestion.metadata;
                    const suggestionPreview = `
                        <div class="mt-2 p-2 bg-dark border rounded">
                            <strong>Suggested match from CrossRef:</strong><br>
                            <strong>Title:</strong> ${suggestion.title || 'N/A'}<br>
                            ${suggestion.authors ? `<strong>Authors:</strong> ${suggestion.authors}<br>` : ''}
                            ${suggestion.publication_year ? `<strong>Date:</strong> ${suggestion.publication_year}<br>` : ''}
                            ${suggestion.journal ? `<strong>Journal:</strong> ${suggestion.journal}<br>` : ''}
                            <small class="text-warning">Match score: ${result.match_score || 'N/A'}</small>
                        </div>
                    `;

                    alertHTML = `<div class="alert alert-warning mt-3" role="alert" id="low-confidence-alert">
                        <div>
                            <i class="fas fa-exclamation-triangle"></i> ${result.message}
                            ${suggestionPreview}
                        </div>
                        <div class="btn-group mt-3">
                            <button type="button" class="btn btn-sm btn-success" onclick="acceptLowConfidenceMatch()">
                                <i class="fas fa-check"></i> Accept This Match
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="rejectLowConfidenceMatch()">
                                <i class="fas fa-times"></i> Keep PDF Data
                            </button>
                        </div>
                    </div>`;
                } else {
                    // Normal dismissible alert
                    const alertClass = result.crossref_found ? 'alert-success' : (result.crossref_enabled ? 'alert-warning' : 'alert-info');
                    alertHTML = `<div class="alert ${alertClass} alert-dismissible fade show mt-3" role="alert">
                        <i class="fas fa-info-circle"></i> ${result.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;
                }

                document.getElementById('metadata-review').insertAdjacentHTML('afterbegin', alertHTML);
            }
        } else {
            console.error('Server error:', result.error);
            alert('Error: ' + result.error);
            // Reset UI based on which mode was used
            if (enableCrossref) {
                document.getElementById('progress-card').classList.remove('active');
            } else {
                hideLoading();
            }
            document.getElementById('file-form').style.display = 'block';
        }
    } catch (error) {
        console.error('Upload error:', error);

        // Provide user-friendly error message
        let errorMessage = 'Error uploading document: ' + error.message;

        if (error.message.includes('timed out')) {
            errorMessage = 'The metadata lookup is taking longer than expected.\n\n' +
                          'This usually happens when:\n' +
                          '• Semantic Scholar API is slow or unavailable\n' +
                          '• Your network connection is slow\n\n' +
                          'You can try:\n' +
                          '• Upload without automatic metadata lookup (uncheck "Automatically extract...")\n' +
                          '• Wait a moment and try again\n' +
                          '• Enter metadata manually';
        }

        alert(errorMessage);

        // Reset UI based on which mode was used
        if (enableCrossref) {
            document.getElementById('progress-card').classList.remove('active');
        } else {
            hideLoading();
        }
        document.getElementById('file-form').style.display = 'block';
    }
});

// Metadata form submission
console.log('Attaching metadata-form submit handler');
document.getElementById('metadata-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('Metadata form submitted - JavaScript handler active');

    // Collect updated metadata from form
    const updatedMetadata = {
        title: document.getElementById('review-title').value,
        authors: document.getElementById('review-authors').value.split(',').map(a => a.trim()).filter(Boolean),
        publication_year: document.getElementById('review-date').value || null,
        journal: document.getElementById('review-journal').value,
        doi: document.getElementById('review-doi').value,
        abstract: document.getElementById('review-abstract').value,
        type: document.getElementById('review-type').value,
        url: document.getElementById('review-url').value
    };

    // Update provenance for any user-edited fields
    const updatedProvenance = { ...uploadState.provenance };
    Object.keys(updatedMetadata).forEach(key => {
        if (updatedMetadata[key] !== uploadState.extractedMetadata[key]) {
            updatedProvenance[key] = {
                source: 'user',
                confidence: 1.0,
                timestamp: new Date().toISOString(),
                raw_value: updatedMetadata[key],
                previous_source: uploadState.provenance[key]?.source
            };
        }
    });

    showLoading();

    try {
        const response = await fetch('/upload/save_document', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                metadata: updatedMetadata,
                provenance: updatedProvenance,
                temp_path: uploadState.tempPath,
                filename: uploadState.currentFileName
            })
        });

        const result = await response.json();

        if (result.success) {
            // Redirect to document view using UUID
            window.location.href = `/input/document/${result.document_uuid}`;
        } else {
            alert('Error: ' + result.error);
            hideLoading();
        }
    } catch (error) {
        alert('Error saving document: ' + error.message);
        hideLoading();
    }
});

function resetUpload() {
    uploadState = {
        extractedMetadata: null,
        tempPath: null,
        currentFileName: null,
        provenance: {}
    };

    document.getElementById('file-form').reset();
    document.getElementById('metadata-form').reset();
    document.getElementById('metadata-review').classList.remove('show');

    // Clear file name display
    const fileNameDisplay = document.getElementById('file-name');
    if (fileNameDisplay) {
        fileNameDisplay.textContent = '';
        fileNameDisplay.style.display = 'none';
    }

    // Clear file input
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.value = '';
    }

    // Hide progress card and reset progress
    const progressCard = document.getElementById('progress-card');
    progressCard.classList.remove('active');
    document.getElementById('progress-steps').innerHTML = '';
    document.getElementById('current-step').innerHTML = '';
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', 0);
    progressBar.textContent = '0%';

    // Remove any alerts
    document.querySelectorAll('#metadata-review .alert').forEach(alert => alert.remove());

    document.querySelectorAll('.upload-section').forEach(section => {
        section.style.display = 'none';
    });
    document.getElementById('file-form').style.display = 'block';
}

function acceptLowConfidenceMatch() {
    // Remove the warning alert - user accepted the low-confidence match
    document.querySelectorAll('#metadata-review .alert-warning').forEach(alert => alert.remove());

    // Add a green confirmation message
    const confirmHTML = `<div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        <i class="fas fa-check-circle"></i> Low-confidence match accepted. Please review and edit the metadata as needed.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    document.getElementById('metadata-review').insertAdjacentHTML('afterbegin', confirmHTML);
}

function clearAllMetadata() {
    // Clear all metadata fields
    document.getElementById('review-title').value = '';
    document.getElementById('review-authors').value = '';
    document.getElementById('review-date').value = '';
    document.getElementById('review-journal').value = '';
    document.getElementById('review-doi').value = '';
    document.getElementById('review-abstract').value = '';
    document.getElementById('review-url').value = '';

    // Clear all source badges
    document.querySelectorAll('.metadata-source-badge').forEach(badge => {
        badge.textContent = '';
        badge.className = 'metadata-source-badge';
    });

    // Remove the warning alert
    document.querySelectorAll('#metadata-review .alert-warning').forEach(alert => alert.remove());

    // Add info message
    const infoHTML = `<div class="alert alert-info alert-dismissible fade show mt-3" role="alert">
        <i class="fas fa-info-circle"></i> Metadata cleared. Please enter the correct information manually.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    document.getElementById('metadata-review').insertAdjacentHTML('afterbegin', infoHTML);

    // Clear provenance data
    uploadState.provenance = {};
}

function acceptLowConfidenceMatch() {
    // User accepted the low-confidence CrossRef match
    if (!uploadState.lowConfidenceSuggestion) {
        console.error('No low-confidence suggestion to accept');
        return;
    }

    // Replace current metadata with the CrossRef suggestion
    uploadState.extractedMetadata = uploadState.lowConfidenceSuggestion.metadata;
    uploadState.provenance = uploadState.lowConfidenceSuggestion.provenance;

    // Re-populate the form with CrossRef data
    populateMetadataForm(uploadState.extractedMetadata, uploadState.provenance);

    // Remove the warning alert
    const alert = document.getElementById('low-confidence-alert');
    if (alert) {
        alert.remove();
    }

    // Show success message
    const successHTML = `<div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        <i class="fas fa-check-circle"></i> CrossRef metadata accepted. You can still edit any fields before saving.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    document.getElementById('metadata-review').insertAdjacentHTML('afterbegin', successHTML);

    // Clear the suggestion from state
    uploadState.lowConfidenceSuggestion = null;
}

function rejectLowConfidenceMatch() {
    // User rejected the low-confidence match - keep PDF-extracted data
    if (!uploadState.lowConfidenceSuggestion) {
        console.error('No low-confidence suggestion to reject');
        return;
    }

    // Remove the warning alert
    const alert = document.getElementById('low-confidence-alert');
    if (alert) {
        alert.remove();
    }

    // Show info message
    const infoHTML = `<div class="alert alert-info alert-dismissible fade show mt-3" role="alert">
        <i class="fas fa-info-circle"></i> CrossRef suggestion rejected. Using PDF-extracted data. You can edit any fields before saving.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    document.getElementById('metadata-review').insertAdjacentHTML('afterbegin', infoHTML);

    // Clear the suggestion from state
    uploadState.lowConfidenceSuggestion = null;
}
</script>
{% endblock %}
