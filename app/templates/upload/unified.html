{% extends "base.html" %}

{% block title %}Add Source - OntExtract{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item active">Add Source</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-plus-circle text-primary"></i> Add Source</h1>
            <p class="text-muted">Add documents, dictionary entries, or references from various sources</p>
        </div>
    </div>

    <!-- Main tabs for upload types -->
    <ul class="nav nav-tabs mt-3" id="uploadTypeTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="document-tab" data-bs-toggle="tab" data-bs-target="#document"
                type="button" role="tab">
                <i class="fas fa-file-alt"></i> Upload
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="paste-tab" data-bs-toggle="tab" data-bs-target="#paste" type="button"
                role="tab">
                <i class="fas fa-paste"></i> Paste Text
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="dictionary-tab" data-bs-toggle="tab" data-bs-target="#dictionary" type="button"
                role="tab">
                <i class="fas fa-spell-check"></i> Dictionary Entry
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="oed-tab" data-bs-toggle="tab" data-bs-target="#oed" type="button" role="tab">
                <i class="fas fa-book text-warning"></i> OED Entry
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="mw-dict-tab" data-bs-toggle="tab" data-bs-target="#mw-dict" type="button" role="tab">
                <i class="fas fa-book text-danger"></i> MW Dictionary
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="mw-thes-tab" data-bs-toggle="tab" data-bs-target="#mw-thes" type="button" role="tab">
                <i class="fas fa-list-alt text-secondary"></i> MW Thesaurus
            </button>
        </li>
    </ul>

    <div class="tab-content" id="uploadTypeTabContent">
        <!-- Unified Documents Tab -->
        <div class="tab-pane fade show active" id="document" role="tabpanel">
            <form method="POST" enctype="multipart/form-data" id="documentUploadForm">
                <input type="hidden" name="upload_type" value="document">

                <div class="row mt-3">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Upload Document</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    Upload any document for analysis, reference, or archival.
                                    <strong>Metadata will be automatically extracted from your Zotero library if
                                        available (PDF files).</strong>
                                </div>

                                <!-- Drag and Drop File Upload -->
                                <div class="mb-3">
                                    <label class="form-label">Document File <span class="text-danger">*</span></label>

                                    <!-- Drop Zone -->
                                    <div class="upload-drop-zone" id="dropZone" ondrop="dropHandler(event);"
                                        ondragover="dragOverHandler(event);" ondragenter="dragEnterHandler(event);"
                                        ondragleave="dragLeaveHandler(event);">
                                        <div class="upload-drop-content">
                                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                            <h5>Drop files here to upload</h5>
                                            <p class="text-muted">or click to browse</p>
                                            <div class="upload-formats">
                                                <small class="text-muted">Accepted: PDF, Word, Text, Markdown,
                                                    HTML</small>
                                            </div>
                                        </div>
                                        <input type="file" class="d-none" id="doc_file" name="file" required
                                            accept=".pdf,.docx,.doc,.txt,.md,.html,.htm" onchange="fileSelected(this)">
                                    </div>

                                    <!-- Selected File Display -->
                                    <div id="selectedFileInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-success mb-0">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-file-alt me-2"></i>
                                                <div class="flex-grow-1">
                                                    <strong id="selectedFileName">No file selected</strong>
                                                    <br><small id="selectedFileSize" class="text-muted">0 bytes</small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary ms-auto"
                                                    onclick="clearSelectedFile()">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="doc_title" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="doc_title" name="title"
                                        placeholder="Optional - will use filename if not provided">
                                </div>

                                <!-- Document Type using PROV-O -->
                                <div class="mb-3">
                                    <label for="document_prov_type" class="form-label">Document Type (PROV-O)</label>
                                    <select class="form-select" id="document_prov_type" name="prov_type">
                                        <option value="prov:Entity">General Document (prov:Entity)</option>
                                        <option value="prov:Entity/SourceDocument">Source Document for Analysis</option>
                                        <option value="prov:Entity/Reference">Reference/Citation</option>
                                        <option value="prov:Entity/Standard">Standard/Specification</option>
                                        <option value="prov:Entity/AcademicPaper">Academic Paper</option>
                                        <option value="prov:Entity/TechnicalReport">Technical Report</option>
                                        <option value="prov:Entity/Book">Book</option>
                                        <option value="prov:Entity/Patent">Patent</option>
                                        <option value="prov:Entity/WebResource">Web Resource</option>
                                        <option value="prov:Entity/Glossary">Glossary/Terminology</option>
                                        <option value="prov:Entity/Dictionary">Dictionary Entry</option>
                                        <option value="prov:Entity/Other">Other</option>
                                    </select>
                                    <div class="form-text">Using PROV-O ontology for document classification</div>
                                </div>

                                <!-- Language detection info -->
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="auto_detect_language"
                                        name="auto_detect_language" checked>
                                    <label class="form-check-label" for="auto_detect_language">
                                        Automatically detect document language
                                    </label>
                                </div>

                                <!-- Automatic Zotero enhancement (always enabled for PDFs) -->
                                <div class="alert alert-success">
                                    <input type="hidden" name="check_zotero" value="on">
                                    <i class="fas fa-magic me-2"></i>
                                    <strong>Automatic Enhancement:</strong> PDF files will be automatically enhanced
                                    with Zotero metadata if available.
                                    Processing options (embeddings, segmentation, entity extraction) will be available
                                    on the document page after upload.
                                </div>

                                <!-- Collapsible metadata section -->
                                <div class="mb-3">
                                    <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                                        href="#metadataFields" role="button">
                                        <i class="fas fa-chevron-down"></i> Additional Metadata (Optional)
                                    </a>
                                    <div class="collapse mt-2" id="metadataFields">
                                        <div class="card card-body">
                                            <p class="small text-muted mb-3">
                                                <i class="fas fa-magic"></i> These fields will be auto-populated from
                                                Zotero if a match is found
                                            </p>

                                            <div class="mb-3">
                                                <label for="authors" class="form-label">Authors</label>
                                                <input type="text" class="form-control" name="authors"
                                                    placeholder="e.g., Smith, J., Doe, A. (comma-separated)">
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="publication_date" class="form-label">Publication
                                                        Date</label>
                                                    <input type="text" class="form-control" name="publication_date"
                                                        placeholder="e.g., 2023">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="journal" class="form-label">Journal/Publisher</label>
                                                    <input type="text" class="form-control" name="journal"
                                                        placeholder="e.g., Nature, IEEE">
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="doi" class="form-label">DOI</label>
                                                    <input type="text" class="form-control" name="doi"
                                                        placeholder="e.g., 10.1234/example">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="isbn" class="form-label">ISBN</label>
                                                    <input type="text" class="form-control" name="isbn"
                                                        placeholder="e.g., 978-3-16-148410-0">
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label for="url" class="form-label">URL</label>
                                                <input type="url" class="form-control" name="url"
                                                    placeholder="https://example.com/paper">
                                            </div>

                                            <div class="mb-3">
                                                <label for="abstract" class="form-label">Abstract</label>
                                                <textarea class="form-control" name="abstract" rows="3"
                                                    placeholder="Paper abstract or document summary..."></textarea>
                                            </div>

                                            <div class="mb-3">
                                                <label for="citation" class="form-label">Citation</label>
                                                <textarea class="form-control" name="citation" rows="2"
                                                    placeholder="Full citation (e.g., APA, MLA format)..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Link to experiment (if applicable) -->
                                {% if experiment %}
                                <input type="hidden" name="experiment_id" value="{{ experiment.id }}">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" name="include_in_analysis"
                                        value="true" id="include_in_analysis" checked>
                                    <label class="form-check-label" for="include_in_analysis">
                                        Include in experiment analysis
                                    </label>
                                </div>
                                <div class="alert alert-success">
                                    <i class="fas fa-link"></i> This document will be linked to experiment: <strong>{{
                                        experiment.name }}</strong>
                                </div>
                                {% endif %}

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-upload"></i> Upload Document
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </form>
        </div>

        <!-- Paste Text Tab -->
        <div class="tab-pane fade" id="paste" role="tabpanel">
            <form method="POST" id="pasteTextForm">
                <input type="hidden" name="upload_type" value="paste">

                <div class="row mt-3">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Paste Text Content</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="paste_title" class="form-label">Title <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="paste_title" name="title" required
                                        placeholder="Give your text a descriptive title">
                                </div>

                                <div class="mb-3">
                                    <label for="content_type" class="form-label">Content Type</label>
                                    <select class="form-select" id="content_type" name="content_type">
                                        <option value="document">Document (for analysis)</option>
                                        <option value="reference">Reference (citation)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="paste_content" class="form-label">Content <span
                                            class="text-danger">*</span></label>
                                    <textarea class="form-control" id="paste_content" name="content" rows="12" required
                                        placeholder="Paste your text content here..."></textarea>
                                    <div class="form-text">
                                        <span id="char-count">0</span> characters |
                                        <span id="word-count">0</span> words
                                    </div>
                                </div>

                                <!-- Link to experiment (if applicable) -->
                                {% if experiment %}
                                <input type="hidden" name="experiment_id" value="{{ experiment.id }}">
                                {% endif %}

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Text
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Tips</h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted">
                                    Paste text directly when you:
                                </p>
                                <ul class="small text-muted">
                                    <li>Have content from a webpage</li>
                                    <li>Want to quickly analyze text</li>
                                    <li>Need to add notes or summaries</li>
                                    <li>Have content not in a file format</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Dictionary Entry Tab -->
        <div class="tab-pane fade" id="dictionary" role="tabpanel">
            <form method="POST" id="generalDictForm">
                <input type="hidden" name="upload_type" value="general_dictionary">
                <input type="hidden" name="reference_subtype" value="dictionary_general">

                <div class="row mt-3">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-spell-check"></i> Dictionary Entry
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="dict_source" class="form-label">Dictionary Source <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="dict_source" name="journal"
                                        required placeholder="e.g., Merriam-Webster, Domain Glossary, Technical Standard">
                                </div>

                                <div class="mb-3">
                                    <label for="dict_term" class="form-label">Term <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="dict_term" name="title" required
                                        placeholder="Enter the term">
                                </div>

                                <div class="mb-3">
                                    <label for="dict_definition" class="form-label">Definition <span
                                            class="text-danger">*</span></label>
                                    <textarea class="form-control" id="dict_definition" name="content" rows="4"
                                        required placeholder="Enter the definition..."></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="dict_context" class="form-label">Context/Domain</label>
                                    <input type="text" class="form-control" id="dict_context" name="context"
                                        placeholder="e.g., Computer Science, Medicine">
                                </div>

                                <div class="mb-3">
                                    <label for="dict_citation" class="form-label">Citation <span
                                            class="text-danger">*</span></label>
                                    <textarea class="form-control" name="citation" rows="2" required
                                        placeholder="Full citation for this dictionary entry..."></textarea>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Dictionary Entry
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- OED Entry Tab -->
        <div class="tab-pane fade" id="oed" role="tabpanel">
            <div class="row mt-3">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-book text-warning"></i> Oxford English Dictionary Entry
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Search and add entries from the Oxford English Dictionary. 
                                <strong>Only metadata is stored; definitions are fetched on demand to comply with OED terms.</strong>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Search Term <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="oed-search-term" 
                                           placeholder="Enter word to search in OED...">
                                    <button class="btn btn-outline-warning" type="button" id="oed-search-btn">
                                        <i class="fas fa-search"></i> Search OED
                                    </button>
                                </div>
                                <div class="form-text">Search the Oxford English Dictionary for entry suggestions</div>
                            </div>

                            <!-- OED Search Results -->
                            <div id="oed-results" class="mt-3" style="display: none;">
                                <div class="border rounded p-3 bg-light">
                                    <div id="oed-results-content">
                                        <!-- OED search results will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">About OED Integration</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-2">
                                The Oxford English Dictionary provides authoritative definitions and etymological information.
                            </p>
                            <p class="small text-muted">
                                <strong>Note:</strong> This integration stores only metadata (entry ID, headword, part of speech) 
                                and fetches definitions on demand to comply with OED licensing terms.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Merriam-Webster Dictionary Tab -->
        <div class="tab-pane fade" id="mw-dict" role="tabpanel">
            <div class="row mt-3">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-book text-danger"></i> Merriam-Webster Dictionary Entry
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Search and add entries from Merriam-Webster Dictionary.
                                <strong>Authoritative American English definitions with pronunciation and usage.</strong>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Search Term <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="mw-dict-search-term" 
                                           placeholder="Enter word to search in Merriam-Webster...">
                                    <button class="btn btn-outline-danger" type="button" id="mw-dict-search-btn">
                                        <i class="fas fa-search"></i> Search Dictionary
                                    </button>
                                </div>
                                <div class="form-text">Search Merriam-Webster Dictionary for definitions</div>
                            </div>

                            <!-- MW Dictionary Search Results -->
                            <div id="mw-dict-results" class="mt-3" style="display: none;">
                                <div class="border rounded p-3 bg-light">
                                    <div id="mw-dict-results-content">
                                        <!-- MW Dictionary search results will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">About MW Dictionary</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-2">
                                Merriam-Webster provides comprehensive American English definitions with 
                                pronunciation guides and usage examples.
                            </p>
                            <p class="small text-muted">
                                Perfect for contemporary word definitions and standard American usage.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Merriam-Webster Thesaurus Tab -->
        <div class="tab-pane fade" id="mw-thes" role="tabpanel">
            <div class="row mt-3">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list-alt text-secondary"></i> Merriam-Webster Thesaurus Entry
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Search and add entries from Merriam-Webster Thesaurus.
                                <strong>Find synonyms, antonyms, and related words for semantic analysis.</strong>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Search Term <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="mw-thes-search-term" 
                                           placeholder="Enter word to search in thesaurus...">
                                    <button class="btn btn-outline-secondary" type="button" id="mw-thes-search-btn">
                                        <i class="fas fa-search"></i> Search Thesaurus
                                    </button>
                                </div>
                                <div class="form-text">Search Merriam-Webster Thesaurus for synonyms and antonyms</div>
                            </div>

                            <!-- MW Thesaurus Search Results -->
                            <div id="mw-thes-results" class="mt-3" style="display: none;">
                                <div class="border rounded p-3 bg-light">
                                    <div id="mw-thes-results-content">
                                        <!-- MW Thesaurus search results will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">About MW Thesaurus</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-2">
                                Merriam-Webster Thesaurus provides comprehensive synonym and antonym lists 
                                for semantic relationship analysis.
                            </p>
                            <p class="small text-muted">
                                Essential for understanding word relationships and context anchoring.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Remember selected tab
    document.addEventListener('DOMContentLoaded', function () {
        // Main tab memory
        const savedTab = localStorage.getItem('uploadMainTab');
        if (savedTab) {
            const tabButton = document.querySelector(`#${savedTab}-tab`);
            if (tabButton) {
                new bootstrap.Tab(tabButton).show();
            }
        }

        // Save tab preference when changed
        document.querySelectorAll('#uploadTypeTabs button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (e) {
                const tabId = e.target.id.replace('-tab', '');
                localStorage.setItem('uploadMainTab', tabId);
            });
        });

        // Character/word counter for paste text
        const pasteContent = document.getElementById('paste_content');
        if (pasteContent) {
            pasteContent.addEventListener('input', function () {
                const text = this.value;
                document.getElementById('char-count').textContent = text.length;
                document.getElementById('word-count').textContent = text.trim() ? text.trim().split(/\s+/).length : 0;
            });
        }
    });

    // Form submission handlers
    document.getElementById('documentUploadForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        this.action = "{{ url_for('upload.upload_document') }}";
        this.submit();
    });

    document.getElementById('pasteTextForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const contentType = document.getElementById('content_type').value;
        if (contentType === 'reference') {
            // Convert to reference format
            const formData = new FormData(this);
            formData.set('reference_subtype', 'other');
            // Submit as reference
            fetch("{{ url_for('references.upload_dictionary') }}", {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    window.location.href = "{{ url_for('references.index') }}";
                }
            });
        } else {
            this.action = "{{ url_for('text_input.submit_text') }}";
            this.submit();
        }
    });

    document.getElementById('oedForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        this.action = "{{ url_for('references.upload_dictionary') }}";
        this.submit();
    });

    document.getElementById('generalDictForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        this.action = "{{ url_for('references.upload_dictionary') }}";
        this.submit();
    });

    // OED PDF Parser
    function parseOEDPDF() {
        const fileInput = document.getElementById('oed_pdf_file');
        const statusDiv = document.getElementById('oed_parse_status');
        const file = fileInput.files[0];

        if (!file) {
            statusDiv.innerHTML = '<div class="alert alert-warning">Please select a PDF file</div>';
            return;
        }

        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Parsing PDF...</div>';

        const formData = new FormData();
        formData.append('file', file);

        fetch('{{ url_for("references.parse_oed_pdf") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Auto-populate form fields
                    if (result.data.headword) {
                        document.getElementById('oed_term').value = result.data.headword;
                    }
                    if (result.data.full_text) {
                        document.getElementById('oed_full_text').value = result.data.full_text;
                    }
                    if (result.data.first_recorded_use) {
                        document.getElementById('oed_first_use').value = result.data.first_recorded_use;
                    }

                    statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Successfully parsed OED entry!</div>';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: ${result.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</div>`;
            });
    }

    // OED Entry Search
    document.getElementById('oed-search-btn')?.addEventListener('click', async function() {
        const searchTerm = document.getElementById('oed-search-term').value.trim();
        if (!searchTerm) return;
        
        const resultsDiv = document.getElementById('oed-results');
        const resultsContent = document.getElementById('oed-results-content');
        
        resultsContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Searching OED for "${searchTerm}"...
            </div>
        `;
        resultsDiv.style.display = 'block';
        
        try {
            const res = await fetch(`/references/api/oed/suggest?q=${encodeURIComponent(searchTerm)}`);
            const data = await res.json();
            
            if (!data.success) {
                resultsContent.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>OED API Error:</strong> ${data.error || 'Unable to search OED'}
                        <br><small>Make sure OED API is configured with proper credentials.</small>
                    </div>
                `;
                return;
            }
            
            const suggestions = data.suggestions || [];
            if (suggestions.length === 0) {
                resultsContent.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No OED entries found for "${searchTerm}".
                    </div>
                `;
                return;
            }
            
            let html = `<div class="alert alert-success"><strong>OED Results for "${searchTerm}"</strong></div>`;
            
            suggestions.forEach((entry, index) => {
                const entryId = entry.entry_id || '';
                const headword = entry.headword || entry.word || searchTerm;
                const pos = entry.pos || entry.part_of_speech || '';
                
                html += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">
                                <strong>${headword}</strong>
                                ${pos ? `<span class="badge bg-secondary ms-2">${pos}</span>` : ''}
                                <small class="text-muted ms-2">(${entryId})</small>
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="addOEDEntry('${searchTerm}', '${entryId}', '${headword}', '${pos}')">
                                Add OED Entry
                            </button>
                        </div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html;
            
        } catch (error) {
            console.error('OED API Error:', error);
            resultsContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Error searching OED:</strong> ${error.message}
                </div>
            `;
        }
    });

    // MW Dictionary Search  
    document.getElementById('mw-dict-search-btn')?.addEventListener('click', async function() {
        const searchTerm = document.getElementById('mw-dict-search-term').value.trim();
        if (!searchTerm) return;
        
        const resultsDiv = document.getElementById('mw-dict-results');
        const resultsContent = document.getElementById('mw-dict-results-content');
        
        resultsContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Searching Merriam-Webster Dictionary for "${searchTerm}"...
            </div>
        `;
        resultsDiv.style.display = 'block';
        
        try {
            const res = await fetch(`/api/merriam-webster/dictionary/${encodeURIComponent(searchTerm)}`);
            const data = await res.json();
            
            if (!data.success || !data.results || data.results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No dictionary entries found for "${searchTerm}".
                    </div>
                `;
                return;
            }
            
            let html = `<div class="alert alert-success"><strong>MW Dictionary Results for "${searchTerm}"</strong></div>`;
            
            data.results.forEach((entry, index) => {
                const word = entry.word || entry.id || searchTerm;
                const pos = entry.functional_label || '';
                const definitions = entry.definitions || [];
                
                html += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">
                                <strong>${word}</strong>
                                ${pos ? `<span class="badge bg-secondary ms-2">${pos}</span>` : ''}
                            </h6>
                `;
                
                if (definitions.length > 0) {
                    html += `<ol class="mb-2">`;
                    definitions.slice(0, 3).forEach(def => {
                        html += `<li class="small">${def}</li>`;
                    });
                    html += `</ol>`;
                }
                
                html += `
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="addMWDictEntry('${searchTerm}', '${word}', '${pos}', ${index})">
                                Add MW Dictionary Entry
                            </button>
                        </div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html;
            window.currentMWDictResults = data;
            
        } catch (error) {
            console.error('MW Dictionary API Error:', error);
            resultsContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Error searching MW Dictionary:</strong> ${error.message}
                </div>
            `;
        }
    });

    // MW Thesaurus Search
    document.getElementById('mw-thes-search-btn')?.addEventListener('click', async function() {
        const searchTerm = document.getElementById('mw-thes-search-term').value.trim();
        if (!searchTerm) return;
        
        const resultsDiv = document.getElementById('mw-thes-results');
        const resultsContent = document.getElementById('mw-thes-results-content');
        
        resultsContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Searching Merriam-Webster Thesaurus for "${searchTerm}"...
            </div>
        `;
        resultsDiv.style.display = 'block';
        
        try {
            const res = await fetch(`/api/merriam-webster/thesaurus/${encodeURIComponent(searchTerm)}`);
            const data = await res.json();
            
            if (!data.success || !data.results || data.results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No thesaurus entries found for "${searchTerm}".
                    </div>
                `;
                return;
            }
            
            let html = `<div class="alert alert-success"><strong>MW Thesaurus Results for "${searchTerm}"</strong></div>`;
            
            data.results.forEach((entry, index) => {
                const word = entry.word || entry.id || searchTerm;
                const pos = entry.functional_label || '';
                const synonyms = entry.synonyms ? entry.synonyms.flat().slice(0, 10) : [];
                const antonyms = entry.antonyms ? entry.antonyms.flat().slice(0, 5) : [];
                
                html += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">
                                <strong>${word}</strong>
                                ${pos ? `<span class="badge bg-secondary ms-2">${pos}</span>` : ''}
                            </h6>
                `;
                
                if (synonyms.length > 0) {
                    html += `<p class="small mb-1"><strong>Synonyms:</strong> ${synonyms.join(', ')}</p>`;
                }
                
                if (antonyms.length > 0) {
                    html += `<p class="small mb-2"><strong>Antonyms:</strong> ${antonyms.join(', ')}</p>`;
                }
                
                html += `
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="addMWThesEntry('${searchTerm}', '${word}', '${pos}', ${index})">
                                Add MW Thesaurus Entry
                            </button>
                        </div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html;
            window.currentMWThesResults = data;
            
        } catch (error) {
            console.error('MW Thesaurus API Error:', error);
            resultsContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Error searching MW Thesaurus:</strong> ${error.message}
                </div>
            `;
        }
    });

    // Entry addition functions
    window.addOEDEntry = function(searchTerm, entryId, headword, pos) {
        const formData = new FormData();
        formData.append('entry_id', entryId);
        formData.append('title', `OED: ${headword}`);
        formData.append('reference_subtype', 'oed_entry');
        
        fetch('/references/oed/add', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                alert(`Added OED entry: ${headword} (${entryId})`);
                document.getElementById('oed-results').style.display = 'none';
                document.getElementById('oed-search-term').value = '';
            } else {
                alert('Error adding OED entry');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Error adding OED entry');
        });
    };

    window.addMWDictEntry = function(searchTerm, word, pos, index) {
        if (!window.currentMWDictResults) return;
        
        const entry = window.currentMWDictResults.results[index];
        const definition = entry.definitions && entry.definitions.length > 0 ? entry.definitions[0] : '';
        
        const formData = new FormData();
        formData.append('title', `MW Dict: ${word}`);
        formData.append('content', definition);
        formData.append('journal', 'Merriam-Webster Dictionary');
        formData.append('reference_subtype', 'dictionary_mw');
        formData.append('upload_type', 'dictionary');
        
        fetch('/references/upload_dictionary', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                alert(`Added MW Dictionary entry: ${word}`);
                document.getElementById('mw-dict-results').style.display = 'none';
                document.getElementById('mw-dict-search-term').value = '';
            } else {
                alert('Error adding MW Dictionary entry');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Error adding MW Dictionary entry');
        });
    };

    window.addMWThesEntry = function(searchTerm, word, pos, index) {
        if (!window.currentMWThesResults) return;
        
        const entry = window.currentMWThesResults.results[index];
        const synonyms = entry.synonyms ? entry.synonyms.flat().join(', ') : '';
        const antonyms = entry.antonyms ? entry.antonyms.flat().join(', ') : '';
        
        let content = `Synonyms: ${synonyms}`;
        if (antonyms) {
            content += `\n\nAntonyms: ${antonyms}`;
        }
        
        const formData = new FormData();
        formData.append('title', `MW Thes: ${word}`);
        formData.append('content', content);
        formData.append('journal', 'Merriam-Webster Thesaurus');
        formData.append('reference_subtype', 'thesaurus_mw');
        formData.append('upload_type', 'dictionary');
        
        fetch('/references/upload_dictionary', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                alert(`Added MW Thesaurus entry: ${word}`);
                document.getElementById('mw-thes-results').style.display = 'none';
                document.getElementById('mw-thes-search-term').value = '';
            } else {
                alert('Error adding MW Thesaurus entry');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Error adding MW Thesaurus entry');
        });
    };
</script>

<style>
    /* Custom styles for the unified upload interface - Dark theme compatible */
    .nav-tabs {
        border-bottom: 2px solid #444;
    }

    .nav-tabs .nav-link {
        color: #adb5bd;
        /* Light gray for inactive tabs */
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 0.375rem 0.375rem 0 0;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        color: #fff;
        /* White on hover */
        background-color: rgba(255, 255, 255, 0.1);
        border-color: #444 #444 transparent;
    }

    .nav-tabs .nav-link.active {
        color: #fff;
        /* White for active tab text */
        background-color: #222;
        /* Dark background for active tab */
        border-color: #444 #444 #222;
        /* Border that blends with content area */
        font-weight: 500;
    }

    .nav-tabs .nav-link i {
        margin-right: 0.5rem;
        opacity: 0.8;
    }

    .nav-tabs .nav-link.active i {
        opacity: 1;
        color: #00bc8c;
        /* Accent color for active tab icon */
    }

    /* Sub-tabs (pills) for dictionary section */
    .nav-pills .nav-link {
        margin-right: 0.5rem;
        border-radius: 0.375rem;
        color: #adb5bd;
        background-color: transparent;
        border: 1px solid #444;
        transition: all 0.3s ease;
    }

    .nav-pills .nav-link:hover {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.1);
        border-color: #666;
    }

    .nav-pills .nav-link.active {
        color: #222;
        background-color: #00bc8c;
        /* Accent color for active pill */
        border-color: #00bc8c;
        font-weight: 500;
    }

    /* Tab content area */
    .tab-content {
        background-color: #222;
        border: 1px solid #444;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        padding: 1rem;
    }

    /* Card adjustments for dark theme */
    .card {
        background-color: #303030;
        border: 1px solid #444;
    }

    .card-header {
        background-color: #375a7f;
        border-bottom: 1px solid #444;
        color: #fff;
    }

    .card-header.bg-primary {
        background: linear-gradient(135deg, #375a7f 0%, #4e73df 100%) !important;
    }

    .card-header.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    }

    /* Form controls for dark theme */
    .form-control,
    .form-select {
        background-color: #222;
        border-color: #444;
        color: #fff;
    }

    .form-control:focus,
    .form-select:focus {
        background-color: #1a1a1a;
        border-color: #00bc8c;
        color: #fff;
        box-shadow: 0 0 0 0.2rem rgba(0, 188, 140, 0.25);
    }

    .form-control::placeholder {
        color: #6c757d;
    }

    .form-label {
        color: #adb5bd;
        font-weight: 500;
    }

    .form-text {
        color: #6c757d;
    }

    /* Alert adjustments */
    .alert-info {
        background-color: rgba(52, 152, 219, 0.2);
        border-color: #3498db;
        color: #74b9ff;
    }

    /* Light background cards within dark theme */
    .card.bg-light {
        background-color: rgba(255, 255, 255, 0.05) !important;
        border-color: #444;
    }

    .card.bg-light .card-body {
        color: #adb5bd;
    }

    /* Collapse animation */
    .collapse.show {
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Required field asterisk */
    .text-danger {
        color: #e74c3c !important;
    }

    /* Ensure good contrast for links */
    a {
        color: #00bc8c;
    }

    a:hover {
        color: #00d49a;
    }

    /* Drag and Drop Upload Zone */
    .upload-drop-zone {
        border: 2px dashed #6c757d;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(108, 117, 125, 0.05);
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .upload-drop-zone:hover {
        border-color: #00bc8c;
        background: rgba(0, 188, 140, 0.1);
        transform: translateY(-2px);
    }

    .upload-drop-zone.drag-over {
        border-color: #00bc8c;
        background: rgba(0, 188, 140, 0.2);
        border-style: solid;
    }

    .upload-drop-content {
        text-align: center;
    }

    .upload-icon {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 1rem;
        transition: color 0.3s ease;
    }

    .upload-drop-zone:hover .upload-icon {
        color: #00bc8c;
    }

    .upload-drop-zone.drag-over .upload-icon {
        color: #00bc8c;
        animation: bounce 0.5s ease-in-out;
    }

    @keyframes bounce {

        0%,
        20%,
        60%,
        100% {
            transform: translateY(0);
        }

        40% {
            transform: translateY(-10px);
        }

        80% {
            transform: translateY(-5px);
        }
    }

    .upload-formats {
        margin-top: 1rem;
        padding: 0.5rem;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 6px;
    }
</style>

<script>
    // Drag and Drop Functionality
    function dragOverHandler(ev) {
        ev.preventDefault();
    }

    function dragEnterHandler(ev) {
        ev.preventDefault();
        document.getElementById('dropZone').classList.add('drag-over');
    }

    function dragLeaveHandler(ev) {
        ev.preventDefault();
        if (!ev.currentTarget.contains(ev.relatedTarget)) {
            document.getElementById('dropZone').classList.remove('drag-over');
        }
    }

    function dropHandler(ev) {
        ev.preventDefault();
        document.getElementById('dropZone').classList.remove('drag-over');

        if (ev.dataTransfer.items) {
            // Use DataTransferItemList interface
            for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                if (ev.dataTransfer.items[i].kind === 'file') {
                    const file = ev.dataTransfer.items[i].getAsFile();
                    handleFileSelection(file);
                    break; // Only handle the first file
                }
            }
        } else {
            // Use DataTransfer interface
            for (let i = 0; i < ev.dataTransfer.files.length; i++) {
                handleFileSelection(ev.dataTransfer.files[i]);
                break; // Only handle the first file
            }
        }
    }

    // Handle file input change
    function fileSelected(input) {
        if (input.files && input.files[0]) {
            handleFileSelection(input.files[0]);
        }
    }

    // Common file handling
    function handleFileSelection(file) {
        const fileInput = document.getElementById('doc_file');
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        // Show file info
        displaySelectedFile(file);

        // Auto-populate title if empty
        const titleInput = document.getElementById('doc_title');
        if (!titleInput.value) {
            titleInput.value = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
        }
    }

    function displaySelectedFile(file) {
        const fileInfoDiv = document.getElementById('selectedFileInfo');

        if (fileInfoDiv) {
            // Create the content dynamically to avoid missing element issues
            fileInfoDiv.innerHTML = `
                <div class="alert alert-success mb-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-alt me-2"></i>
                        <div class="flex-grow-1">
                            <strong>${file.name}</strong>
                            <br><small class="text-muted">${formatFileSize(file.size)}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-auto" onclick="clearSelectedFile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            fileInfoDiv.style.display = 'block';
        } else {
            // Fallback: show simple alert
            alert(`File selected: ${file.name} (${formatFileSize(file.size)})`);
        }
    }

    function clearSelectedFile() {
        const fileInput = document.getElementById('doc_file');
        fileInput.value = '';
        document.getElementById('selectedFileInfo').style.display = 'none';
        document.getElementById('doc_title').value = '';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Make drop zone clickable and set up drag handlers
    document.addEventListener('DOMContentLoaded', function () {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('doc_file');

        if (dropZone && fileInput) {
            // Click handler
            dropZone.addEventListener('click', function () {
                fileInput.click();
            });

            // Drag and drop handlers
            dropZone.addEventListener('dragover', function (e) {
                e.preventDefault();
            });

            dropZone.addEventListener('dragenter', function (e) {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', function (e) {
                e.preventDefault();
                if (!e.currentTarget.contains(e.relatedTarget)) {
                    dropZone.classList.remove('drag-over');
                }
            });

            dropZone.addEventListener('drop', function (e) {
                e.preventDefault();
                dropZone.classList.remove('drag-over');

                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    handleFileSelection(files[0]);
                }
            });

            // File input change handler
            fileInput.addEventListener('change', function () {
                if (this.files && this.files[0]) {
                    handleFileSelection(this.files[0]);
                }
            });
        }
    });
</script>
{% endblock %}