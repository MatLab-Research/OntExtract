{% extends "base.html" %}

{% block title %}References - OntExtract{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1>Reference Documents</h1>
            <p class="text-muted">Manage canonical references for terminology and definitions</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('references.upload') }}" class="btn btn-primary">
                <i class="fas fa-upload"></i> Upload Reference
            </a>
            <a href="{{ url_for('references.new_oed_reference') }}" class="btn btn-primary ms-2">
                <i class="fas fa-book"></i> Add OED Reference
            </a>
        </div>
    </div>

    {% if references %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Source</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Used In</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reference in references %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('references.view', id=reference.id) }}" class="text-decoration-none">
                                            {% if reference.reference_type == 'oed_entry' or (reference.reference_subtype and 'oed' in reference.reference_subtype.lower()) %}
                                                <i class="fas fa-external-link-alt text-info me-2" title="OED Entry (External)"></i>
                                            {% elif (reference.original_filename and reference.original_filename.lower().endswith('.pdf')) or reference.file_type == 'pdf' %}
                                                <i class="fas fa-file-pdf text-danger me-2" title="PDF Reference"></i>
                                            {% elif reference.reference_subtype == 'academic' %}
                                                <i class="fas fa-graduation-cap text-success me-2" title="Academic Paper"></i>
                                            {% elif reference.reference_subtype == 'standard' %}
                                                <i class="fas fa-certificate text-warning me-2" title="Standard Document"></i>
                                            {% elif reference.reference_subtype == 'book' %}
                                                <i class="fas fa-book text-primary me-2" title="Book"></i>
                                            {% elif reference.reference_subtype == 'conference' %}
                                                <i class="fas fa-users text-info me-2" title="Conference Proceeding"></i>
                                            {% elif reference.reference_subtype == 'patent' %}
                                                <i class="fas fa-lightbulb text-warning me-2" title="Patent"></i>
                                            {% elif reference.reference_subtype == 'technical' %}
                                                <i class="fas fa-file-code text-secondary me-2" title="Technical Report"></i>
                                            {% elif reference.reference_subtype == 'whitepaper' %}
                                                <i class="fas fa-file-alt text-secondary me-2" title="White Paper"></i>
                                            {% elif reference.reference_subtype == 'website' %}
                                                <i class="fas fa-globe text-info me-2" title="Web Resource"></i>
                                            {% elif reference.reference_subtype == 'glossary' %}
                                                <i class="fas fa-list text-secondary me-2" title="Glossary"></i>
                                            {% elif reference.reference_subtype == 'encyclopedia' %}
                                                <i class="fas fa-book-open text-primary me-2" title="Encyclopedia Entry"></i>
                                            {% else %}
                                                <i class="fas fa-bookmark text-secondary me-2" title="Reference"></i>
                                            {% endif %}
                                            <strong>{{ reference.title }}</strong>
                                        </a>
                                        {% if reference.source_metadata and reference.source_metadata.get('doi') %}
                                        <br>
                                        <small class="text-muted">DOI: {{ reference.source_metadata.get('doi') }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ reference.get_reference_subtype_display() }}</span>
                                    </td>
                                    <td>
                                        {% if reference.get_source_info() %}
                                        <small>{{ reference.get_source_info() }}</small>
                                        {% elif reference.reference_subtype == 'dictionary_oed' %}
                                        <small>Oxford English Dictionary</small>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if reference.source_metadata and reference.source_metadata.get('publication_date') %}
                                        {{ reference.source_metadata.get('publication_date') }}
                                        {% elif reference.reference_subtype == 'dictionary_oed' and reference.created_at %}
                                        {{ reference.created_at.strftime('%Y-%m-%d') }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if reference.status == 'completed' %}
                                        <span class="badge bg-success">Processed</span>
                                        {% elif reference.status == 'processing' %}
                                        <span class="badge bg-info">Processing</span>
                                        {% elif reference.status == 'error' %}
                                        <span class="badge bg-danger">Error</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ reference.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set exp_count = reference.referenced_by_experiments.count() %}
                                        {% if exp_count > 0 %}
                                        <span class="badge bg-primary">{{ exp_count }} experiment{{ 's' if exp_count != 1 else '' }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('references.view', id=reference.id) }}" 
                                               class="btn btn-outline-primary" title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('references.edit', id=reference.id) }}" 
                                               class="btn btn-outline-secondary" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('references.delete', id=reference.id) }}" 
                                                  style="display: inline;"
                                                  onsubmit="return confirm('Are you sure you want to delete this reference?');">
                                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-book fa-3x text-muted mb-3"></i>
                    <h4>No References Yet</h4>
                    <p class="text-muted">Upload reference documents to define canonical terms and concepts.</p>
                    <div class="mt-3">
                        <a href="{{ url_for('references.upload') }}" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Upload Your First Reference
                        </a>
                        <a href="{{ url_for('references.new_oed_reference') }}" class="btn btn-primary ms-2">
                            <i class="fas fa-book"></i> Add OED Reference
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
