{% extends "base.html" %}

{% block title %}Entity Extraction Results - {{ document.title }}{% endblock %}

{% block extra_css %}
<style>
.entity-highlight {
    padding: 2px 4px;
    border-radius: 3px;
    margin: 0 2px;
    display: inline-block;
    color: #1f2937;
    font-weight: 500;
}
.entity-PERSON { background-color: #bfdbfe; border-bottom: 2px solid #3b82f6; }
.entity-ORG { background-color: #bbf7d0; border-bottom: 2px solid #16a34a; }
.entity-GPE { background-color: #fde68a; border-bottom: 2px solid #f59e0b; }
.entity-DATE { background-color: #fbcfe8; border-bottom: 2px solid #ec4899; }
.entity-LOC { background-color: #c7d2fe; border-bottom: 2px solid #6366f1; }
.entity-PRODUCT { background-color: #ddd6fe; border-bottom: 2px solid #8b5cf6; }
.entity-CARDINAL { background-color: #fed7aa; border-bottom: 2px solid #f97316; }
.entity-NORP { background-color: #a5f3fc; border-bottom: 2px solid #06b6d4; }
.entity-WORK_OF_ART { background-color: #fecdd3; border-bottom: 2px solid #f43f5e; }
.entity-LAW { background-color: #fcd34d; border-bottom: 2px solid #d97706; }
.entity-CONCEPT { background-color: #cbd5e1; border-bottom: 2px solid #64748b; }
.entity-MONEY { background-color: #d9f99d; border-bottom: 2px solid #84cc16; }
.entity-ORDINAL { background-color: #fecaca; border-bottom: 2px solid #dc2626; }
.entity-QUANTITY { background-color: #bae6fd; border-bottom: 2px solid #0284c7; }
.entity-TIME { background-color: #fde047; border-bottom: 2px solid #eab308; }
.entity-PERCENT { background-color: #c4b5fd; border-bottom: 2px solid #7c3aed; }
.entity-EVENT { background-color: #fdba74; border-bottom: 2px solid #ea580c; }
.entity-FAC { background-color: #d8b4fe; border-bottom: 2px solid #a855f7; }
.entity-LANGUAGE { background-color: #a7f3d0; border-bottom: 2px solid #10b981; }
.entity-UNKNOWN { background-color: #e5e7eb; border-bottom: 2px solid #6b7280; }

.entity-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}
.entity-legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
}
/* Entity type card styling */
.entity-type-card {
    border-width: 2px;
}
.entity-type-card .card-header {
    border-radius: 0;
}
.entity-type-PERSON { border-color: #3b82f6; }
.entity-type-ORG { border-color: #16a34a; }
.entity-type-GPE { border-color: #f59e0b; }
.entity-type-DATE { border-color: #ec4899; }
.entity-type-LOC { border-color: #6366f1; }
.entity-type-PRODUCT { border-color: #8b5cf6; }
.entity-type-CARDINAL { border-color: #f97316; }
.entity-type-NORP { border-color: #06b6d4; }
.entity-type-WORK_OF_ART { border-color: #f43f5e; }
.entity-type-LAW { border-color: #d97706; }
.entity-type-CONCEPT { border-color: #64748b; }
.entity-type-MONEY { border-color: #84cc16; }
.entity-type-ORDINAL { border-color: #dc2626; }
.entity-type-QUANTITY { border-color: #0284c7; }
.entity-type-TIME { border-color: #eab308; }
.entity-type-PERCENT { border-color: #7c3aed; }
.entity-type-EVENT { border-color: #ea580c; }
.entity-type-FAC { border-color: #a855f7; }
.entity-type-LANGUAGE { border-color: #10b981; }
.entity-type-UNKNOWN { border-color: #6b7280; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('text_input.document_list') }}">Documents</a></li>
                    <li class="breadcrumb-item">{{ document.title }}</li>
                    <li class="breadcrumb-item active">Entity Extraction Results</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h2><i class="fas fa-tags me-2 text-success"></i>Entity Extraction Results</h2>
                    <p class="text-muted">{{ document.title }}</p>
                </div>
                <div>
                    <a href="{{ url_for('provenance.timeline', document_uuid=document.uuid) }}"
                       class="btn btn-outline-secondary" target="_blank">
                        <i class="fas fa-history me-1"></i>View Provenance
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <!-- Statistics Card -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Entity Statistics</h5>
                        </div>
                        <div class="card-body">
                            {% if entities %}
                                <div class="row text-center mb-4">
                                    <div class="col-md-4">
                                        <div class="border rounded p-3">
                                            <h4 class="text-success mb-1">{{ total_entities }}</h4>
                                            <small class="text-muted">Total Entities</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="border rounded p-3">
                                            <h4 class="text-info mb-1">{{ entities_by_type|length }}</h4>
                                            <small class="text-muted">Entity Types</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="border rounded p-3">
                                            <h4 class="text-primary mb-1">spaCy NER</h4>
                                            <small class="text-muted">Method</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Entity Type Breakdown with Color-Coded Cards -->
                                <h6 class="mb-3">Entity Breakdown by Type</h6>
                                <div class="row">
                                    {% for entity_type, type_entities in entities_by_type.items() %}
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card h-100 entity-type-card entity-type-{{ entity_type }}">
                                            <div class="card-header entity-highlight entity-{{ entity_type }} py-2">
                                                <strong>{{ entity_type }}</strong>
                                                <span class="badge bg-dark float-end">{{ type_entities|length }}</span>
                                            </div>
                                            <div class="card-body" style="max-height: 150px; overflow-y: auto;">
                                                <div class="d-flex flex-wrap gap-1">
                                                    {% for entity in type_entities[:15] %}
                                                    <span class="badge bg-light text-dark border" title="{{ entity.text }}">
                                                        {{ entity.text[:20] }}{% if entity.text|length > 20 %}...{% endif %}
                                                    </span>
                                                    {% endfor %}
                                                    {% if type_entities|length > 15 %}
                                                    <span class="badge bg-secondary">+{{ type_entities|length - 15 }} more</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>No entities extracted yet.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Highlighted Text with Entities -->
                    {% if entities and document.content %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-highlighter me-2"></i>Text with Entity Highlights</h6>
                        </div>
                        <div class="card-body">
                            <!-- Entity Legend -->
                            <div class="entity-legend mb-3">
                                {% for entity_type in entities_by_type.keys() %}
                                <div class="entity-legend-item">
                                    <span class="entity-highlight entity-{{ entity_type }}">{{ entity_type }}</span>
                                    <small class="text-muted">({{ entities_by_type[entity_type]|length }})</small>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Highlighted Text -->
                            <div class="bg-light p-3 rounded" style="max-height: 500px; overflow-y: auto; line-height: 1.8;">
                                <div id="entity-visualization">
                                    {{ render_entities_html(displacy_data)|safe }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Entity List -->
                    {% if entities %}
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>All Extracted Entities</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Entity</th>
                                            <th>Type</th>
                                            <th>Position</th>
                                            <th>Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entity in entities[:50] %}
                                        <tr>
                                            <td><strong>{{ entity.text }}</strong></td>
                                            <td><span class="badge bg-secondary">{{ entity.entity_type }}</span></td>
                                            <td><small class="text-muted">{{ entity.start_position }}-{{ entity.end_position }}</small></td>
                                            <td>
                                                {% if entity.confidence %}
                                                <span class="badge {{ 'bg-success' if entity.confidence > 0.8 else 'bg-warning' }}">
                                                    {{ (entity.confidence * 100)|int }}%
                                                </span>
                                                {% else %}
                                                <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% if entities|length > 50 %}
                                <p class="text-muted text-center">Showing first 50 of {{ entities|length }} entities</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="col-lg-4">
                    <!-- Processing History -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-history me-2"></i>Processing History</h6>
                        </div>
                        <div class="card-body">
                            {% if jobs|length > 1 %}
                                <p class="small text-muted mb-3">
                                    Entities extracted {{ jobs|length }} times
                                </p>
                                <div class="list-group">
                                    {% for job in jobs %}
                                    <div class="list-group-item {{ 'active' if loop.first else '' }}">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">
                                                Run {{ loop.index }}
                                                {% if loop.first %}
                                                <span class="badge bg-primary ms-2">Latest</span>
                                                {% endif %}
                                            </h6>
                                            <small>{{ job.created_at.strftime('%m/%d %H:%M') if job.created_at else 'N/A' }}</small>
                                        </div>
                                        <p class="mb-1 small">
                                            {% set params = job.get_parameters() %}
                                            <span class="badge bg-secondary">{{ params.get('entity_types', [])|length }} types</span>
                                            <span class="badge {{ 'bg-success' if job.status == 'completed' else 'bg-warning' }} ms-1">
                                                {{ job.status }}
                                            </span>
                                        </p>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% elif jobs %}
                                <p class="text-muted">Single extraction run</p>
                            {% else %}
                                <p class="text-muted">No processing history</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('provenance.timeline', document_uuid=document.uuid) }}"
                                   class="btn btn-outline-primary" target="_blank">
                                    <i class="fas fa-stream me-1"></i>View Full Timeline
                                </a>
                                <button class="btn btn-outline-secondary" onclick="exportEntities()">
                                    <i class="fas fa-download me-1"></i>Export Entities (CSV)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function exportEntities() {
    // Build CSV content from entity data
    const entities = [
        {% for entity in entities %}
        {
            text: {{ entity.text|tojson }},
            type: {{ entity.entity_type|tojson }},
            start: {{ entity.start_position|tojson }},
            end: {{ entity.end_position|tojson }},
            confidence: {{ entity.confidence|tojson }}
        },
        {% endfor %}
    ];

    if (entities.length === 0) {
        alert('No entities to export');
        return;
    }

    // Create CSV header and rows
    const headers = ['Entity Text', 'Type', 'Start Position', 'End Position', 'Confidence'];
    const rows = entities.map(e => [
        `"${(e.text || '').replace(/"/g, '""')}"`,
        e.type || '',
        e.start !== null ? e.start : '',
        e.end !== null ? e.end : '',
        e.confidence !== null ? (e.confidence * 100).toFixed(1) + '%' : ''
    ]);

    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');

    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', '{{ document.title|replace(" ", "_") }}_entities.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}

{% macro render_entities_html(displacy_data) %}
    {% if displacy_data and displacy_data.text %}
        {% set text = displacy_data.text %}
        {% set ents = displacy_data.ents|sort(attribute='start') %}
        {% set offset = 0 %}
        {% for ent in ents %}
            {% if ent.start > offset %}
                {{ text[offset:ent.start] }}
            {% endif %}
            <span class="entity-highlight entity-{{ ent.label }}" title="{{ ent.label }}">
                {{ text[ent.start:ent.end] }}
            </span>
            {% set offset = ent.end %}
        {% endfor %}
        {% if offset < text|length %}
            {{ text[offset:] }}
        {% endif %}
    {% else %}
        <p class="text-muted">No entity visualization available</p>
    {% endif %}
{% endmacro %}
